<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grimoire ¬∑ Classement</title>

  <script>
    (function(){
      try{
        var saved = localStorage.getItem('grimoire.theme');
        if (saved === 'christmas') {
          document.documentElement.classList.add('christmas');
        }
      }catch(e){}
    })();
  </script>

  <link rel="stylesheet" href="/rarities.css">
  <link rel="stylesheet" href="/mobile.css">
  <link rel="stylesheet" href="/noel.css">

  <link rel="icon" type="image/png" href="https://i.goopics.net/07jxhq.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.goopics.net/aksxey.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://i.goopics.net/clovpw.png">
  <link rel="apple-touch-icon" href="https://i.goopics.net/cb7vh3.png">

  <style>
    :root{
      --bg:#0b0f1a; --panel:#10172a; --panel-2:#0c1222; --text:#e8ecf3; --muted:#9aa6be;
      --accent:#7c5cff; --accent-2:#b86bff; --copper:#d6a17a; --success:#34d399; --warning:#f59e0b;
      --radius:16px; --radius-lg:24px; --shadow:0 20px 60px rgba(0,0,0,.45); --shadow-sm:0 8px 24px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box; scrollbar-width:thin; scrollbar-color: rgba(124,92,255,.45) rgba(255,255,255,.04)}
    *::-webkit-scrollbar{ height:10px; width:10px }
    *::-webkit-scrollbar-track{ background: rgba(255,255,255,.04) }
    *::-webkit-scrollbar-thumb{ background: linear-gradient(180deg, rgba(124,92,255,.7), rgba(184,107,255,.6)); border-radius:999px; border:2px solid rgba(11,15,26,.6) }

    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(124,92,255,.18), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(184,107,255,.16), transparent 60%),
        radial-gradient(1000px 800px at 50% 120%, rgba(214,161,122,.10), transparent 60%),
        linear-gradient(180deg,#0b0f1a 0%,#0b0f1a 100%);
      min-height:100svh;
    }

    header{
      position:sticky; top:0; z-index:10; backdrop-filter:blur(10px);
      background:linear-gradient(180deg,rgba(11,15,26,.85),rgba(11,15,26,.55));
      border-bottom:1px solid rgba(255,255,255,.06)
    }
    .container{max-width:1100px;margin:0 auto;padding:22px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    nav a{
      color:var(--text);text-decoration:none;border:1px solid rgba(255,255,255,.12);
      padding:8px 12px;border-radius:12px; transition: all .2s ease;
    }
    nav a[aria-current="page"]{ background:rgba(255,255,255,.06) }
    nav a:hover{ background: rgba(255,255,255,.08); transform: translateY(-1px) }

    .brand{display:flex;align-items:center;gap:14px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:conic-gradient(from 0deg,var(--accent),var(--accent-2),var(--copper),var(--accent));
      box-shadow:var(--shadow-sm)
    }
    .title{font-size:22px;font-weight:900}
    .subtitle{font-size:12px;color:var(--muted)}

    .panel{
      background:linear-gradient(180deg,var(--panel),var(--panel-2));
      border:1px solid rgba(255,255,255,.06); border-radius:var(--radius-lg);
      box-shadow:var(--shadow); position:relative; overflow:clip
    }
    .panel .hd{
      display:flex;align-items:center;justify-content:space-between;
      padding:18px 20px;border-bottom:1px solid rgba(255,255,255,.06)
    }
    .panel .hd h3{margin:0; font-size:18px; letter-spacing:.3px; font-weight:900}
    .panel .bd{padding:20px}
    .panel::before{
      content:""; position:absolute; inset:0; border-radius:inherit; padding:1px;
      background: linear-gradient(140deg, rgba(124,92,255,.35), rgba(184,107,255,.2), rgba(214,161,122,.28));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; pointer-events:none;
    }

    .pill{
      font-size:13px;padding:6px 12px;border-radius:999px;
      background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);
      font-weight:600;
    }

    /* Hero section */
    .hero{
      text-align:center; padding:40px 20px 30px;
      background: radial-gradient(600px 400px at 50% 0%, rgba(124,92,255,.15), transparent);
    }
    .hero h1{
      font-size:clamp(32px, 5vw, 48px); font-weight:900; margin:0 0 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2), var(--copper));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .hero p{font-size:16px; color:var(--muted); margin:0}

    /* Podium */
    .podium{
      display:grid; grid-template-columns: repeat(3, 1fr); gap:16px;
      max-width:900px; margin:0 auto 30px;
    }
    .podium-card{
      background:linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius-lg); padding:24px;
      text-align:center; position:relative;
      box-shadow: var(--shadow-sm);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .podium-card:hover{ transform: translateY(-4px); box-shadow: var(--shadow) }
    .podium-card.first{ order:2; transform: scale(1.08) }
    .podium-card.second{ order:1 }
    .podium-card.third{ order:3 }
    
    .podium-medal{
      font-size:48px; line-height:1; margin-bottom:12px;
      filter: drop-shadow(0 4px 12px rgba(0,0,0,.3));
    }
    .podium-avatar{
      width:80px; height:80px; border-radius:50%;
      margin:0 auto 12px; border:3px solid rgba(255,255,255,.15);
      object-fit:cover; box-shadow: var(--shadow-sm);
    }
    .podium-name{ font-weight:900; font-size:18px; margin-bottom:6px }
    .podium-stats{ font-size:13px; color:var(--muted) }
    .podium-pct{
      font-size:28px; font-weight:900; margin-top:8px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Filters */
    .filters{
      display:flex; gap:12px; margin-bottom:20px; flex-wrap:wrap;
      align-items:center;
    }
    .search-box{
      flex:1; min-width:220px;
      background: var(--panel); color: var(--text);
      border:1px solid rgba(255,255,255,.12); border-radius: 12px;
      padding:12px 16px; font-size:15px;
      transition: border-color .2s ease;
    }
    .search-box:focus{
      outline:none; border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(124,92,255,.15);
    }
    .filter-btn{
      padding:10px 16px; border-radius:12px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
      color:var(--text); cursor:pointer; font-weight:600;
      transition: all .2s ease; font-size:14px;
    }
    .filter-btn:hover{ background:rgba(255,255,255,.10) }
    .filter-btn.active{
      background:var(--accent); border-color:var(--accent);
      box-shadow: 0 4px 12px rgba(124,92,255,.3);
    }

    /* Leaderboard list */
    .lb-list{
      list-style:none; margin:0; padding:0; display:grid; gap:10px;
    }
    .lb-item{
      display:grid; grid-template-columns: 50px 50px 1fr auto; gap:14px;
      align-items:center; padding:14px;
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border-radius: 14px; box-shadow: var(--shadow-sm);
      transition: all .2s ease;
    }
    .lb-item:hover{
      transform: translateX(4px);
      border-color: rgba(124,92,255,.3);
      box-shadow: 0 8px 24px rgba(124,92,255,.15);
    }
    
    .lb-rank{
      width:50px; height:50px; border-radius:12px; display:grid; place-items:center;
      font-weight:900; font-size:18px;
      background: radial-gradient(100% 100% at 50% 30%, rgba(214,161,122,.18), rgba(214,161,122,.08));
      border:1px solid rgba(214,161,122,.35);
    }
    .lb-rank.top3{ font-size:24px; border:none; background:transparent }
    
    .lb-ava{
      width:50px; height:50px; border-radius:12px;
      object-fit:cover; border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow-sm);
    }
    
    .lb-info{ flex:1; min-width:0 }
    .lb-name{ font-weight:800; font-size:16px; margin-bottom:4px }
    .lb-sub{ font-size:13px; color: var(--muted); margin-bottom:8px }
    .lb-bar{
      height:8px; background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px; overflow:hidden;
    }
    .lb-fill{
      height:100%; width:0%; transition: width .4s ease;
      background: linear-gradient(90deg, rgba(124,92,255,.8), rgba(184,107,255,.8));
      box-shadow: inset 0 0 12px rgba(124,92,255,.4);
    }
    
    .lb-pct{
      font-weight:900; font-size:22px;
      min-width:70px; text-align:right;
    }

    .loading{
      text-align:center; padding:60px 20px; color:var(--muted);
    }
    .loading-spinner{
      width:40px; height:40px; margin:0 auto 16px;
      border:4px solid rgba(255,255,255,.1);
      border-top-color:var(--accent); border-radius:50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    .empty-state{
      text-align:center; padding:60px 20px; color:var(--muted);
    }
    .empty-state-icon{ font-size:64px; margin-bottom:16px; opacity:.5 }

    @media (max-width: 768px){
      .podium{ grid-template-columns: 1fr; gap:12px }
      .podium-card.first{ order:1; transform:scale(1) }
      .podium-card.second{ order:2 }
      .podium-card.third{ order:3 }
      .lb-item{ grid-template-columns: 40px 40px 1fr 60px; gap:10px; padding:12px }
      .lb-rank{ width:40px; height:40px; font-size:16px }
      .lb-ava{ width:40px; height:40px }
      .lb-name{ font-size:14px }
      .lb-pct{ font-size:18px; min-width:60px }
      .hero h1{ font-size:28px }
    }
  </style>
</head>
<body>
  <header>
    <div class="container row" style="justify-content:space-between">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Grimoire</div>
          <div class="subtitle">Classement</div>
        </div>
      </div>
      <nav class="row" style="gap:10px">
        <a href="/index.html">Jeu</a>
        <a href="/collection.html">Collection</a>
        <a href="/profil.html">Profil</a>
        <a href="/leaderboard.html" aria-current="page">Classement</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="hero">
      <h1>üèÜ Classement des Collectionneurs</h1>
      <p>Les meilleurs collectionneurs de cartes Grimoire</p>
    </div>

    <div class="container">
      <!-- Podium Top 3 -->
      <div id="podium" class="podium"></div>

      <!-- Reste du classement -->
      <section class="panel">
        <div class="hd">
          <h3>Classement Complet</h3>
          <span class="pill" id="lb-count">‚Äî</span>
        </div>
        <div class="bd">
          <div class="filters">
            <input
              id="lb-search"
              class="search-box"
              type="search"
              placeholder="üîç Rechercher un joueur..."
              aria-label="Rechercher un joueur"
            />
            <button class="filter-btn active" data-limit="50">Top 50</button>
            <button class="filter-btn" data-limit="100">Top 100</button>
            <button class="filter-btn" data-limit="all">Tous</button>
          </div>

          <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Chargement du classement...</p>
          </div>

          <ol id="lb-list" class="lb-list" aria-live="polite"></ol>
        </div>
      </section>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, query, orderBy, limit, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyCKZK4I3li_7wkmd_qiiM44BoqRTZoloeI',
      authDomain: 'legends-collection.firebaseapp.com',
      projectId: 'legends-collection',
      storageBucket: 'legends-collection.firebasestorage.app',
      messagingSenderId: '133783086150',
      appId: '1:133783086150:web:762f209f7f778ef83a1647'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const podiumEl = document.getElementById('podium');
    const lbList = document.getElementById('lb-list');
    const lbCount = document.getElementById('lb-count');
    const lbSearch = document.getElementById('lb-search');
    const loadingEl = document.getElementById('loading');
    const filterBtns = document.querySelectorAll('.filter-btn');

    let LB_ALL = [];
    let LB_LIMIT = 50;
    let unsubLB = null;
    let currentUser = null;

    // === CONFIG STATS ===
// Mets ici le nombre total de cartes uniques possibles dans Grimoire
const TOTAL_UNIQUE_CARDS = 231;

// Normalise un joueur : corrige les valeurs nulles / incoh√©rentes
function normalizePlayer(row) {
  const displayName = (row.displayName || 'Joueur').trim() || 'Joueur';
  const displayNameLower = (row.displayNameLower || displayName.toLowerCase());

  // Nombre de cartes uniques poss√©d√©es
  let uniques = Number(row.uniques);
  if (!Number.isFinite(uniques) || uniques < 0) {
    uniques = 0;
  }

  // Nombre total de cartes uniques possibles pour le calcul
  let totalUnique = Number(row.totalUnique);
  if (!Number.isFinite(totalUnique) || totalUnique <= 0) {
    totalUnique = TOTAL_UNIQUE_CARDS;
  }

  // Si jamais uniques > totalUnique (vieilles donn√©es, bug), on corrige
  if (uniques > totalUnique) {
    uniques = totalUnique;
  }

  // Recalcul propre du pourcentage de compl√©tion
  const rawPct = totalUnique > 0 ? (uniques / totalUnique) * 100 : 0;
  const completionPct = Math.round(rawPct * 10) / 10; // 1 d√©cimale

  return {
    ...row,
    displayName,
    displayNameLower,
    uniques,
    totalUnique,
    completionPct
  };
}


    // Auth state
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
    });

    // Medals
    function medal(i) {
      if (i === 1) return 'ü•á';
      if (i === 2) return 'ü•à';
      if (i === 3) return 'ü•â';
      return `#${i}`;
    }

    // Render podium (top 3)
    function renderPodium(top3) {
      if (!podiumEl) return;
      podiumEl.innerHTML = '';

      if (top3.length === 0) return;

      const classes = ['second', 'first', 'third'];
      const medals = ['ü•à', 'ü•á', 'ü•â'];

      top3.forEach((user, i) => {
        const pct = user.completionPct;
const pctLabel = (Math.round(pct * 10) / 10).toString().replace('.0', '');
        const avatarUrl = user.photoURL || `https://api.dicebear.com/9.x/shapes/svg?seed=${encodeURIComponent(user.displayName)}`;

        const card = document.createElement('div');
        card.className = `podium-card ${classes[i]}`;
        card.innerHTML = `
          <div class="podium-medal">${medals[i]}</div>
          <img class="podium-avatar" src="${avatarUrl}" alt="${user.displayName}" onerror="this.src='https://api.dicebear.com/9.x/shapes/svg?seed=default'">
          <div class="podium-name">${user.displayName}</div>
          <div class="podium-stats">${user.uniques || 0} / ${user.totalUnique || 0} cartes</div>
          <div class="podium-pct">${pctLabel}%</div>
        `;
        podiumEl.appendChild(card);
      });
    }

    // Render full list (starting from 4th place)
    // Render full list (√† partir de startRank)
function renderLB(rows, startRank = 1) {
  if (!lbList) return;

  loadingEl.style.display = 'none';
  lbList.innerHTML = '';

  if (rows.length === 0) {
    lbList.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üîç</div>
        <p>Aucun joueur trouv√©</p>
      </div>
    `;
    return;
  }

  rows.forEach((user, i) => {
    const rank = startRank + i; // ‚úÖ rang r√©el (4, 5, 6, ...)
    const pct = user.completionPct;
    const pctLabel = (Math.round(pct * 10) / 10).toString().replace('.0', '');
    const avatarUrl = user.photoURL || `https://api.dicebear.com/9.x/shapes/svg?seed=${encodeURIComponent(user.displayName)}`;
    const isCurrentUser = currentUser && user.uid === currentUser.uid;

    const li = document.createElement('li');
    li.className = 'lb-item';
    if (isCurrentUser) li.style.background = 'linear-gradient(180deg, rgba(124,92,255,.15), rgba(124,92,255,.08))';

    li.innerHTML = `
      <div class="lb-rank">${medal(rank)}</div>
      <img class="lb-ava" src="${avatarUrl}" alt="${user.displayName}" onerror="this.src='https://api.dicebear.com/9.x/shapes/svg?seed=default'">
      <div class="lb-info">
        <div class="lb-name">${user.displayName}${isCurrentUser ? ' (Vous)' : ''}</div>
        <div class="lb-sub">${user.uniques} / ${user.totalUnique} cartes</div>
        <div class="lb-bar"><div class="lb-fill" style="width:${pct}%;"></div></div>
      </div>
      <div class="lb-pct">${pctLabel}%</div>
    `;
    lbList.appendChild(li);
  });
}


    // Filter list
   function filterLB() {
  const q = (lbSearch?.value || '').trim().toLowerCase();
  let filtered = LB_ALL;

  if (q) {
    filtered = LB_ALL.filter(u => {
      const name = u.displayNameLower;
      return name.includes(q);
    });
  }

  // Applique la limite
  if (LB_LIMIT !== 'all') {
    filtered = filtered.slice(0, LB_LIMIT);
  }

  // Met √† jour le nombre total de joueurs affich√©s (top 3 + le reste)
  lbCount.textContent = String(filtered.length);

  // Top 3 pour le podium
  const top3 = filtered.slice(0, 3);
  renderPodium(top3);

  // Reste pour la liste √† partir de la 4e place
  const rest = filtered.slice(3);
  renderLB(rest, 4); // ‚¨ÖÔ∏è on commence les rangs √† 4
}


    // Load leaderboard
    async function loadLeaderboard() {
      const q = query(
        collection(db, 'leaderboard_public'),
        orderBy('completionPct', 'desc'),
        limit(200)
      );

      if (unsubLB) unsubLB();

      unsubLB = onSnapshot(
        q,
        (snapshot) => {
          console.log('[Leaderboard] Donn√©es re√ßues:', snapshot.size, 'joueurs');

          const rows = [];
          snapshot.forEach(doc => {
  const data = doc.data();
  rows.push({
    uid: doc.id,
    displayName: data.displayName || 'Joueur',
    displayNameLower: (data.displayNameLower || data.displayName || '').toLowerCase(),
    photoURL: data.photoURL || '',
    uniques: data.uniques,
    totalUnique: data.totalUnique,
    completionPct: data.completionPct
  });
});

// Normalisation des joueurs (corrige uniques / totalUnique / %)
const normalized = rows.map(normalizePlayer);

// Tri manuel c√¥t√© client apr√®s normalisation
normalized.sort((a, b) => {
  if (b.completionPct !== a.completionPct) return b.completionPct - a.completionPct;
  if (b.uniques !== a.uniques) return b.uniques - a.uniques;
  return a.displayNameLower.localeCompare(b.displayNameLower);
});

LB_ALL = normalized;
filterLB();

        },
        (error) => {
          console.error('[Leaderboard] Erreur:', error);
          loadingEl.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">‚ö†Ô∏è</div>
              <p>Impossible de charger le classement</p>
            </div>
          `;
        }
      );
    }

    // Search input
    lbSearch?.addEventListener('input', filterLB);

    // Filter buttons
    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        filterBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const limitVal = btn.dataset.limit;
        LB_LIMIT = limitVal === 'all' ? 'all' : Number(limitVal);
        filterLB();
      });
    });

    // Init
    loadLeaderboard();

    // Cleanup
    window.addEventListener('beforeunload', () => {
      if (unsubLB) unsubLB();
    });
  </script>
</body>
</html>
