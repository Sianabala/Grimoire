<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grimoire</title>
  <link rel="icon" type="image/png" href="https://i.goopics.net/07jxhq.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.goopics.net/aksxey.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://i.goopics.net/clovpw.png">
<link rel="apple-touch-icon" href="https://i.goopics.net/cb7vh3.png">

  <link rel="prefetch" href="/collection.html" as="document">
  <!-- Harmonisation des raret√©s -->
  <link rel="stylesheet" href="/rarities.css">
  <link rel="stylesheet" href="/mobile.css">
  <style>
    :root{
      --bg:#0b0f1a; --panel:#10172a; --panel-2:#0c1222; --text:#e8ecf3; --muted:#9aa6be;
      --accent:#7c5cff; --accent-2:#b86bff; --copper:#d6a17a; --success:#34d399; --warning:#f59e0b; --danger:#ef4444;
      --ring:0 0 0 1px rgba(255,255,255,.06) inset, 0 10px 30px rgba(0,0,0,.35);
      --radius:16px; --radius-lg:24px; --shadow:0 20px 60px rgba(0,0,0,.45); --shadow-sm:0 8px 24px rgba(0,0,0,.25);
      --card-w: 220px;
    }

    *{box-sizing:border-box; scrollbar-width:thin; scrollbar-color: rgba(124,92,255,.45) rgba(255,255,255,.04)}
    *::-webkit-scrollbar{ height:10px; width:10px }
    *::-webkit-scrollbar-track{ background: rgba(255,255,255,.04) }
    *::-webkit-scrollbar-thumb{ background: linear-gradient(180deg, rgba(124,92,255,.7), rgba(184,107,255,.6)); border-radius:999px; border:2px solid rgba(11,15,26,.6) }

    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(124,92,255,.18), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(184,107,255,.16), transparent 60%),
        radial-gradient(1000px 800px at 50% 120%, rgba(214,161,122,.10), transparent 60%),
        linear-gradient(180deg,#0b0f1a 0%,#0b0f1a 100%);
      min-height:100svh;
    }

    /* Aura d√©corative */
    .aura{position:fixed; inset:0; pointer-events:none; mix-blend:screen; opacity:.55}
    .aura::before, .aura::after{
      content:""; position:absolute; border-radius:999px; filter: blur(60px);
      background: radial-gradient(closest-side, rgba(124,92,255,.35), transparent 60%);
      width:520px; height:520px; left:-160px; top:-160px;
    }
    .aura::after{background: radial-gradient(closest-side, rgba(184,107,255,.28), transparent 60%); width:560px; height:560px; right:-180px; left:auto; top:20vh}

    .hero-header { position: relative; background: linear-gradient(180deg, rgba(11,15,26,.95), rgba(11,15,26,.65)); padding: 60px 0 40px; text-align: center; border-bottom: 1px solid rgba(255,255,255,.08); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .hero-center { display: flex; flex-direction: column; align-items: center; gap: 12px; opacity: 0; transform: translateY(20px); animation: fadeInUp 1.2s ease forwards; animation-delay: 0.3s; }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    .hero-logo { width: 72px; height: 72px; border-radius: 20px; background: conic-gradient(from 0deg, var(--accent), var(--accent-2), var(--copper), var(--accent)); box-shadow: 0 0 30px rgba(124,92,255,.3), inset 0 0 14px rgba(255,255,255,.1); animation: rotateGlow 6s linear infinite; }
    @keyframes rotateGlow { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .hero-title { font-size: 42px; font-weight: 900; letter-spacing: .5px; color: var(--text); text-shadow: 0 2px 10px rgba(124,92,255,.2); }
    .hero-subtitle { font-size: 16px; color: var(--muted); max-width: 480px; }
    .hero-actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 14px; justify-content: center; }

    .container{max-width:1200px;margin:0 auto;padding:22px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:20px}
    @media (max-width: 960px){ .grid{ grid-template-columns: repeat(6, 1fr) } }
    @media (max-width: 640px){ .grid{ grid-template-columns: repeat(4, 1fr) } }

    .panel{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius-lg);box-shadow:var(--shadow); position:relative; overflow:clip; will-change:transform}
    .panel .hd{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid rgba(255,255,255,.06)}
    .panel .hd h3{margin:0; font-size:16px; letter-spacing:.2px}
    .panel .bd{padding:18px 20px}
    .panel::before{content:""; position:absolute; inset:0; border-radius:inherit; padding:1px;
      background: linear-gradient(140deg, rgba(124,92,255,.35), rgba(184,107,255,.2), rgba(214,161,122,.28));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; pointer-events:none; }
    .panel:hover{ box-shadow: 0 18px 50px rgba(124,92,255,.12); transform: translateY(-2px); transition: transform .25s ease, box-shadow .25s ease }

    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px}
    .stat{background: linear-gradient(180deg,#0f172a,#0b1120); border-radius:16px;padding:12px; box-shadow: var(--ring)}
    .stat .v{font-size:28px;font-weight:900; letter-spacing:.2px }
    .stat .k{font-size:12px;color:var(--muted); opacity:.9 }

    .btn{appearance:none;border:1px solid transparent;outline:0;padding:10px 14px;border-radius:14px;font-weight:800;color:#0b0f1a;background:var(--accent);cursor:pointer;box-shadow:var(--shadow-sm);
      transition: transform .08s ease, box-shadow .15s ease, background .2s ease, border-color .2s ease, color .2s ease}
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 12px 28px rgba(124,92,255,.28)}
    .btn:active{ transform: translateY(0) }
    .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.16)}
    .btn.ghost:hover{ border-color: rgba(255,255,255,.28); background: rgba(255,255,255,.06) }
    .btn.pill{ border-radius:999px }

/* --- Rewards button states --- */
.btn[disabled]{
  opacity:.55; cursor:not-allowed; filter:grayscale(.1);
  box-shadow:none; transform:none !important;
}

/* Glow/pulse quand une r√©compense est dispo */
@keyframes pulseGlow {
  0%   { box-shadow: 0 0 0 rgba(124,92,255,0.0), var(--shadow-sm); transform: translateY(-1px); }
  50%  { box-shadow: 0 0 22px rgba(124,92,255,0.35), var(--shadow-sm); transform: translateY(-2px); }
  100% { box-shadow: 0 0 0 rgba(124,92,255,0.0), var(--shadow-sm); transform: translateY(-1px); }
}
.pulse-glow{
  animation: pulseGlow 1.8s ease-in-out infinite;
}

    .subtitle{font-size:12px;color:var(--muted)}
    .badge{font-size:12px;color:#0b0f1a;background:var(--copper);padding:4px 8px;border-radius:999px;font-weight:800; box-shadow: 0 4px 14px rgba(214,161,122,.25)}

    /* Sets (visuels XL) */
.sets{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
  gap:18px;
}
.set{
  position:relative;
  display:flex;
  flex-direction:column;
  gap:12px;
  background:linear-gradient(180deg,#0f1324,#0a0f1e);
  border:1px solid rgba(255,255,255,.10);
  border-radius:20px;
  padding:14px;
  box-shadow: var(--ring);
  overflow:hidden;
  transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
}
.set:hover{
  transform: translateY(-6px) scale(1.01);
  border-color: rgba(124,92,255,.35);
  box-shadow: 0 18px 60px rgba(124,92,255,.25);
}

/* Cover plein cadre + overlay */
.set .cover{
  position:relative;
  height: 340px;
  border-radius:16px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.10);
  background: #0b0f1a; /* couleur de fond si bandes */
  display:flex; align-items:center; justify-content:center;
}

.set .cover img{
  max-width:100%;
  max-height:100%;
  object-fit: contain;
  border-radius:12px;
  transition: transform .3s ease;
}
.set:hover .cover img{
  transform: scale(1.04);
}

.set .cover::before{           /* vignette/contraste */
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(100% 60% at 50% 10%, rgba(0,0,0,.05), transparent 40%),
              linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.55));
  pointer-events:none;
}
.set .cover::after{            /* gloss l√©ger */
  content:"";
  position:absolute; inset:-20%;
  background: radial-gradient(600px 400px at var(--mx,50%) var(--my,50%), rgba(255,255,255,.18), transparent 40%);
  mix-blend-mode:screen; opacity:.55; pointer-events:none;
}
.set:hover .cover::after{ opacity:.75 }

/* Titre + bouton en overlay bas */
.set .overlay{
  position:absolute; left:12px; right:12px; bottom:12px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:10px 12px;
  border-radius:12px;
  background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.65));
  backdrop-filter: blur(4px);
  border:1px solid rgba(255,255,255,.10);
}
.set .name{ font-size:18px; font-weight:900 }
.set .meta{ font-size:12px; color:var(--muted) }

.set .stats-row{
  display:flex; justify-content:space-between; align-items:center; gap:10px;
}

@media (max-width: 640px){
  .set .cover{ height: 260px; }
}

/* Focus clavier sur la carte enti√®re */
.set:focus-within, .set:focus-visible{
  outline:2px solid var(--accent); outline-offset:2px;
  border-radius: 16px;
}

    /* R√©sultats */
    .results{display:grid;grid-template-columns:repeat(auto-fill,minmax(var(--card-w),1fr));gap:12px}
    .card{width:var(--card-w);aspect-ratio:2/3;border-radius:20px;background:linear-gradient(180deg,#141b33,#0b0f1a);border:1px solid rgba(255,255,255,.10);box-shadow:var(--shadow-sm);position:relative;overflow:hidden; outline: 1px solid rgba(255,255,255,.06);
      transition: transform .18s ease, box-shadow .18s ease, outline-color .2s ease }
    .card:hover{ transform: translateY(-2px) }
    .card .shine{ position:absolute; inset:0; background: radial-gradient(1000px 1000px at var(--mx,50%) var(--my,50%), rgba(255,255,255,.12), transparent 40%); mix-blend: overlay; pointer-events:none }
    .card .img{position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.06),transparent 30%),url('https://images.unsplash.com/photo-1542751371-adc38448a05e?q=80&w=1200&auto=format&fit=crop') center/cover no-repeat;opacity:.7;mix-blend:screen}
    .card .footer{position:absolute;left:0;right:0;bottom:0;padding:10px 12px;background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.75))}
    .card .footer .name{ font-weight:800; text-shadow: 0 1px 0 rgba(0,0,0,.35) }

    /* Tags */
    .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05)}
    .tag .dot{ width:8px;height:8px;border-radius:999px;background:currentColor;opacity:.9 }

    .banner{margin:12px 0;padding:12px;border-radius:14px;background:linear-gradient(90deg,rgba(234,179,8,.15),rgba(124,92,255,.15));border:1px solid rgba(234,179,8,.35); display:flex; align-items:center; gap:10px; backdrop-filter: blur(6px)}

    /* --- NEW: Banni√®re "nouvelle carte" --- */
.banner.new-card{
  background: linear-gradient(90deg, rgba(124,92,255,.25), rgba(234,179,8,.25));
  border-color: rgba(234,179,8,.45);
  animation: newCardIn .6s ease, newCardOut .6s ease 4.5s forwards;
  gap: 8px;
}
.banner.new-card strong{
  font-weight: 900;
}
@keyframes newCardIn{
  from{ transform: translateY(12px); opacity: 0; }
  to  { transform: translateY(0);    opacity: 1; }
}
@keyframes newCardOut{
  to{ opacity: 0; transform: translateY(-8px); }
}

    
    pre.diag{white-space:pre-wrap;background:#0e1423;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;max-height:260px;overflow:auto;color:#9aa6be;font-family:ui-monospace,Menlo,Consolas,monospace; box-shadow: var(--ring)}

    /* Toast */
    .toast{ position: fixed; left: 50%; bottom: 22px; transform: translateX(-50%);
      background: rgba(18,24,41,.92); color: var(--text); border:1px solid rgba(255,255,255,.12);
      padding:10px 14px; border-radius:12px; box-shadow: var(--shadow-sm); z-index: 50;
      opacity:0; transition: opacity .2s ease, transform .2s ease }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px) }
   
    /* Progress */
    .xpbar{height:12px;border-radius:999px;background:#0e1423;border:1px solid rgba(255,255,255,.08);overflow:hidden}
    .xpbar .fill{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));box-shadow: 0 0 18px rgba(124,92,255,.35) inset; transition:width .25s ease}

    /* Accessibility */
    .btn:focus-visible, a:focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; border-radius:10px }
    @media (prefers-reduced-motion: no-preference){ .tag .dot{ animation: pulse 1.6s ease-in-out infinite }
      @keyframes pulse{ 0%,100%{ transform:scale(1); opacity:.8 } 50%{ transform:scale(1.15); opacity:1 } }
    }

    /* --- Pack Opening Overlay --- */
    #pack-overlay[hidden]{ display:none !important }
    #pack-overlay{ position:fixed; inset:0; z-index:60 }
    #pack-overlay .po-backdrop{
      position:absolute; inset:0;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(124,92,255,.20), transparent 60%),
                  radial-gradient(900px 500px at 110% 10%, rgba(184,107,255,.18), transparent 60%),
                  radial-gradient(1000px 800px at 50% 120%, rgba(214,161,122,.10), transparent 60%),
                  rgba(6,8,15,.85);
      backdrop-filter: blur(6px);
    }
    .po-stage{ position:absolute; inset:0; display:grid; place-items:center; padding:20px }
    .po-actions{ position:absolute; bottom:18px; left:50%; transform:translateX(-50%); }

    .po-pack{ width:240px; height:360px; perspective:1000px; position:relative; filter: drop-shadow(0 30px 50px rgba(0,0,0,.65)); animation: poFloat 2.8s ease-in-out infinite; }
    .po-pack-body{ position:absolute; inset:0; border-radius:18px; background:
      radial-gradient(120px 60px at 20% 20%, rgba(124,92,255,.35), transparent 60%),
      radial-gradient(100px 50px at 80% 25%, rgba(184,107,255,.30), transparent 60%),
      linear-gradient(180deg,#0f1324,#0a0f1e); border:1px solid rgba(255,255,255,.10); box-shadow: 0 12px 40px rgba(0,0,0,.45) inset, 0 2px 0 rgba(255,255,255,.06) inset; transform: rotateY(-8deg) rotateX(6deg); }
    .po-pack-gloss{ position:absolute; inset:0; border-radius:inherit; background: linear-gradient(120deg, rgba(255,255,255,.32), rgba(255,255,255,0) 30%, rgba(255,255,255,.18) 60%, transparent 70%); mix-blend-mode: overlay; opacity:.25; }
    .po-pack-logo{ position:absolute; left:0; right:0; bottom:26px; text-align:center; letter-spacing:.4em; font-weight:900; font-size:14px; color:#e8ecf3; opacity:.8; }
    .po-pack-shine{ position:absolute; inset:-10%; border-radius:22px; pointer-events:none; background: radial-gradient(400px 400px at var(--mx,50%) var(--my,50%), rgba(255,255,255,.20), transparent 40%); mix-blend-mode: screen; }
    .po-pack:hover .po-pack-body{ transform: rotateY(-5deg) rotateX(4deg); transition: transform .25s ease }
    @keyframes poFloat{ 0%,100%{ transform: translateY(-6px) } 50%{ transform: translateY(6px) } }
    @keyframes poShake{ 10%, 90%{ transform: translateX(-1px) } 20%, 80%{ transform: translateX(2px) } 30%, 50%, 70%{ transform: translateX(-4px) } 40%, 60%{ transform: translateX(4px) } }

    .po-slit{ position:absolute; width:2px; height:0; background: linear-gradient(180deg,#fff,rgba(255,255,255,.2)); box-shadow: 0 0 24px rgba(255,255,255,.7), 0 0 80px rgba(124,92,255,.45); border-radius:999px; opacity:0; pointer-events:none; }
    .po-fan{ position:relative; width:min(900px,90vw); height:420px; display:flex; align-items:flex-end; justify-content:center; gap:12px; transform: translateY(10px); opacity:0; }
    .po-card{ width: var(--card-w,220px); aspect-ratio:2/3; border-radius:20px; position:relative; overflow:hidden; background: linear-gradient(180deg,#141b33,#0b0f1a); border:1px solid rgba(255,255,255,.08); transform-origin: bottom center; transform: translateY(40px) scale(.9) rotate(var(--rot,0deg)); opacity:0; will-change: transform, opacity, box-shadow; box-shadow: 0 12px 34px rgba(0,0,0,.45); cursor:pointer }
    .po-card .img{ position:absolute; inset:0; background: linear-gradient(180deg,rgba(255,255,255,.06),transparent 30%) , var(--bg) center/cover no-repeat; mix-blend:screen; opacity:.85 }
    .po-card .shine{ position:absolute; inset:0; background: radial-gradient(900px 900px at var(--mx,50%) var(--my,50%), rgba(255,255,255,.14), transparent 40%); mix-blend:overlay; pointer-events:none }
    .po-card .tagbar{ position:absolute; left:0; right:0; bottom:0; padding:10px 12px; background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.75)); font-weight:800 }
    .po-card.revealed{ transform: translateY(0) scale(1) rotate(var(--rot,0deg)); opacity:1; transition: transform .35s ease, opacity .35s ease, box-shadow .35s ease }
    .po-card[aria-pressed="true"]{ cursor: default; }
    .po-card:focus-visible{ outline: 2px solid var(--accent); outline-offset: 4px; border-radius: 14px; }
    .po-card .veil{ position:absolute; inset:0; display:grid; place-items:center; background:
      radial-gradient(120px 80px at 30% 20%, rgba(124,92,255,.18), transparent 60%),
      linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.75)); color:#e8ecf3; font-weight:900; letter-spacing:.02em; text-transform:uppercase; border-radius:20px; }
    .po-card[aria-pressed="true"] .veil{ display:none; }
                                       
/* Art du pack pendant l'animation */
.po-pack-art{
  position:absolute; inset:10px;
  border-radius:14px;
  background: #0b0f1a center/contain no-repeat; /* l'image arrive en JS */
  border:1px solid rgba(255,255,255,.10);
  box-shadow: inset 0 0 30px rgba(0,0,0,.35);
  pointer-events:none;
}

    
    /* --- Choix niveau de pack (modal) --- */
    #pack-chooser[hidden]{ display:none }
    #pack-chooser{ position:fixed; inset:0; z-index:70; display:grid; place-items:center }
    #pack-chooser .backdrop{ position:absolute; inset:0; background: rgba(4,6,12,.72); backdrop-filter: blur(4px) }
    #pack-chooser .modal{ position:relative; width:min(420px,92vw); border-radius:18px; background: linear-gradient(180deg,#0f172a,#0b1120); border:1px solid rgba(255,255,255,.08); box-shadow: var(--shadow); padding:18px }
    #pack-chooser h4{ margin:0 0 6px; font-size:18px }
    #pack-chooser .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }

    @media (max-width: 640px){
  .container{ padding:12px; }
  .row{ gap:10px; }
  .title{ font-size:18px; }
  .btn{ padding:12px 16px; font-size:14px; }
  .input{ padding:10px 12px; font-size:14px; }
}

/* ---------- HERO invit√© ---------- */
.hero-guest{
  position: relative;
  min-height: clamp(380px, 60vh, 720px);
  display: grid;
  place-items: center;
  border-radius: 20px;        /* adapte si tu as une var de radius */
  overflow: hidden;
  margin-bottom: 24px;
  isolation: isolate;
}
.hero-bg{
  position: absolute;
  inset: 0;
  background-image: var(--hero-img), radial-gradient(1200px 600px at 75% 25%, rgba(255,255,255,0.08), transparent 40%), linear-gradient(180deg, #0a0c12 0%, #0a0c12 100%);
  background-size: cover, auto, 100% 100%;
  background-position: center, center, center;
  filter: saturate(1.05) contrast(1.05);
  transform: scale(1.02);
}
.hero-overlay{
  position: absolute;
  inset: 0;
  background:
    radial-gradient(1200px 600px at 30% 20%, rgba(0,0,0,0.35), transparent 50%),
    linear-gradient(180deg, rgba(10,12,18,0.65) 0%, rgba(10,12,18,0.85) 100%);
  backdrop-filter: blur(1px);
}
.hero-content{
  position: relative; /* au-dessus des overlays */
  text-align: center;
  padding: clamp(16px, 4vw, 40px);
  color: #fff;
}
.hero-content h1{
  font-size: clamp(28px, 6vw, 56px);
  line-height: 1.05;
  margin: 0 0 10px;
  letter-spacing: .2px;
}
.hero-content .subtitle{
  font-size: clamp(14px, 2.1vw, 20px);
  opacity: .92;
  margin: 0 0 18px;
}
.hero-actions{
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: center;
  flex-wrap: wrap;
}
.btn-hero{
  font-size: clamp(14px, 2.2vw, 18px);
  padding: 14px 22px;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
  transform: translateZ(0);
  transition: transform .2s ease, box-shadow .2s ease, opacity .2s ease;
}
.btn-hero:hover{
  transform: translateY(-2px);
  box-shadow: 0 16px 40px rgba(0,0,0,.3);
}
.link-ghost{
  color: #fff;
  text-decoration: none;
  border-bottom: 1px dashed rgba(255,255,255,.7);
  opacity: .9;
  padding-bottom: 2px;
}
.link-ghost:hover{ opacity: 1; }

/* Accessibilit√© / motion */
@media (prefers-reduced-motion: reduce){
  .btn-hero{ transition: none; }
  .btn-hero:hover{ transform:none; box-shadow:none; }
}

/* √âtats d'auth visuels, robustes m√™me sans JS */
body.guest #panel-stats,
body.guest #panel-sets,
body.guest #panel-results { display: none !important; }

body.guest #guest-cta { display: block !important; }

body.logged-in #guest-cta { display: none !important; }


/* Par d√©faut, on ne montre pas les CTA du header pour √©viter le flash au chargement */
.hero-header .hero-actions{ display:none; }

/* Quand l‚Äôutilisateur est connect√©, on les affiche */
body.logged-in .hero-header .hero-actions{ 
  display:flex; 
}

  
/* --- Topbar sticky --- */
.site-header{
  position: sticky; top: 0; z-index: 120;
  background: linear-gradient(180deg, rgba(11,15,26,.85), rgba(11,15,26,.70));
  backdrop-filter: blur(6px);
  border-bottom: 1px solid rgba(255,255,255,.08);
}
.site-header-row{
  display:flex; align-items:center; justify-content:space-between;
  gap: 12px; padding: 10px 0;
}
.brand{ display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text); font-weight:900; letter-spacing:.2px }
.brand-logo{ width:28px; height:28px; border-radius:8px; box-shadow: 0 0 12px rgba(124,92,255,.28) }
.nav-links{ display:flex; gap:14px; align-items:center }
.nav-links a{ color:var(--muted); text-decoration:none; font-weight:700 }
.nav-links a:hover{ color:var(--text) }

.twitch-cta{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 12px; border-radius:999px;
  text-decoration:none; color:#0b0f1a; background:var(--accent);
  border:1px solid transparent; box-shadow: var(--shadow-sm);
  font-weight:900;
}
.twitch-cta:hover{ transform: translateY(-1px); box-shadow: 0 12px 28px rgba(124,92,255,.28) }
.twitch-cta .live-dot{
  width:10px; height:10px; border-radius:999px; background:#8b8b8b; box-shadow: 0 0 0 0 rgba(239,68,68,0);
}
.twitch-cta.live .live-dot{
  background: var(--danger);
  animation: livePulse 1.2s ease-in-out infinite;
}
@keyframes livePulse{
  0%{ box-shadow:0 0 0 0 rgba(239,68,68,.55) }
  70%{ box-shadow:0 0 0 8px rgba(239,68,68,0) }
  100%{ box-shadow:0 0 0 0 rgba(239,68,68,0) }
}
.viewer-count{ font-weight:800; background:rgba(0,0,0,.15); color:#fff; padding:2px 8px; border-radius:999px }

/* D√©caler ta mini barre utilisateur pour √©viter le chevauchement */
#user-bar{ top: calc(12px + var(--site-header-h, 0px)) !important; }

                                          
  </style>
</head>
<body>
 
  <!-- Topbar / Site Header -->
<header class="site-header" role="banner" aria-label="Grimoire navigation">
  <div class="site-header-row container">
    <a class="brand" href="/" aria-label="Accueil Grimoire">
      <img class="brand-logo" src="https://i.goopics.net/07jxhq.png" alt="" />
      <span class="brand-name">Grimoire</span>
    </a>

    <nav class="nav-links" aria-label="Liens principaux">
      <a href="#" id="nav-rules">R√®gles</a>
    </nav>

    <a id="twitch-link" class="twitch-cta" href="https://twitch.tv/Siana_TV" target="_blank" rel="noopener">
      <span class="live-dot" aria-hidden="true"></span>
      <span id="twitch-status-label">Twitch</span>
      <span id="twitch-viewers" class="viewer-count" hidden></span>
    </a>
  </div>
</header>

  
  <div class="aura" aria-hidden="true"></div>
  
  <!-- Barre utilisateur -->
  <div id="user-bar" style="display:none; position:fixed; top:12px; right:12px; background:rgba(11,15,26,0.85); border:1px solid rgba(255,255,255,0.08); border-radius:14px; padding:8px 14px; display:flex; align-items:center; gap:10px; z-index:100; box-shadow:0 4px 14px rgba(0,0,0,.45)">
    <img id="user-avatar" src="" alt="Avatar Twitch" style="width:32px;height:32px;border-radius:999px;object-fit:cover;border:1px solid rgba(255,255,255,.15)">
    <span id="user-name" style="font-weight:700; color:#e8ecf3;"></span>
    <button id="user-logout" class="btn ghost pill" style="margin-left:auto; padding:4px 10px; font-size:12px">D√©connexion</button>
  </div>

  <header class="hero-header">
    <div class="container">
      <div class="hero-center">
        <div class="hero-logo" aria-hidden="true"></div>
        <h1 class="hero-title">Grimoire</h1>
        <p class="hero-subtitle">Entrez dans la l√©gende, collectionnez le destin</p>
        <div id="user-display-name" class="subtitle" style="display:none"></div>
        <div class="hero-actions">
          <a href="/collection.html" class="btn ghost pill">üìö Ma Collection</a>
          <a href="/profil.html" class="btn ghost pill">üë§ Profil</a>
          <button id="btn-login" class="btn pill">Se connecter avec Twitch</button>
          <button id="btn-logout" class="btn ghost pill" style="display:none">Se d√©connecter</button>
          <a href="/admin.html" class="btn ghost pill" id="btn-admin" style="display:none">Admin</a>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">

<!-- HERO invit√© -->
<section id="guest-cta" class="panel" style="grid-column:span 12">
  <!-- Image de fond : remplace l‚ÄôURL ci-dessous par la tienne -->
  <div class="hero-bg" style="--hero-img:url('https://i.goopics.net/c21046.png')"></div>
  <div class="hero-overlay"></div>

  <div class="hero-content container">
    <h1>Le Grimoire vous attend</h1>
    <p class="subtitle">
      Connectez-vous avec Twitch pour ouvrir vos packs et collectionner les cartes du Grimoire.
    </p>
    <div class="hero-actions">
      <button id="guest-login" class="btn pill btn-hero" aria-label="Se connecter avec Twitch">
        Se connecter avec Twitch
      </button>
    </div>
  </div>
</section>
 
     
      <!-- Statistiques -->
      <section id="panel-stats" class="panel" style="grid-column:span 12">
        <div class="hd">
          <h3>Statistiques</h3>
                  </div>
        <div class="bd">
          <div class="stats">
            <div class="stat"><div class="v" id="stat-packs">0</div><div class="k">Packs ouverts</div></div>
            <div class="stat"><div class="v" id="stat-uniques">0</div><div class="k">Cartes uniques</div></div>
            <div class="stat"><div class="v" id="stat-completion">0%</div><div class="k">% de compl√©tion</div></div>
            <div class="stat"><div class="v" id="stat-rank">Bronze I</div><div class="k">Rang</div></div>
          </div>

          <div id="xp-wrap" style="margin-top:14px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px; gap:10px; flex-wrap:wrap">
              <div class="subtitle">Niveau <span id="stat-level">1</span> ¬∑ XP <span id="stat-xp">0</span>/<span id="stat-xp-next">100</span></div>
              <div class="subtitle">Prochaine r√©compense : <span id="stat-next-reward">Pack Standard</span></div>
            </div>
            <div class="xpbar"><div id="xp-fill" class="fill"></div></div>
          </div>

          <div class="footerbar" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center">
            <button id="btn-claim-rewards" class="btn pill">üéÅ R√©clamer mes r√©compenses de niveau</button>
            <span id="packs-balance-badge" class="badge" style="display:none">Packs dispo : ‚Äî</span>

            <!-- üëá Nouveau : bouton r√®gles -->
  <button id="btn-rules" class="btn ghost pill" aria-haspopup="dialog" aria-controls="rules-modal">
    ‚ÑπÔ∏è R√®gles & Packs
  </button>
</div>
          </div>
        </div>
      </section>

      <!-- Sets disponibles (NOUVEAU) -->
      <section id="panel-sets" class="panel" style="grid-column:span 12">
        <div class="hd">
          <h3>Sets disponibles</h3>
          <small class="subtitle">Clique sur un set puis choisis le niveau du pack</small>
        </div>
        <div class="bd">
          <div class="sets" id="sets"></div>
        </div>
      </section>

      <!-- R√©sultats d'ouverture -->
      <section id="panel-results" class="panel" style="grid-column:span 12">
        <div class="hd"><h3>R√©sultats d'ouverture</h3></div>
        <div class="bd">
          <div id="special-banner" class="banner" style="display:none"></div>
          <div class="results" id="results"></div>
        </div>
      </section>
     </div>

    <!-- Overlay d'animation d'ouverture de pack -->
    <div id="pack-overlay" aria-hidden="true" hidden>
      <div class="po-backdrop"></div>
      <div class="po-stage" role="dialog" aria-label="Ouverture du pack">
        <div class="po-pack" id="po-pack" aria-hidden="true">
          <div class="po-pack-body">
            <div class="po-pack-gloss"></div>
            <div class="po-pack-logo">GRIMOIRE</div>
          </div>
          <div class="po-pack-shine"></div>
        </div>
        <div class="po-slit" id="po-slit" aria-hidden="true"></div>
        <div class="po-fan" id="po-fan" aria-live="polite" aria-atomic="true"></div>
        <canvas id="po-confetti" width="1280" height="720"></canvas>
        <div class="po-actions">
          <button id="po-skip" class="btn pill ghost">Passer l‚Äôanimation</button>
        </div>
      </div>
    </div>

    <!-- Choix du niveau de pack (modal) -->
    <div id="pack-chooser" hidden>
      <div class="backdrop"></div>
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pc-title">
        <h4 id="pc-title">Choisis le niveau du pack</h4>
        <div class="subtitle" id="pc-sub">Set s√©lectionn√© : <span id="pc-set-name">‚Äî</span></div>
        <div class="row">
          <button id="pc-standard" class="btn pill">üé¥ Standard</button>
          <button id="pc-premium" class="btn pill ghost">üíé Premium</button>
        </div>
        <div class="subtitle" style="margin-top:10px">Premium : 5 cartes dont ‚â• 1 Rare mini (d√©bloqu√© avec 5 subs) </div>
        <div class="row" style="justify-content:flex-end">
          <button id="pc-cancel" class="btn ghost pill">Annuler</button>
        </div>
      </div>
    </div>

<div id="rules-modal" hidden>
  <div class="backdrop" style="position:fixed; inset:0; background: rgba(4,6,12,.72); backdrop-filter: blur(4px)"></div>
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="rules-title"
       style="position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
              width:min(640px,92vw); border-radius:18px; background: linear-gradient(180deg,#0f172a,#0b1120);
              border:1px solid rgba(255,255,255,.08); box-shadow: var(--shadow); padding:18px; z-index:80">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:8px">
      <h4 id="rules-title" style="margin:0; font-size:18px">R√®gles & Comment obtenir des packs</h4>
      <button id="rules-close" class="btn ghost pill" aria-label="Fermer">‚úï</button>
    </div>

    <div class="subtitle" style="margin-bottom:10px">
      Tout ce qu‚Äôil faut savoir pour gagner et ouvrir des packs.
    </div>

    <div style="display:grid; gap:10px">
      <div class="stat">
        <div class="v" style="font-size:16px">Fa√ßons d‚Äôobtenir des packs</div>
        <ul style="margin:8px 0 0 18px">
          <li><strong>Packs Standards</strong> : utilisez vos points de cha√Æne en live pour obtenir des packs</li>
          <li><strong>Packs Premium</strong> : d√©bloqu√©s via soutien. 
            1 sub = 1 pack premium. 
            5 subs = 10 packs premium</li>
          <li><strong>R√©compenses de niveau</strong> : gagne de l‚ÄôXP en ouvrant des packs ‚Üí La mont√©e en niveau donne des packs.</li>
          <li><strong>√âv√©nements / Streams</strong> : packs offerts pendant des moments cl√©s en live (drops, d√©fis, giveaways).</li>
          </ul>
      </div>

      <div class="stat">
        <div class="v" style="font-size:16px">Diff√©rences Standard vs Premium</div>
        <ul style="margin:8px 0 0 18px">
          <li><strong>Standard</strong> : 5 cartes al√©atoires (toutes raret√©s possibles).</li>
          <li><strong>Premium</strong> : 5 cartes dont <em>‚â• 1 Rare</em> minimum garanti.</li>
        </ul>
      </div>

      <div class="stat">
        <div class="v" style="font-size:16px">Raret√©s & chances (indicatif)</div>
        <ul style="margin:8px 0 0 18px">
          <li>Commune 60% ¬∑ Peu commune 25% ¬∑ Rare 10% ¬∑ L√©gendaire 4% ¬∑ Exotique 1%</li>
        </ul>
      </div>

      <div class="stat">
        <div class="v" style="font-size:16px">Conseils</div>
        <ul style="margin:8px 0 0 18px">
          <li>V√©rifie ton solde ici : <span class="badge">Packs dispo</span>.</li>
          <li>R√©clame tes r√©compenses de niveau d√®s qu‚Äôelles clignotent.</li>
          <li>Surveille les annonces en stream pour les packs bonus.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

    
  </main>

  <script type="module">
  // --- Firebase imports
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, onAuthStateChanged, OAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { getFirestore, doc, getDoc, setDoc, updateDoc, runTransaction, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // --- Firebase config
  const firebaseConfig = { apiKey: 'AIzaSyCKZK4I3li_7wkmd_qiiM44BoqRTZoloeI', authDomain: 'legends-collection.firebaseapp.com', projectId: 'legends-collection', storageBucket: 'legends-collection.firebasestorage.app', messagingSenderId: '133783086150', appId: '1:133783086150:web:762f209f7f778ef83a1647' };

const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- Auth provider (Twitch via OIDC)
  const twitchProvider = new OAuthProvider('oidc.twitch');
  try { twitchProvider.addScope('openid'); twitchProvider.addScope('user:read:email'); twitchProvider.setCustomParameters({ prompt: 'consent' }); } catch {}

  // --- Helpers pour enregistrer le pseudo Twitch ---
  function decodeJwtPayload(jwt){ try { return JSON.parse(atob(jwt.split('.')[1])); } catch { return {}; } }
  async function saveDisplayNameIfAny(user, nick){ if(!user || !nick) return; playerDocRef = playerDocRef || doc(db,'players',user.uid); try{ await setDoc(playerDocRef, { displayName: nick, displayNameLower: nick.toLowerCase(), updatedAt: serverTimestamp() }, { merge:true }); console.log('[DEBUG] Pseudo enregistr√©:', nick); }catch(e){ console.warn('saveDisplayNameIfAny failed', e); } }
  async function trySavePseudonymFromCredential(cred, user){ if(!user) return; let nick = user.displayName || ''; if(!nick && cred?.idToken){ const claims = decodeJwtPayload(cred.idToken); nick = claims.preferred_username || claims.nickname || ''; } await saveDisplayNameIfAny(user, nick); }

  // --- UI buttons
  const loginBtn = document.getElementById('btn-login');
  const logoutBtn = document.getElementById('btn-logout');
  const adminBtn  = document.getElementById('btn-admin');

    // --- S√©lecteurs panneaux / CTA invit√©
const panelStats   = document.getElementById('panel-stats');
const panelSets    = document.getElementById('panel-sets');
const panelResults = document.getElementById('panel-results');
const guestCta     = document.getElementById('guest-cta');

// Le bouton de la section invit√© d√©clenche le m√™me login que celui du header
const guestLoginBtn = document.getElementById('guest-login');
if (guestLoginBtn) guestLoginBtn.addEventListener('click', () => loginBtn.click());

// Helper d‚Äôaffichage
function setGuestMode(isGuest){
  if (panelStats)   panelStats.style.display   = isGuest ? 'none' : '';
  if (panelSets)    panelSets.style.display    = isGuest ? 'none' : '';
  if (panelResults) panelResults.style.display = isGuest ? 'none' : '';
  if (guestCta)     guestCta.style.display     = isGuest ? '' : 'none';
}

    
  const ADMIN_UIDS = ['VVsf3YTzwkh3rfGGE6N8ku1PVnI3'];
  loginBtn.addEventListener('click', async ()=>{ try { console.log('[DEBUG] Click login -> POPUP'); const result = await signInWithPopup(auth, twitchProvider); const cred = OAuthProvider.credentialFromResult(result); await trySavePseudonymFromCredential(cred, result.user); } catch(e){ console.warn('[DEBUG] Popup sign-in failed, fallback to redirect if blocked', e); if(e?.code === 'auth/popup-blocked' || e?.code === 'auth/popup-closed-by-user'){ try { console.log('[DEBUG] Fallback -> redirect'); await signInWithRedirect(auth, twitchProvider); } catch(err){ alert('Erreur de connexion Twitch: '+(err?.message||err)); console.error(err); } } else { alert('Erreur de connexion Twitch: '+(e?.message||e)); } } });
  logoutBtn.addEventListener('click', async ()=>{ try{ console.log('[DEBUG] Logout'); await signOut(auth);}catch(e){ console.error(e);} });
// --- Rarity constants
  const RARITY = { COMMON:'commune', UNCOMMON:'peu commune', RARE:'rare', LEGENDARY:'l√©gendaire', EXOTIC:'exotique' };
  const RARITY_WEIGHTS = { [RARITY.COMMON]:60, [RARITY.UNCOMMON]:25, [RARITY.RARE]:10, [RARITY.LEGENDARY]:4, [RARITY.EXOTIC]:1 };
  const rarityOrder = [RARITY.COMMON, RARITY.UNCOMMON, RARITY.RARE, RARITY.LEGENDARY, RARITY.EXOTIC];

  // --- Sets (2 sets visibles au lancement)
  const SETS = [
  { id:'NL', name:'Nouvelle Lumi√®re', json:'/data/sets/nouvelle-lumiere.json', img:"https://i.goopics.net/ilm7lk.png" },
  { id:'TW', name:'Twitch',           json:'/data/sets/twitch.json',            img:"https://i.goopics.net/wnhrl2.png" }
];

  // --- Pools par set + pool combin√©
  const CARD_SETS = {}; // { setId: Card[] }
  let ALL_CARDS = [];   // pour stats/collection

  // Fallbacks minimalistes par set
  const FALLBACK = {
    NL: [
      { id:'NL-001', name:'√âclaireur des D√©buts', set:'Nouvelle Lumi√®re', rarity: RARITY.COMMON, image:'' },
      { id:'NL-010', name:'Gantelet du Prospecteur', set:'Nouvelle Lumi√®re', rarity: RARITY.UNCOMMON, image:'' },
      { id:'NL-020', name:'Spectre de la Tour', set:'Nouvelle Lumi√®re', rarity: RARITY.RARE, image:'' },
      { id:'NL-090', name:'Osiris ‚Äî Vision du Disciplin√©', set:'Nouvelle Lumi√®re', rarity: RARITY.LEGENDARY, image:'' },
      { id:'NL-100', name:'Jormungandr ‚Äî L√©gende Perdue', set:'Nouvelle Lumi√®re', rarity: RARITY.EXOTIC, image:'' },
    ],
    TW: [
      { id:'LT-001', name:'Sentinelle de la Place', set:'Twitch', rarity: RARITY.COMMON, image:'' },
      { id:'LT-012', name:'Couteau du Guetteur', set:'Twitch', rarity: RARITY.UNCOMMON, image:'' },
      { id:'LT-025', name:'Canon ‚Äî D√©fenseur', set:'Twitch', rarity: RARITY.RARE, image:'' },
      { id:'LT-070', name:'Shaxx ‚Äî Rugissement', set:'Twitch', rarity: RARITY.LEGENDARY, image:'' },
      { id:'LT-099', name:'Spectre Dor√©', set:'Twitch', rarity: RARITY.EXOTIC, image:'' },
    ]
  };

  function mapRarity(r){ const x=(r||'').toLowerCase(); if(x==='common'||x==='commune') return RARITY.COMMON; if(x==='uncommon'||x==='peu commune') return RARITY.UNCOMMON; if(x==='rare') return RARITY.RARE; if(x==='legendary'||x==='l√©gendaire'||x==='legendaire') return RARITY.LEGENDARY; if(x==='exotic'||x==='exotique') return RARITY.EXOTIC; return RARITY.COMMON; }

  async function loadCardSets(){
    ALL_CARDS = []; Object.keys(CARD_SETS).forEach(k=> delete CARD_SETS[k]);
    for(const s of SETS){
      try{
const res = await fetch(s.json, {cache:'no-store'});
        const data = await res.json();
        const arr = (data.cards||[]).filter(c=>c.id&&c.name).map(c=>({ id:c.id, name:c.name, set:(c.set||s.name), rarity: mapRarity(c.rarity), image:(c.image||'') }));
        CARD_SETS[s.id] = arr.length? arr : FALLBACK[s.id] || [];
      }catch(e){ console.warn('[DEBUG] Set fallback for', s.id, e); CARD_SETS[s.id] = FALLBACK[s.id] || []; }
      ALL_CARDS = ALL_CARDS.concat(CARD_SETS[s.id]);
    }
}

  // --- Local/state (mode d√©connect√© uniquement)
  const LS_KEY = 'grimoire.alpha.collection.v2_6';
  const LS_STATS = 'grimoire.alpha.stats.v2_6';
  const LS_PROFILE = 'grimoire.alpha.profile.v2_6';
  let collection = loadCollection();
  let stats = loadStats();
  let profile = loadProfile();
  let currentUser = null; let playerDocRef = null;
  let packBalances = { standard:0, premium:0 };
  function loadCollection(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||{}; }catch{ return {}; } }
  function loadStats(){ try{ return JSON.parse(localStorage.getItem(LS_STATS))||{packsOpened:0}; }catch{ return {packsOpened:0}; } }
  function loadProfile(){ try{ return JSON.parse(localStorage.getItem(LS_PROFILE))||{level:1,xp:0}; }catch{ return {level:1,xp:0}; } }

  const isCloud = () => !!currentUser && !!playerDocRef;
  function updateLocalFromCloud(data){
    collection = { ...(data.collection || {}) };
    stats = { packsOpened: data?.stats?.packsOpened || 0 };
    profile = { level: data?.level || 1, xp: data?.xp || 0 };
    packBalances = { standard: data?.packBalances?.standard || 0, premium: data?.packBalances?.premium || 0 };
    renderStats();
    renderCollection();
    updateRewardButton(data?.rewardsInbox || []); // synchro du bouton
    refreshPackUI();
  }

  function maybeSaveLocal(){ if (!isCloud()) { localStorage.setItem(LS_KEY, JSON.stringify(collection)); localStorage.setItem(LS_STATS, JSON.stringify(stats)); localStorage.setItem(LS_PROFILE, JSON.stringify(profile)); } }
  function saveCollection(){ maybeSaveLocal(); } function saveStats(){ maybeSaveLocal(); } function saveProfile(){ maybeSaveLocal(); }

  // --- XP / Levels
  function xpForLevel(level){ return 50 * Math.max(1, level); }
  function xpGainForPack(type){ return (type === 'premium') ? 10 : 5; }
  function nextRewardForLevel(level){ if(level===1) return {type:'pack_standard', label:'Pack Standard'}; if([2,5,10,15,20].includes(level)) return {type:'pack_premium', label:'Pack Premium'}; return {type:'pack_standard', label:'Pack Standard'}; }

  // --- Rendering
  function renderStats(){ const uniqueOwned = Object.keys(collection).length; const totalUnique = new Set(ALL_CARDS.map(c=>c.id)).size; const completion = totalUnique? Math.round((uniqueOwned/totalUnique)*100) : 0; document.getElementById('stat-packs').textContent = stats.packsOpened||0; document.getElementById('stat-uniques').textContent = uniqueOwned; document.getElementById('stat-completion').textContent = completion+"%"; document.getElementById('stat-rank').textContent = rankFromCompletion(completion); const level = profile.level||1; const xp = profile.xp||0; const need = xpForLevel(level); const pct = Math.max(0, Math.min(100, Math.round((xp/need)*100))); document.getElementById('stat-level').textContent = level; document.getElementById('stat-xp').textContent = xp; document.getElementById('stat-xp-next').textContent = need; document.getElementById('xp-fill').style.width = pct + '%'; document.getElementById('stat-next-reward').textContent = nextRewardForLevel(level).label; }
  function rankFromCompletion(p){ if(p >= 100) return 'Parangon'; if(p >= 90) return 'Exemplaire'; if(p >= 80) return 'Vainqueur'; if(p >= 70) return 'Justicier'; if(p >= 60) return 'Elite'; if(p >= 50) return 'V√©t√©ran'; if(p >= 40) return 'Aventurier'; if(p >= 30) return '√âclaireur'; if(p >= 20) return 'Initi√©'; if(p >= 10) return 'Explorateur'; return 'Nouvelle lumi√®re'; }
  function rarityClass(r){ switch(r){ case RARITY.UNCOMMON:return 'uncommon'; case RARITY.RARE:return 'rare'; case RARITY.LEGENDARY:return 'legendary'; case RARITY.EXOTIC:return 'exotic'; default:return 'common'; } }

  function renderResults(cards){ const wrap = document.getElementById('results'); wrap.innerHTML=''; let hasLegendary=false, hasExotic=false; for(const card of cards){ const div=document.createElement('div'); div.className='card'; const img=document.createElement('div'); img.className='img'; if(card.image){ img.style.background = `linear-gradient(180deg,rgba(255,255,255,.06),transparent 30%), url('${card.image}') center/cover no-repeat`; img.style.opacity = .85; } const shine=document.createElement('div'); shine.className='shine'; div.appendChild(img); div.appendChild(shine); div.addEventListener('pointermove', (e)=>{ 
    const r=e.currentTarget.getBoundingClientRect(); const mx=((e.clientX-r.left)/r.width)*100; const my=((e.clientY-r.top)/r.height)*100; shine.style.setProperty('--mx', mx+'%'); shine.style.setProperty('--my', my+'%'); }); const footer=document.createElement('div'); footer.className='footer'; footer.innerHTML = `<div class="name">${card.name}</div><div class="tag ${rarityClass(card.rarity)}"><span class="dot"></span>${card.set} ‚Äî ${card.rarity}</div>`; div.appendChild(footer); wrap.appendChild(div); if(card.rarity===RARITY.LEGENDARY) hasLegendary=true; if(card.rarity===RARITY.EXOTIC) hasExotic=true; }
    const banner=document.getElementById('special-banner'); if(hasExotic || hasLegendary){ banner.style.display='flex'; banner.innerHTML=(hasExotic ? '‚ú® <strong>EXOTIQUE !</strong> Carte exotique !' : '‚≠ê <strong>L√âGENDAIRE !</strong>') + '<button class="close" aria-label="Fermer">√ó</button>'; banner.querySelector('.close').addEventListener('click',()=>{ banner.style.display='none'; }); } else { banner.style.display='none'; } }

  function renderCollection(){ const wrap=document.getElementById('collection'); if(!wrap) return; wrap.innerHTML=''; const byRarityIdx=c=>rarityOrder.indexOf(c.rarity); const all=ALL_CARDS.slice().sort((a,b)=>byRarityIdx(a)-byRarityIdx(b)||a.id.localeCompare(b.id)); for(const card of all){ const qty=collection[card.id]||0; const div=document.createElement('div'); div.className='mini-card'; div.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;gap:8px">' + '<div style="font-weight:700">'+card.name+'</div>' + '<span class="tag '+rarityClass(card.rarity)+'"><span class="dot"></span>'+card.rarity+'</span>' + '</div><div class="qty">'+card.set+' ‚Äî '+card.id+'</div>' + '<div class="qty">Quantit√© : <strong>'+qty+'</strong></div>'; wrap.appendChild(div); } }

  // --- Rewards button UI ---
  function updateRewardButton(inbox){
    const btn = document.getElementById('btn-claim-rewards');
    if(!btn) return;

    const hasReward = Array.isArray(inbox) && inbox.length > 0;

    if(!hasReward){
      btn.textContent = "üéÅ Aucune r√©compense disponible";
      btn.disabled = true;
      btn.classList.add('ghost');
      btn.classList.remove('pulse-glow');
      btn.setAttribute('aria-disabled','true');
      btn.setAttribute('title','Pas de r√©compense √† r√©clamer');
    } else {
      const n = inbox.length;
      btn.textContent = n === 1 ? "üéÅ R√©clamer ma r√©compense" : `üéÅ R√©clamer (${n}) r√©compenses`;
      btn.disabled = false;
      btn.classList.remove('ghost');
      btn.classList.add('pulse-glow');
      btn.removeAttribute('aria-disabled');
      btn.setAttribute('title','Clique pour recevoir ta r√©compense');
    }
  }

  // --- Tirage helpers
  function weightedRandomRarity(){ const entries=Object.entries(RARITY_WEIGHTS); const total=entries.reduce((s,[,w])=>s+w,0); let r=Math.random()*total; for(const [rarity,weight] of entries){ if(r<weight) return rarity; r-=weight; } return RARITY.COMMON; }
  function pickCardByRarity(rarity, pool){ const p = (pool||[]).filter(c=>c.rarity===rarity); if(p.length===0){ const idx=rarityOrder.indexOf(rarity); for(let j=idx-1;j>=0;j--){ const q=(pool||[]).filter(c=>c.rarity===rarityOrder[j]); if(q.length) return q[Math.floor(Math.random()*q.length)]; } return (pool||ALL_CARDS)[Math.floor(Math.random()*Math.max(1,(pool||ALL_CARDS).length))]; } return p[Math.floor(Math.random()*p.length)]; }
  function ensureAtLeastRare(){ const r=Math.random()*(RARITY_WEIGHTS[RARITY.RARE]+RARITY_WEIGHTS[RARITY.LEGENDARY]+RARITY_WEIGHTS[RARITY.EXOTIC]); const thresholds=[[RARITY.RARE,RARITY_WEIGHTS[RARITY.RARE]],[RARITY.LEGENDARY,RARITY_WEIGHTS[RARITY.LEGENDARY]],[RARITY.EXOTIC,RARITY_WEIGHTS[RARITY.EXOTIC]]]; let sum=0; for(const [rar,w] of thresholds){ sum+=w; if(r<sum) return rar; } return RARITY.RARE; }

  // --- Overlay animation (inchang√© sauf logique verso/face)
  const overlay = document.getElementById('pack-overlay');
  const poPack  = document.getElementById('po-pack');
  const poSlit  = document.getElementById('po-slit');
  const poFan   = document.getElementById('po-fan');
  const poSkip  = document.getElementById('po-skip');
  const poFx    = document.getElementById('po-confetti');
  const ctxFx   = poFx.getContext('2d');
  const CARD_BACK_URL = 'https://i.goopics.net/5vn5ys.png'; // üÜï verso demand√©
  let skipRequested = false; 
    if (poSkip) { poSkip.addEventListener('click', ()=>{ skipRequested = true; }); }

// --- Timings de fin d‚Äôouverture
const FINAL_PAUSE_AFTER_LAST_REVEAL = 1600; // ms ‚Äì laisse le joueur voir ses cartes
const FINAL_PAUSE_AFTER_SKIP = 250;         // ms ‚Äì si "Passer l‚Äôanimation"

    
  function showOverlay(){ overlay.hidden = false; requestAnimationFrame(()=> overlay.style.opacity = 1); }
  function hideOverlay(){ overlay.style.opacity = 0; setTimeout(()=> overlay.hidden = true, 180); }
  function wait(ms){ return new Promise(r=> setTimeout(r, ms)); }
  function rarityGlowClass(r){ if(r===RARITY.EXOTIC) return 'glow-exotic'; if(r===RARITY.LEGENDARY) return 'glow-legendary'; if(r===RARITY.RARE) return 'glow-rare'; if(r===RARITY.UNCOMMON) return 'glow-uncommon'; return 'glow-common'; }
  function burst(x, y, strong=false){ const parts = []; const n = strong ? 140 : 80; for(let i=0;i<n;i++){ parts.push({ x, y, vx: (Math.random()*2-1)*(strong?6:4), vy: (Math.random()*-2-2)*(strong?2:1.6), g:  0.18, a:  1, s:  Math.random()*2+1 }); } const start = performance.now(); function step(t){ step._lt = t; ctxFx.clearRect(0,0,poFx.width,poFx.height); parts.forEach(p=>{ p.vy += p.g; p.x  += p.vx; p.y  += p.vy; p.a  -= 0.012; ctxFx.globalAlpha = Math.max(0,p.a); ctxFx.fillStyle = '#fff'; ctxFx.fillRect(p.x, p.y, p.s, p.s); }); ctxFx.globalAlpha = 1; if(performance.now()-start < 1800) requestAnimationFrame(step); else ctxFx.clearRect(0,0,poFx.width,poFx.height); } requestAnimationFrame(step); }
  
// --- NEW: utilitaires "nouvelle carte" ---
window.__ownedBefore = new Set();

function showNewCardBanner(cardName){
  const banner = document.getElementById('special-banner');
  if(!banner) return;
  banner.className = 'banner new-card';
  banner.style.display = 'flex';
  banner.innerHTML = `üìú‚ú® <strong>NOUVELLE carte !</strong> ${cardName}`;
  clearTimeout(window.__newCardTimer);
  window.__newCardTimer = setTimeout(()=>{ banner.style.display = 'none'; }, 5000);
}

async function getOwnedCardIdsBefore(){
  if (window.playerCollection && typeof window.playerCollection === 'object'){
    return Object.keys(window.playerCollection).filter(id => (window.playerCollection[id]?.qty||0) > 0);
  }
  return [];
}

async function snapshotOwnedBeforeOpening(){
  const ids = await getOwnedCardIdsBefore();
  window.__ownedBefore = new Set(ids);
}

    
    
    async function playPackAnimation(cards, setId){ const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches; skipRequested = reduce ? true : false; poFx.width = Math.min(1280, innerWidth); poFx.height = Math.min(720, innerHeight); poFan.innerHTML = ''; poSlit.style.opacity = 0; poSlit.style.height = '0px'; poPack.style.opacity = 1; poPack.style.transform = ''; 
  showOverlay(); 

// prendre un snapshot de la collection avant les tirages (si tu comptes l‚Äôutiliser)
await snapshotOwnedBeforeOpening();

// -- Afficher le visuel du set sur le pack
// -- Afficher le visuel du set sur le pack
const body = poPack.querySelector('.po-pack-body');
let art = body.querySelector('.po-pack-art');
if (!art) {
  art = document.createElement('div');
  art.className = 'po-pack-art';
  // ‚úÖ Styles inline au cas o√π le CSS a √©t√© ignor√©
  art.style.position = 'absolute';
  art.style.inset = '10px';
  art.style.borderRadius = '14px';
  art.style.backgroundRepeat = 'no-repeat';
  art.style.backgroundPosition = 'center';
  art.style.backgroundSize = 'contain';
  art.style.border = '1px solid rgba(255,255,255,.10)';
  art.style.boxShadow = 'inset 0 0 30px rgba(0,0,0,.35)';
  art.style.pointerEvents = 'none';

  // on place l‚Äôart AVANT la gloss pour que la brillance agisse dessus
  body.insertBefore(art, body.firstChild);
}

const currentSet = SETS.find(s => s.id === setId);
art.style.backgroundImage = currentSet?.img
  ? `url('${(currentSet.img || "").replaceAll("'", "\\'")}')`
  : 'none';

// (facultatif) debug rapide
console.debug('[pack-art]', { setId, img: currentSet?.img, applied: getComputedStyle(art).backgroundImage });

                                                 
    const shine = poPack.querySelector('.po-pack-shine'); overlay.onpointermove = (e)=> { 
      const r = poPack.getBoundingClientRect(); if (shine) { shine.style.setProperty('--mx', ((e.clientX - r.left)/r.width*100)+'%'); shine.style.setProperty('--my', ((e.clientY - r.top)/r.height*100)+'%'); } }; poPack.style.animation = 'poShake .5s linear'; await wait(skipRequested ? 0 : 520); 
                                                 
      const r = poPack.getBoundingClientRect(); 
      poSlit.style.left = (r.left + r.width/2) + 'px'; 
      poSlit.style.top  = (r.top  + 40) + 'px'; 
      poSlit.style.opacity = 1; 
      poSlit.style.height  = (r.height - 80) + 'px'; 
      await wait(skipRequested ? 0 : 260); 
      poPack.style.opacity = 0; burst(poFx.width/2, poFx.height/2, false); 
      await wait(skipRequested ? 0 : 160); 

// --- Aligner le ventail de cartes sur la position du pack (√©vite le "saut" sur mobile)
poFan.style.position = 'absolute';

// Centre horizontalement sur le pack
const packCenterX = r.left + r.width / 2;
// D√©cale l√©g√®rement vers le bas (62% de la hauteur du pack ‚âà bord inf√©rieur visuel du sachet)
const packBaselineY = r.top + r.height * 0.62;

// Contraintes de s√©curit√© pour petits √©crans
const margin = 12;
const safeY = Math.min(
  Math.max(packBaselineY, margin),
  innerHeight - margin
);

// Place le ventail exactement l√†
poFan.style.left = packCenterX + 'px';
poFan.style.top  = safeY + 'px';
poFan.style.transform = 'translate(-50%, -50%)';

// On neutralise le l√©ger translateY d√©fini en CSS pour √©viter tout d√©calage
poFan.style.opacity = '0';

                                                 
      const ANG = [-18,-9,0,9,18]; cards.forEach((c, i)=>{ const el = document.createElement('div'); el.className = 'po-card'; el.style.setProperty('--rot', ANG[i]+'deg'); el.setAttribute('data-idx', String(i)); // image face potentielle
    const faceUrl = (c.image || '').replaceAll("'", "\\'");
    el.innerHTML = `
      <div class="img" style="--bg:url('${CARD_BACK_URL.replaceAll("'","\\'")}')"></div>
      <div class="shine"></div>
      <div class="tagbar">${c.name || 'Carte'}</div>
      <div class="veil">CLIQUE POUR REVELER</div>`;
    // stocker la face dans data-face (si dispo)
    if (faceUrl) el.dataset.face = faceUrl;
    poFan.appendChild(el);
  }); 
                                                 
// Affiche le ventail SANS d√©caler la position (reste coll√© au sachet)
poFan.style.opacity = '1';
Array.from(poFan.children).forEach((el, i)=> {
setTimeout(()=>{ el.classList.add('revealed'); }, skipRequested ? 0 : 70*i);
});                                                 
    await wait(skipRequested ? 0 : 420);
    function setupClickReveal(){ let remaining = new Set(cards.map((_,i)=> i)); let resolveAll; const done = new Promise(r=> resolveAll = r); function onKey(e){ if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); e.currentTarget.click(); } } function revealIndex(i, fast=false){ const c = cards[i]; const el = poFan.querySelector('.po-card[data-idx="'+i+'"]'); if(!el || el.getAttribute('aria-pressed') === 'true') return; // üîÅ passer du verso √† la face si disponible
        const imgEl = el.querySelector('.img');
        const face = el.dataset.face;
        if (face) {
          imgEl.style.setProperty('--bg', `url('${face}')`);
        } else {
          // s'il n'y a pas d'image de face, on garde le verso
          imgEl.style.setProperty('--bg', `url('${CARD_BACK_URL.replaceAll("'","\\'")}')`);
        }
        el.setAttribute('aria-pressed','true');
        el.classList.add(rarityGlowClass(c.rarity));
        el.style.transform += fast ? ' translateY(-4px) scale(1.01)' : ' translateY(-8px) scale(1.02)';
        const isBig = (c.rarity===RARITY.LEGENDARY || c.rarity===RARITY.EXOTIC);
        if(isBig) burst(poFx.width/2 + (i-2)*70, poFx.height/2 - 80, c.rarity===RARITY.EXOTIC); }
      Array.from(poFan.children).forEach((el, i)=>{ el.setAttribute('role','button'); el.setAttribute('tabindex','0'); el.setAttribute('aria-pressed','false'); el.addEventListener('keydown', onKey); el.addEventListener('click', ()=>{ if(el.getAttribute('aria-pressed') === 'true') return; revealIndex(i, false); remaining.delete(i); if(remaining.size === 0){ resolveAll(); } }, { passive:true }); }); function revealAllFast(){ remaining.forEach(idx => revealIndex(idx, true)); remaining.clear(); resolveAll(); } if (poSkip){ poSkip.addEventListener('click', revealAllFast, { once:true }); } if (skipRequested){ revealAllFast(); } return done; }
   await setupClickReveal();

// ‚è∏Ô∏è Garde les cartes √† l‚Äô√©cran un peu plus longtemps apr√®s la DERNI√àRE r√©v√©lation
const pause = skipRequested ? FINAL_PAUSE_AFTER_SKIP : FINAL_PAUSE_AFTER_LAST_REVEAL;
await wait(pause);
hideOverlay();
 }

  // --- Ouverture de pack (bloqu√©e par solde packBalances) ---
  async function openPack({type='standard', setId} = {}){
    const pool = CARD_SETS[setId] || ALL_CARDS;
    if(!pool.length){ alert('Cartes non charg√©es pour ce set.'); return; }
    if(!isCloud()){ alert('Connecte-toi avec Twitch pour ouvrir des packs (mode cloud).'); return; }

    // Tirage (client) depuis le pool du set
    const cards=[];
    if(type==='premium'){
      const idx=Math.floor(Math.random()*5);
      for(let i=0;i<5;i++){
        const rarity=(i===idx)? ensureAtLeastRare(): weightedRandomRarity();
        cards.push(pickCardByRarity(rarity, pool));
      }
    } else {
      for(let i=0;i<5;i++){
        const rarity=weightedRandomRarity();
        cards.push(pickCardByRarity(rarity, pool));
      }
    }

    // Transaction Firestore = source de v√©rit√©
    let newDocState = null;
    try{
      newDocState = await runTransaction(db, async (trx)=>{
        const docSnap = await trx.get(playerDocRef);
        if(!docSnap.exists()) throw new Error('Profil introuvable');
        const cur = docSnap.data() || {};

        const balances = { ...(cur.packBalances||{}) };
        const key = (type==='premium') ? 'premium' : 'standard';
        const available = Math.max(0, balances[key]||0);
        if(available <= 0){ throw new Error(`Aucun pack ${key} disponible`); }
        balances[key] = available - 1; // ‚úÖ d√©cr√©ment

        const newStats = { ...(cur.stats||{}), packsOpened: Math.max(0,(cur.stats?.packsOpened||0)) + 1 };
        const newCollection = { ...(cur.collection||{}) };
        for(const c of cards){ newCollection[c.id] = (newCollection[c.id]||0) + 1; }

        let level = cur.level || 1;
        let xp = (cur.xp || 0) + xpGainForPack(type);
        let rewards = Array.isArray(cur.rewardsInbox)? cur.rewardsInbox.slice() : [];
        let need = xpForLevel(level);
        while(xp >= need){
          xp -= need; level += 1; need = xpForLevel(level);
          const rw = nextRewardForLevel(level - 1);
          rewards.push({ id:'rw_'+Date.now()+Math.random().toString(36).slice(2), type:rw.type, label:rw.label, t:Date.now() });
        }

        const newDoc = { stats:newStats, collection:newCollection, level, xp, rewardsInbox:rewards, packBalances: balances, updatedAt: serverTimestamp() };
        trx.set(playerDocRef, newDoc, { merge:true });
        return newDoc;
      });
    }catch(e){ alert(e.message || String(e)); return; }

    // Mise √† jour UI + animation
    updateLocalFromCloud(newDocState);
    await playPackAnimation(cards, setId);
    renderResults(cards);
    toast((type==='premium' ? 'üíé Premium' : 'üé¥ Standard')+' ‚Äî '+(SETS.find(s=>s.id===setId)?.name||'Set')+' ouvert !');
  }

  // --- Auth state
  onAuthStateChanged(auth, async (user) => {
    currentUser = user || null;
loginBtn.style.display = currentUser ? 'none' : '';
    logoutBtn.style.display = currentUser ? '' : 'none';
    adminBtn.style.display = 'none';
    const nameBox = document.getElementById('user-display-name');
    const userBar = document.getElementById('user-bar');
    const userName = document.getElementById('user-name');
    const userAvatar = document.getElementById('user-avatar');
    if (!currentUser) {
  if (nameBox) nameBox.style.display = 'none';
  if (userBar) userBar.style.display = 'none';
  setAdminUIVisible(false);
  document.body.className = 'guest';   // <<< AJOUT
  setGuestMode(true); 
  refreshPackUI();
  return;
}

    const data = await loadOrCreatePlayerDoc(currentUser).catch(console.error);
    let pseudo = data?.displayName || currentUser.displayName || '';
    if (!pseudo && currentUser.uid) pseudo = '(uid) ' + currentUser.uid.slice(0, 6);
    if (nameBox) { nameBox.style.display = ''; nameBox.textContent = `Connect√© en tant que ${pseudo}`; }
    if (userBar && userName && userAvatar) { userName.textContent = pseudo; userAvatar.src = currentUser.photoURL || 'https://static-cdn.jtvnw.net/jtv_user_pictures/xarth/404_user_70x70.png'; userBar.style.display = 'flex'; }
    const allowByUid  = ADMIN_UIDS.includes(currentUser.uid);
const allowByRole = !!(data && (data.isAdmin === true || data.role === 'admin'));
const isAdmin = allowByUid || allowByRole;

if (isAdmin) adminBtn.style.display = '';
setAdminUIVisible(isAdmin);
document.body.className = 'logged-in';
    setGuestMode(false);
  });

  // --- Cloud bootstrap
async function loadOrCreatePlayerDoc(user){
  playerDocRef = doc(db,'players',user.uid);

  // 1) Lis l‚Äôexistant
  const snap = await getDoc(playerDocRef);
  if (!snap.exists()) {
    // 2) Premier login : on cr√©e un doc MINIMAL en merge (n‚Äô√©crase jamais rien)
    const base = {
      displayName: user.displayName || '',
      photoURL: user.photoURL || '',
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
      // ‚ö†Ô∏è NE PAS mettre packBalances ici
      // ‚ö†Ô∏è NE PAS r√©initialiser stats ici
      // Tu peux garder des valeurs par d√©faut c√¥t√© UI uniquement
    };
    await setDoc(playerDocRef, base, { merge: true }); // merge = pas d‚Äô√©crasement
    updateLocalFromCloud({
      collection: {},
      stats: { packsOpened: 0 },
      level: 1,
      xp: 0,
      rewardsInbox: [],
      // packBalances est volontairement omis : l‚ÄôUI affichera 0 sans l‚Äô√©crire
    });
    return (await getDoc(playerDocRef)).data() || base;
  }

  // 3) Doc existant : on NE TOUCHE PAS aux soldes ici
  const data = snap.data() || {};
  updateLocalFromCloud(data);

  // 4) Ping de fra√Æcheur (facultatif) ‚Äî n‚Äô√©crase aucun champ sensible
  try { await updateDoc(playerDocRef, { updatedAt: serverTimestamp() }); } catch {}

  return data;
}


  // --- UI Sets + Chooser
  const setsWrap = document.getElementById('sets');
  const chooser = document.getElementById('pack-chooser');
  const pcSetName = document.getElementById('pc-set-name');
  const pcStandard = document.getElementById('pc-standard');
  const pcPremium = document.getElementById('pc-premium');
  const pcCancel = document.getElementById('pc-cancel');
  let currentSetId = null;

  function refreshPackUI(){
    // Met √† jour le badge + √©tats des boutons de choix
    const badgeEl = document.getElementById('packs-balance-badge');
    if(badgeEl){ badgeEl.textContent = `Packs dispo : Standard √ó${packBalances.standard} ¬∑ Premium √ó${packBalances.premium}`; badgeEl.style.display = ''; }
    if(pcStandard){ pcStandard.textContent = `üé¥ Standard ${packBalances.standard?`(√ó${packBalances.standard})`:''}`; pcStandard.disabled = packBalances.standard<=0; pcStandard.classList.toggle('ghost', packBalances.standard<=0); pcStandard.title = packBalances.standard<=0 ? 'Aucun pack Standard disponible' : ''; }
    if(pcPremium){ pcPremium.textContent = `üíé Premium ${packBalances.premium?`(√ó${packBalances.premium})`:''}`; pcPremium.disabled = packBalances.premium<=0; pcPremium.classList.toggle('ghost', packBalances.premium<=0); pcPremium.title = packBalances.premium<=0 ? 'Aucun pack Premium disponible' : ''; }
    // D√©sactive les boutons "Ouvrir" de chaque set si aucun pack
    const noPacks = (packBalances.standard + packBalances.premium) <= 0;
    document.querySelectorAll('.set .overlay .btn').forEach(btn=>{ btn.disabled = noPacks; btn.classList.toggle('ghost', noPacks); btn.title = noPacks ? 'Aucun pack disponible. Obtiens des packs via admin ou r√©compenses.' : ''; });
  }

  function openChooser(setId){ currentSetId = setId; const s = SETS.find(x=>x.id===setId); pcSetName.textContent = s?.name || '‚Äî'; chooser.hidden = false; refreshPackUI(); }
  function closeChooser(){ chooser.hidden = true; }
  function choosePackOpen(setId, type){ closeChooser(); openPack({ setId, type }); }
  pcStandard.addEventListener('click', ()=>{ if(!currentSetId) return; choosePackOpen(currentSetId,'standard'); });
  pcPremium.addEventListener('click',  ()=>{ if(!currentSetId) return; choosePackOpen(currentSetId,'premium');  });
  pcCancel.addEventListener('click', closeChooser);
  chooser.querySelector('.backdrop').addEventListener('click', closeChooser);

  function renderSets(){
    setsWrap.innerHTML='';
    for(const s of SETS){
      const count = (CARD_SETS[s.id]||[]).length || 0;

      const el = document.createElement('div');
      el.className='set';
      el.innerHTML = `
        <div class="cover">
          <img src="${s.img}" alt="Visuel du set ${s.name}">
          <div class="overlay">
            <div>
              <div class="name">${s.name}</div>
              <div class="meta">${count} cartes</div>
            </div>
            <button class="btn pill" aria-label="Ouvrir ${s.name}">Ouvrir</button>
          </div>
        </div>
        <div class="stats-row">
          <span class="tag"><span class="dot"></span>Set disponible</span>
          <span class="subtitle">Clique sur Ouvrir pour choisir Standard/Premium</span>
        </div>
      `;

      const openBtn = el.querySelector('button');
      openBtn.addEventListener('click', ()=> openChooser(s.id));
      el.querySelector('.cover').addEventListener('click', ()=> openChooser(s.id));

      setsWrap.appendChild(el);
    }
    refreshPackUI();
  }

  // --- Toast helper
  function toast(msg,ms=1800){ let t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); requestAnimationFrame(()=> t.classList.add('show')); setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=> t.remove(),200); }, ms); }

   // --- Init
  async function init(){
    const skel = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(var(--card-w),1fr));gap:12px"><div class="card"></div><div class="card"></div><div class="card"></div></div>';
    document.getElementById('results').innerHTML = skel;
    await loadCardSets();
    renderStats();
    renderCollection();
    renderSets();
    document.getElementById('results').innerHTML = '';

    // bouton en √©tat 0 avant la premi√®re synchro cloud
    updateRewardButton([]);
    refreshPackUI();

}

  init();

  // --- R√©clamations de r√©compenses (convertit les packs en solde) ---
  document.getElementById('btn-claim-rewards').addEventListener('click', async ()=>{
    if(!currentUser){ alert('Connecte-toi avec Twitch pour r√©clamer tes r√©compenses.'); return; }

    try{
      const result = await runTransaction(db, async (trx)=>{
        const snap = await trx.get(playerDocRef);
        if(!snap.exists()) throw new Error('Profil introuvable');
        const data = snap.data();
        const inbox = Array.isArray(data.rewardsInbox) ? data.rewardsInbox.slice() : [];
        if(inbox.length === 0) throw new Error('Aucune r√©compense √† r√©clamer');

        // Retire la 1re r√©compense (FIFO)
        const reward = inbox.shift();

        // Si la r√©compense est un pack, on l'ajoute au solde
        const balances = { ...(data.packBalances||{}) };
        let addedPack = null;
        if(reward?.type === 'pack_standard'){ balances.standard = Math.max(0,(balances.standard||0) + 1); addedPack = 'standard'; }
        else if(reward?.type === 'pack_premium'){ balances.premium = Math.max(0,(balances.premium||0) + 1); addedPack = 'premium'; }

        trx.update(playerDocRef, { rewardsInbox: inbox, packBalances: balances, updatedAt: serverTimestamp() });
        return { remainingInbox: inbox, claimed: reward, addedPack };
      });

      // Met √† jour UI
      updateRewardButton(result.remainingInbox);
      if(result.addedPack){ packBalances[result.addedPack] = (packBalances[result.addedPack]||0) + 1; refreshPackUI(); }

      // S'il s'agit d'un pack, on propose d'ouvrir tout de suite via le chooser
      if(result.claimed?.type === 'pack_standard'){ toast('Pack Standard ajout√© √† ton solde'); openChooser(currentSetId || 'NL'); }
      else if(result.claimed?.type === 'pack_premium'){ toast('Pack Premium ajout√© √† ton solde'); openChooser(currentSetId || 'NL'); }
      else { toast('R√©compense r√©cup√©r√©e ‚ú®'); }

    } catch(e){ alert(e.message || String(e)); }
  });

  // Barre utilisateur logout
  const userLogoutBtn = document.getElementById('user-logout');
  if (userLogoutBtn) { userLogoutBtn.addEventListener('click', async () => { try { console.log('[DEBUG] Logout (barre utilisateur)'); await signOut(auth); } catch (e) { console.error(e); } }); }


    let currentIsAdmin = false;
function setAdminUIVisible(isAdmin){
  currentIsAdmin = !!isAdmin;
  const diagPanel = document.getElementById('admin-diag');
  if (diagPanel) diagPanel.style.display = isAdmin ? '' : 'none';
}

    // --- Rules modal
const rulesBtn   = document.getElementById('btn-rules');
const rulesModal = document.getElementById('rules-modal');
const rulesClose = document.getElementById('rules-close');

function openRules(){
  if(!rulesModal) return;
  rulesModal.hidden = false;
  // focus trap basique
  setTimeout(()=> rulesClose?.focus(), 0);
}
function closeRules(){
  if(!rulesModal) return;
  rulesModal.hidden = true;
}

rulesBtn?.addEventListener('click', openRules);
rulesClose?.addEventListener('click', closeRules);
rulesModal?.querySelector('.backdrop')?.addEventListener('click', closeRules);
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && !rulesModal.hidden) closeRules(); });


    // --- Topbar Twitch wiring
const TWITCH_CHANNEL = 'Siana_TV'; // ‚Üê adapte si besoin
const TWITCH_URL = `https://twitch.tv/${TWITCH_CHANNEL}`;
const twitchLink = document.getElementById('twitch-link');
const twitchLabel = document.getElementById('twitch-status-label');
const twitchViewers = document.getElementById('twitch-viewers');
twitchLink?.setAttribute('href', TWITCH_URL);

// Mesure la hauteur du header pour d√©caler #user-bar
(function syncHeaderHeight(){
  const h = document.querySelector('.site-header')?.getBoundingClientRect().height || 0;
  document.documentElement.style.setProperty('--site-header-h', `${Math.round(h)}px`);
})();

// Ouvre le m√™me modal "R√®gles" depuis le header (si tu l‚Äôas impl√©ment√©)
document.getElementById('nav-rules')?.addEventListener('click', (e)=>{
  e.preventDefault();
  if (typeof openRules === 'function') openRules();
});

// --- Statut LIVE (optionnel):
// Si tu exposes un endpoint qui renvoie { live: boolean, viewers?: number },
// d√©finis window.TWITCH_STATUS_ENDPOINT = '/api/twitch/status' AVANT ce script.
// Sinon, on affiche juste "Twitch" sans badge LIVE.
async function updateTwitchStatus(){
  const endpoint = window.TWITCH_STATUS_ENDPOINT || null;
  if (!endpoint){
    twitchLabel.textContent = 'Twitch';
    return;
  }
  try{
    const res = await fetch(endpoint, { cache:'no-store' });
    const data = await res.json();
    const live = !!data.live;
    twitchLink.classList.toggle('live', live);
    twitchLabel.textContent = live ? 'EN DIRECT' : 'Twitch';
    if (live && Number.isFinite(data.viewers)){
      twitchViewers.hidden = false;
      twitchViewers.textContent = `${data.viewers} viewers`;
    } else {
      twitchViewers.hidden = true;
    }
  }catch(e){
    // en cas d‚Äôerreur, fallback neutre
    twitchLink.classList.remove('live');
    twitchLabel.textContent = 'Twitch';
    twitchViewers.hidden = true;
  }
}
updateTwitchStatus();
setInterval(updateTwitchStatus, 60_000);

    
  </script>

</body>
</html>
