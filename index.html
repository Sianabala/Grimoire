<!-- Grimoire ‚Äî Prototype V3.5 avec XP, niveaux, rewards, persistance Firebase, logs debug, packs et collection -->
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Grimoire Prototype V3.5</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
/* Styles simplifi√©s */
body { font-family: Arial, sans-serif; background: #111; color: #eee; margin: 0; padding: 0; }
header, section { padding: 10px; }
header { background: #222; display: flex; justify-content: space-between; align-items: center; }
button { margin: 5px; padding: 5px 10px; }
#packs .pack { border: 1px solid #555; padding: 10px; margin: 5px; display: inline-block; cursor: pointer; }
.card { display: inline-block; border: 1px solid #444; padding: 5px; margin: 3px; background: #222; }
progress { width: 100%; }
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>Grimoire ‚Äî Destiny 2 TCG</h1>
    <div>
      <button id="btn-login">Se connecter avec Twitch</button>
      <button id="btn-logout">Se d√©connecter</button>
    </div>
  </header>

  <section id="stats">
    <div>Packs ouverts : <span id="stat-packs">0</span></div>
    <div>Cartes uniques : <span id="stat-uniques">0</span></div>
    <div>Compl√©tion : <span id="stat-completion">0%</span></div>
    <div>Rang : <span id="stat-rank">-</span></div>
    <div>Niveau : <span id="stat-level">1</span></div>
    <div>XP : <span id="stat-xp">0</span> / <span id="stat-xp-max">100</span></div>
    <progress id="xp-bar" value="0" max="100"></progress>
    <button id="btn-claim-rewards">üéÅ R√©clamer mes r√©compenses</button>
  </section>

  <section id="packs"></section>
  <section id="collection"></section>

  <section id="diagnostic">
    <h2>Configuration & Diagnostic</h2>
    <button id="btn-test-auth">Tester Auth (qui suis-je ?)</button>
    <pre id="diag-log"></pre>
  </section>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, OAuthProvider, signInWithPopup, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCKZK4I3li_7wkmd_qiiM44BoqRTZoloeI",
  authDomain: "legends-collection.firebaseapp.com",
  projectId: "legends-collection",
  storageBucket: "legends-collection.firebasestorage.app",
  messagingSenderId: "133783086150",
  appId: "1:133783086150:web:762f209f7f778ef83a1647"
};

console.log("[DEBUG] Initialisation Firebase...");
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
await setPersistence(auth, browserLocalPersistence);

let currentUser = null;
let playerDocRef = null;
let stats = { packsOpened: 0 };
let collection = {};
// Profil local (XP/Niveau)
const LS_KEY = 'grimoire.alpha.collection.v3';
const LS_STATS = 'grimoire.alpha.stats.v3';
const LS_PROFILE = 'grimoire.alpha.profile.v3';
let profile = loadProfile();
function loadCollection(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||{}; }catch{ return {}; } }
function saveCollection(){ localStorage.setItem(LS_KEY, JSON.stringify(collection)); }
function loadStats(){ try{ return JSON.parse(localStorage.getItem(LS_STATS))||{packsOpened:0}; }catch{ return {packsOpened:0}; } }
function saveStats(){ localStorage.setItem(LS_STATS, JSON.stringify(stats)); }
function loadProfile(){ try{ return JSON.parse(localStorage.getItem(LS_PROFILE))||{level:1,xp:0}; }catch{ return {level:1,xp:0}; } }
function saveProfile(){ localStorage.setItem(LS_PROFILE, JSON.stringify(profile)); }
let xp = 0;
let level = 1;
let rewardsInbox = [];

const twitchProvider = new OAuthProvider('oidc.twitch');
twitchProvider.addScope('openid');
twitchProvider.addScope('user:read:email');
$1

// Jeu ‚Äî constantes et pools
const RARITY = { COMMON:'commune', UNCOMMON:'peu commune', RARE:'rare', LEGENDARY:'l√©gendaire', EXOTIC:'exotique' };
const CARD_POOLS = [
  { id:'NL-001', name:'√âclaireur des D√©buts', set:'Nouvelle Lumi√®re', rarity: RARITY.COMMON },
  { id:'NL-002', name:'Carabine du Patrouilleur', set:'Nouvelle Lumi√®re', rarity: RARITY.COMMON },
  { id:'NL-010', name:'Gantelet du Prospecteur', set:'Nouvelle Lumi√®re', rarity: RARITY.UNCOMMON },
  { id:'NL-020', name:'Spectre de la Tour', set:'Nouvelle Lumi√®re', rarity: RARITY.RARE },
  { id:'NL-090', name:'Osiris ‚Äî Vision du Disciplin√©', set:'Nouvelle Lumi√®re', rarity: RARITY.LEGENDARY },
  { id:'NL-100', name:'Jormungandr ‚Äî L√©gende Perdue', set:'Nouvelle Lumi√®re', rarity: RARITY.EXOTIC },
];
const RARITY_WEIGHTS = { [RARITY.COMMON]:60, [RARITY.UNCOMMON]:25, [RARITY.RARE]:10, [RARITY.LEGENDARY]:4, [RARITY.EXOTIC]:1 };
const rarityOrder = [RARITY.COMMON, RARITY.UNCOMMON, RARITY.RARE, RARITY.LEGENDARY, RARITY.EXOTIC];
const XP_PER_PACK = 5; const LEVEL_XP_BASE = 100; function xpForLevel(){ return LEVEL_XP_BASE; }
function nextRewardForLevel(level){ if(level===1) return {type:'pack_standard', label:'Pack Standard'}; if([2,5,10,15,20].includes(level)) return {type:'pack_premium', label:'Pack Premium'}; return {type:'pack_standard', label:'Pack Standard'}; }

document.getElementById('btn-login').addEventListener('click', async ()=>{
  console.log("[DEBUG] Bouton login cliqu√© (popup)");
  try {
    const res = await signInWithPopup(auth, twitchProvider);
    console.log("[DEBUG] Popup OK, user:", res.user);
  } catch (e) {
    console.error("[DEBUG] Erreur popup:", e);
    alert("Erreur connexion Twitch: " + e.message);
  }
});

document.getElementById('btn-logout').addEventListener('click', ()=>{
  console.log("[DEBUG] D√©connexion en cours...");
  signOut(auth);
});

document.getElementById('btn-test-auth').addEventListener('click', ()=>{
  const diag = document.getElementById('diag-log');
  diag.textContent = '';
  if(currentUser){
    diag.textContent += 'Connect√© ‚úÖ\n';
    diag.textContent += 'UID: ' + currentUser.uid + '\n';
    diag.textContent += 'displayName: ' + (currentUser.displayName||'(‚Äî)') + '\n';
    diag.textContent += 'email: ' + (currentUser.email||'(‚Äî)') + '\n';
  } else {
    diag.textContent += 'Non connect√© ‚ùå\n';
  }
});

document.getElementById('btn-claim-rewards').addEventListener('click', async ()=>{
  if(!currentUser) return alert("Connecte-toi d'abord");
  if(!rewardsInbox.length) return alert("Pas de r√©compenses √† r√©clamer");
  alert("R√©compenses r√©clam√©es: " + JSON.stringify(rewardsInbox));
  rewardsInbox = [];
  await updateDoc(playerDocRef, { rewardsInbox: [] });
});

onAuthStateChanged(auth, async (user)=>{
  console.log("[DEBUG] onAuthStateChanged", user);
  currentUser = user;
  if(user){
    await loadOrCreatePlayerDoc(user);
    renderStats();
    renderCollection();
  }
});

// Tirages & packs
function weightedRandomRarity(){ const entries=Object.entries(RARITY_WEIGHTS); const total=entries.reduce((s,[,w])=>s+w,0); let r=Math.random()*total; for(const [rarity,weight] of entries){ if(r<weight) return rarity; r-=weight; } return RARITY.COMMON; }
function pickCardByRarity(rarity){ const pool=CARD_POOLS.filter(c=>c.rarity===rarity); if(pool.length===0){ const idx=rarityOrder.indexOf(rarity); for(let j=idx-1;j>=0;j--){ const p=CARD_POOLS.filter(c=>c.rarity===rarityOrder[j]); if(p.length) return p[Math.floor(Math.random()*p.length)]; } return CARD_POOLS[Math.floor(Math.random()*CARD_POOLS.length)]; } return pool[Math.floor(Math.random()*pool.length)]; }
function ensureAtLeastRare(){ const r=Math.random()*(RARITY_WEIGHTS[RARITY.RARE]+RARITY_WEIGHTS[RARITY.LEGENDARY]+RARITY_WEIGHTS[RARITY.EXOTIC]); const thresholds=[[RARITY.RARE,RARITY_WEIGHTS[RARITY.RARE]],[RARITY.LEGENDARY,RARITY_WEIGHTS[RARITY.LEGENDARY]],[RARITY.EXOTIC,RARITY_WEIGHTS[RARITY.EXOTIC]]]; let sum=0; for(const [rar,w] of thresholds){ sum+=w; if(r<sum) return rar; } return RARITY.RARE; }
function addToCollection(cards){ for(const c of cards){ collection[c.id]=(collection[c.id]||0)+1; } saveCollection(); }
async function openPack({type='standard'}={}){
  const cards=[];
  if(type==='premium'){
    const idx=Math.floor(Math.random()*5);
    for(let i=0;i<5;i++){ const rarity=(i===idx)? ensureAtLeastRare(): weightedRandomRarity(); cards.push(pickCardByRarity(rarity)); }
  } else {
    for(let i=0;i<5;i++){ const rarity=weightedRandomRarity(); cards.push(pickCardByRarity(rarity)); }
  }
  stats.packsOpened=(stats.packsOpened||0)+1; saveStats(); addToCollection(cards);
  await gainXpAndMaybeLevelUp(XP_PER_PACK);
  renderStats(); renderCollection();
  if(currentUser && playerDocRef){ await syncPackResultToFirestore(cards,{xpGain:XP_PER_PACK}).catch(console.error); }
}
function renderPacks(){
  const wrap=document.getElementById('packs'); wrap.innerHTML='';
  const packs=[
    { id:'std', name:'üé¥ Standard', desc:'5 cartes al√©atoires', action:()=>openPack({type:'standard'}) },
    { id:'prm', name:'üíé Premium', desc:'5 cartes dont 1 rare minimum', action:()=>openPack({type:'premium'}) }
  ];
  for(const p of packs){ const b=document.createElement('button'); b.className='btn'; b.textContent=p.name+" ‚Äî "+p.desc; b.addEventListener('click', p.action); wrap.appendChild(b); }
}
renderPacks();

document.getElementById('btn-claim-rewards').addEventListener('click', async ()=>{
  if(!currentUser){ alert('Connecte-toi pour r√©clamer tes r√©compenses'); return; }
  try{
    await runTransaction(db, async (trx)=>{
      const snap = await trx.get(playerDocRef);
      if(!snap.exists()) throw new Error('Profil introuvable');
      const data = snap.data();
      const inbox = Array.isArray(data.rewardsInbox)? data.rewardsInbox.slice():[];
      if(inbox.length===0) throw new Error('Aucune r√©compense √† r√©clamer');
      const reward = inbox.shift();
      trx.update(playerDocRef, { rewardsInbox: inbox, updatedAt: serverTimestamp() });
      setTimeout(()=>{ if(reward.type==='pack_standard') openPack({type:'standard'}); else if(reward.type==='pack_premium') openPack({type:'premium'}); else alert('R√©compense: '+(reward.label||reward.type)); }, 100);
    });
  } catch(e){ alert(e.message||String(e)); }
});

async function loadOrCreatePlayerDoc(user){
  console.log("[DEBUG] Chargement doc joueur", user.uid);
  playerDocRef = doc(db, 'players', user.uid);
  const snap = await getDoc(playerDocRef);
  if(!snap.exists()){
    const base = {
      displayName: user.displayName||'',
      photoURL: user.photoURL||'',
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
      stats: { packsOpened: stats.packsOpened||0 },
      collection: collection,
      xp: profile.xp||0,
      level: profile.level||1,
      rewardsInbox: []
    };
    await setDoc(playerDocRef, base);
    console.log("[DEBUG] Nouveau doc joueur cr√©√©");
    return base;
  }
  const data = snap.data();
  // Priorit√© cloud -> remplace local
  collection = { ...(data.collection||{}) }; saveCollection();
  stats.packsOpened = data.stats?.packsOpened||0; saveStats();
  profile.level = data.level||1; profile.xp = data.xp||0; saveProfile();
  return data;
}

async function syncPackResultToFirestore(cards,{xpGain=0}={}){
  await runTransaction(db, async (trx)=>{
    const docSnap = await trx.get(playerDocRef);
    const cur = docSnap.exists()? docSnap.data() : { stats:{packsOpened:0}, collection:{}, level:1, xp:0, rewardsInbox:[] };
    const newStats = { ...cur.stats, packsOpened: (cur.stats?.packsOpened||0) + 1 };
    const newCollection = { ...(cur.collection||{}) };
    for(const c of cards){ newCollection[c.id] = (newCollection[c.id]||0)+1; }
    let level = cur.level||1; let xp = (cur.xp||0) + xpGain; let rewards = cur.rewardsInbox||[]; let need = xpForLevel(level);
    while(xp >= need){ xp -= need; level += 1; need = xpForLevel(level); const rw = nextRewardForLevel(level-1); rewards = [...rewards, { id: 'rw_'+Date.now()+Math.random().toString(36).slice(2), type: rw.type, label: rw.label, t: Date.now() }]; }
    trx.set(playerDocRef, { stats:newStats, collection:newCollection, level, xp, rewardsInbox:rewards, updatedAt: serverTimestamp() }, { merge: true });
  });
}

async function gainXpAndMaybeLevelUp(amount){
  profile.xp = (profile.xp||0) + amount;
  let need = xpForLevel(profile.level||1);
  let leveled = false;
  while(profile.xp >= need){ profile.xp -= need; profile.level = (profile.level||1)+1; need = xpForLevel(profile.level); leveled = true; }
  saveProfile(); renderStats();
  if(leveled && currentUser && playerDocRef){ await updateDoc(playerDocRef, { level: profile.level, xp: profile.xp, updatedAt: serverTimestamp() }).catch(()=>{}); }
}

function renderStats(){
  console.log("[DEBUG] renderStats");
  const uniqueOwned = Object.keys(collection).length;
  const totalUnique = new Set(CARD_POOLS.map(c=>c.id)).size;
  const completion = totalUnique? Math.round((uniqueOwned/totalUnique)*100) : 0;
  document.getElementById('stat-packs').textContent = stats.packsOpened||0;
  document.getElementById('stat-uniques').textContent = uniqueOwned;
  document.getElementById('stat-completion').textContent = completion+"%";
  document.getElementById('stat-rank').textContent = rankFromCompletion(completion);
  const level = profile.level||1; const xp = profile.xp||0; const need = xpForLevel(level);
  document.getElementById('stat-level').textContent = level;
  document.getElementById('stat-xp').textContent = xp;
  const mxEl = document.getElementById('stat-xp-max'); if(mxEl) mxEl.textContent = need;
  const bar = document.getElementById('xp-bar'); if(bar){ bar.max = need; bar.value = Math.min(xp, need); }
}

function renderCollection(){
  console.log("[DEBUG] renderCollection");
  const el = document.getElementById('collection');
  el.innerHTML = '';
  const byRarity = c=> rarityOrder.indexOf(c.rarity);
  const all = CARD_POOLS.slice().sort((a,b)=> byRarity(a)-byRarity(b) || a.id.localeCompare(b.id));
  for(const card of all){
    const qty = collection[card.id]||0;
    const row = document.createElement('div');
    row.className = 'mini-card';
    row.innerHTML = `<strong>${card.name}</strong> ‚Äî ${card.set} (${card.rarity}) ¬∑ x${qty}`;
    el.appendChild(row);
  }
}

function renderPacks(){
  const packs = [
    { id: 'standard', name: 'Pack Standard', desc: '5 cartes al√©atoires' },
    { id: 'premium', name: 'Pack Premium', desc: '5 cartes dont 1 rare minimum' }
  ];
  const container = document.getElementById('packs');
  container.innerHTML = '<h2>Packs</h2>';
  packs.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'pack';
    el.innerHTML = `<strong>${p.name}</strong><br>${p.desc}`;
    el.addEventListener('click', ()=>openPack(p.id));
    container.appendChild(el);
  });
}

async function openPack(packId){
  if(!currentUser) return alert("Connecte-toi d'abord");
  console.log("[DEBUG] Ouverture pack", packId);
  const drawn = drawCards(5);
  drawn.forEach(cardId=>{
    collection[cardId] = (collection[cardId]||0) + 1;
  });
  stats.packsOpened++;
  xp += 10;
  if(xp >= xpForNextLevel(level)){
    xp = 0;
    level++;
    rewardsInbox.push(`R√©compense niveau ${level}`);
    alert(`Niveau ${level} atteint ! R√©compense ajout√©e.`);
  }
  await updateDoc(playerDocRef, {
    collection,
    stats,
    xp,
    level,
    rewardsInbox,
    updatedAt: serverTimestamp()
  });
  renderStats();
  renderCollection();
}

function drawCards(n){
  const results = [];
  for(let i=0;i<n;i++){
    results.push('Carte'+Math.floor(Math.random()*200+1));
  }
  return results;
}

function xpForNextLevel(lv){ return 100 + (lv-1)*50; }
function rankFromCompletion(c){
  if(c>=90) return "Ma√Ætre";
  if(c>=50) return "Gardien";
  return "Recrue";
}
</script>
</body>
</html>
