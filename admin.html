<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grimoire · Admin</title>
  <link rel="stylesheet" href="/rarities.css">
  <link rel="stylesheet" href="/mobile.css">
   <link rel="icon" type="image/png" href="https://i.goopics.net/07jxhq.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.goopics.net/aksxey.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://i.goopics.net/clovpw.png">
<link rel="apple-touch-icon" href="https://i.goopics.net/cb7vh3.png">
  <style>
    :root{
      --bg:#0b0f1a; --panel:#10172a; --panel-2:#0c1222; --text:#e8ecf3; --muted:#9aa6be;
      --accent:#7c5cff; --accent-2:#b86bff; --copper:#d6a17a; --success:#34d399; --warning:#f59e0b; --danger:#ef4444;
      --ring:0 0 0 1px rgba(255,255,255,.06) inset, 0 10px 30px rgba(0,0,0,.35);
      --radius:16px; --radius-lg:24px; --shadow:0 20px 60px rgba(0,0,0,.45); --shadow-sm:0 8px 24px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box; scrollbar-width:thin; scrollbar-color: rgba(124,92,255,.45) rgba(255,255,255,.04)}
    *::-webkit-scrollbar{ height:10px; width:10px }
    *::-webkit-scrollbar-track{ background: rgba(255,255,255,.04) }
    *::-webkit-scrollbar-thumb{ background: linear-gradient(180deg, rgba(124,92,255,.7), rgba(184,107,255,.6)); border-radius:999px; border:2px solid rgba(11,15,26,.6) }
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--text);
      background: radial-gradient(1200px 600px at 10% -10%, rgba(124,92,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 110% 10%, rgba(184,107,255,.16), transparent 60%),
                  radial-gradient(1000px 800px at 50% 120%, rgba(214,161,122,.10), transparent 60%),
                  linear-gradient(180deg,#0b0f1a 0%,#0b0f1a 100%);
      min-height:100svh;
    }
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);
      background:linear-gradient(180deg,rgba(11,15,26,.85),rgba(11,15,26,.55));
      border-bottom:1px solid rgba(255,255,255,.06)
    }
    .container{max-width:1200px;margin:0 auto;padding:22px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:44px;height:44px;border-radius:14px;background:conic-gradient(from 0deg,var(--accent),var(--accent-2),var(--copper),var(--accent));box-shadow:var(--shadow-sm); position:relative}
    .logo::after{content:""; position:absolute; inset:2px; border-radius:12px; background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.2), transparent 40%) }
    .title{font-size:22px;font-weight:800;letter-spacing:.2px}
    .subtitle{font-size:12px;color:var(--muted)}
    .btn{appearance:none;border:1px solid transparent;outline:0;padding:10px 14px;border-radius:14px;font-weight:800;color:#0b0f1a;background:var(--accent);cursor:pointer;box-shadow:var(--shadow-sm);
      transition: transform .08s ease, box-shadow .15s ease, background .2s ease, border-color .2s ease, color .2s ease}
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 12px 28px rgba(124,92,255,.28)}
    .btn:active{ transform: translateY(0) }
    .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.16)}
    .btn.ghost:hover{ border-color: rgba(255,255,255,.28); background: rgba(255,255,255,.06) }
    .btn.danger{ background:var(--danger); color:white }
    .btn.warn{ background:var(--warning); color:#0b0f1a }
    .btn.success{ background:var(--success); color:#0b0f1a }
    .pill{border-radius:999px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:20px}
    @media (max-width: 960px){ .grid{ grid-template-columns: repeat(6, 1fr) } }
    @media (max-width: 640px){ .grid{ grid-template-columns: repeat(4, 1fr) } }
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius-lg);box-shadow:var(--shadow); position:relative; overflow:clip}
    .panel .hd{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid rgba(255,255,255,.06)}
    .panel .hd h3{margin:0; font-size:16px; letter-spacing:.2px}
    .panel .bd{padding:18px 20px}
    .panel::before{content:""; position:absolute; inset:0; border-radius:inherit; padding:1px; background: linear-gradient(140deg, rgba(124,92,255,.35), rgba(184,107,255,.2), rgba(214,161,122,.28)); -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite: xor; mask-composite: exclude; pointer-events:none; }
    .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .card{background:linear-gradient(180deg,#0f1324,#0a0f1e);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px; box-shadow: var(--ring)}
    .k{font-size:12px;color:var(--muted)}
    .v{font-weight:800}
    .row.space{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .section-title{font-weight:900;margin-bottom:8px}
    .input{background:#0e1423;border:1px solid rgba(255,255,255,.12);color:var(--text);border-radius:10px;padding:8px 10px;width:100%}
    .toast{ position: fixed; left: 50%; bottom: 22px; transform: translateX(-50%); background: rgba(18,24,41,.92); color: var(--text); border:1px solid rgba(255,255,255,.12); padding:10px 14px; border-radius:12px; box-shadow: var(--shadow-sm); z-index: 50; opacity:0; transition: opacity .2s ease, transform .2s ease }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px) }
    pre.diag{white-space:pre-wrap;background:#0e1423;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;max-height:260px;overflow:auto;color:#9aa6be;font-family:ui-monospace,Menlo,Consolas,monospace; box-shadow: var(--ring)}
    .btn-group{display:flex;gap:8px;flex-wrap:wrap}
  
  .qty{ width:90px }

    @media (max-width: 640px){
  .container{ padding:12px; }
  .row{ gap:10px; }
  .title{ font-size:18px; }

  .grid{ grid-template-columns: repeat(4, 1fr); gap:12px; }
  .panel .hd{ padding:14px; }
  .panel .bd{ padding:14px; }

  .btn{ padding:12px 16px; font-size:14px; }
  .pill{ padding:4px 10px; font-size:12px; }
  .input{ padding:10px 12px; font-size:14px; }
}
@media (max-width: 960px){
  .grid{ grid-template-columns: repeat(6, 1fr); }
}

  </style>
</head>
<body>
  <header>
    <div class="container row" style="justify-content:space-between">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Grimoire — Administration</div>
          <div class="subtitle">Gestion des joueurs & récompenses</div>
        </div>
      </div>
      <div class="row">
        <a href="/index.html" class="btn ghost pill">← Retour</a>
        <button id="btn-logout" class="btn ghost pill" style="display:none">Se déconnecter</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="gate" class="panel" style="margin-bottom:16px">
      <div class="hd"><h3>Contrôle d'accès</h3></div>
      <div class="bd">
        <div id="gate-msg" class="subtitle">Vérification des droits d'accès…</div>
      </div>
    </div>

    <div class="grid" id="admin-ui" style="display:none">

      <!-- Liste joueurs -->
      <section class="panel" style="grid-column:span 6">
        <div class="hd">
          <h3>Joueurs</h3>
          <div class="row">
            <input id="search" class="input" placeholder="Rechercher (pseudo ou UID)…" style="width:260px">
            <button id="btn-refresh" class="btn pill">Rafraîchir</button>
          </div>
        </div>
        <div class="bd">
          <div id="players" class="list"></div>
        </div>
      </section>

      <!-- Détail joueur -->
      <section class="panel" style="grid-column:span 6">
        <div class="hd"><h3>Détails du joueur</h3></div>
        <div class="bd" id="player-detail">
          <div class="subtitle">Sélectionne un joueur dans la liste.</div>
        </div>
      </section>

      <!-- Diagnostic -->
      <section class="panel" style="grid-column:span 12">
        <div class="hd"><h3>Diagnostic</h3></div>
        <div class="bd"><pre id="diag" class="diag"></pre></div>
      </section>

      <!-- Configuration & Diagnostic (déplacé depuis index) -->
<section class="panel" style="grid-column:span 12">
  <div class="hd">
    <h3>Configuration & Diagnostic</h3>
    <span class="subtitle">Outils d’admin (non visibles côté joueurs)</span>
  </div>
  <div class="bd">
    <div class="footerbar" style="display:flex;gap:10px;flex-wrap:wrap">
      <button id="btn-test-config" class="btn ghost pill">Tester config Firebase</button>
      <button id="btn-test-auth" class="btn ghost pill">Tester Auth (qui suis-je ?)</button>
      <button id="btn-test-draws" class="btn ghost pill">Test tirages (10 000)</button>
      <button id="btn-test-premium" class="btn ghost pill">Test Premium garanti (1 000)</button>
      <button id="btn-test-firestore" class="btn ghost pill">Test Firestore round-trip</button>
      <button id="btn-test-cloud-priority" class="btn ghost pill">Test priorité cloud (lecture)</button>
    </div>
    <pre id="diag-log" class="diag"></pre>
  </div>
</section>


    </div>
  </main>

<button id="btn-top" class="backtotop" type="button" aria-label="Revenir en haut" title="Haut de page">↑</button>

  
  <script type="module">
    // Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, query, orderBy, limit, getDocs, doc, getDoc, updateDoc, serverTimestamp, runTransaction } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyCKZK4I3li_7wkmd_qiiM44BoqRTZoloeI',
      authDomain: 'legends-collection.firebaseapp.com',
      projectId: 'legends-collection',
      storageBucket: 'legends-collection.firebasestorage.app',
      messagingSenderId: '133783086150',
      appId: '1:133783086150:web:762f209f7f778ef83a1647'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app);
    try { await setPersistence(auth, browserLocalPersistence); } catch {}

    // Access control
    const gate = document.getElementById('gate');
    const gateMsg = document.getElementById('gate-msg');
    const adminUI = document.getElementById('admin-ui');
    const logoutBtn = document.getElementById('btn-logout');

    // ⚠️ Remplace par ton UID si tu veux une whitelist locale en plus du rôle Firestore
    const ADMIN_UIDS = ['VVsf3YTzwkh3rfGGE6N8ku1PVnI3'];

    function toast(msg,ms=1800){
      let t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t);
      requestAnimationFrame(()=> t.classList.add('show'));
      setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=> t.remove(),200); }, ms);
    }

    logoutBtn.addEventListener('click', async ()=>{ try{ await signOut(auth); }catch{} });

    onAuthStateChanged(auth, async (user)=>{
      logoutBtn.style.display = user ? '' : 'none';
      if(!user){ gateMsg.innerHTML = 'Non connecté. <a href="/index.html" class="btn pill ghost" style="margin-left:8px">Se connecter</a>'; adminUI.style.display='none'; return; }

      // Vérifie droits admin : via UID OU via champ isAdmin/role sur doc joueur
      let allowByUid = ADMIN_UIDS.includes(user.uid);
      let allowByRole = false;
      try{
        const snap = await getDoc(doc(db,'players',user.uid));
        const data = snap.exists()? snap.data() : null;
        allowByRole = !!(data && (data.isAdmin === true || data.role === 'admin'));
      }catch{}

      if(!(allowByUid || allowByRole)){
        gateMsg.innerHTML = 'Accès refusé. Ton compte ne possède pas les droits Admin.';
        adminUI.style.display='none';
        return;
      }

      // Autorisé
      gate.style.display='none';
      adminUI.style.display='grid';
      loadPlayers();
    });

    // --- UI Logic ---
    const playersWrap = document.getElementById('players');
    const detailWrap  = document.getElementById('player-detail');
    const diag = document.getElementById('diag');
    const search = document.getElementById('search');
    document.getElementById('btn-refresh').addEventListener('click', ()=> loadPlayers());
    search.addEventListener('input', ()=> filterCards());

    let lastPlayers = [];

    async function loadPlayers(){
      playersWrap.innerHTML = '<div class="subtitle">Chargement…</div>';
      try{
        let qRef;
        try { qRef = query(collection(db,'players'), orderBy('updatedAt','desc'), limit(200)); }
        catch { qRef = query(collection(db,'players'), limit(200)); }
        const snap = await getDocs(qRef);
        lastPlayers = snap.docs.map(d=> ({ uid:d.id, ...d.data() }));
        renderPlayers(lastPlayers);
        diag.textContent = 'Joueurs chargés: '+lastPlayers.length;
      }catch(e){ playersWrap.innerHTML='<div class="subtitle">Erreur de chargement</div>'; diag.textContent = 'Erreur loadPlayers: '+(e?.message||e); }
    }

    function renderPlayers(list){
  const term = (search.value||'').toLowerCase();
  const filtered = list.filter(p=>{
    const dn = (p.displayName||'').toLowerCase();
    return !term || dn.includes(term) || (p.uid||'').toLowerCase().includes(term);
  });
  playersWrap.innerHTML = '';
  for(const p of filtered){
    const std = (p.packBalances?.standard)||0;
    const prem = (p.packBalances?.premium)||0;
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `
      <div class="row space">
        <div>
          <div class="section-title">${escapeHtml(p.displayName||'(sans pseudo)')}</div>
          <div class="k">UID: <span class="v">${p.uid}</span></div>
          <div class="k">Packs ouverts: <span class="v">${p.stats?.packsOpened||0}</span></div>
          <div class="k">Niveau: <span class="v">${p.level||1}</span> — XP: <span class="v">${p.xp||0}</span></div>
          <div class="k">Cartes uniques: <span class="v">${Object.keys(p.collection||{}).length}</span></div>
          <div class="k">Solde packs: <span class="v">Standard ×${std} · Premium ×${prem}</span></div>
        </div>
        <div class="btn-group">
          <button class="btn ghost pill" data-act="view">Voir</button>

          <button class="btn warn pill" data-act="add-std">+1 Standard</button>
          <input class="input qty" data-qty="std" type="number" min="1" placeholder="Qté">
          <button class="btn warn pill" data-act="add-std-custom">Ajouter</button>

          <button class="btn success pill" data-act="add-prem">+1 Premium</button>
          <input class="input qty" data-qty="prem" type="number" min="1" placeholder="Qté">
          <button class="btn success pill" data-act="add-prem-custom">Ajouter</button>

          <button class="btn danger pill" data-act="reset">Réinitialiser</button>
        </div>
      </div>`;

    el.querySelector('[data-act="view"]').addEventListener('click', ()=> viewPlayer(p.uid));
    el.querySelector('[data-act="reset"]').addEventListener('click', ()=> resetPlayer(p.uid));

    const getQty = (inp)=>{ const n=parseInt(inp?.value,10); return Number.isFinite(n) && n>0 ? n : 1; };
    const qtyStd = el.querySelector('[data-qty="std"]');
    const qtyPrem = el.querySelector('[data-qty="prem"]');

    el.querySelector('[data-act="add-std"]').addEventListener('click', ()=> grantPack(p.uid,'pack_standard','Pack Standard',1));
    el.querySelector('[data-act="add-std-custom"]').addEventListener('click', ()=> grantPack(p.uid,'pack_standard','Pack Standard', getQty(qtyStd)));

    el.querySelector('[data-act="add-prem"]').addEventListener('click', ()=> grantPack(p.uid,'pack_premium','Pack Premium',1));
    el.querySelector('[data-act="add-prem-custom"]').addEventListener('click', ()=> grantPack(p.uid,'pack_premium','Pack Premium', getQty(qtyPrem)));

    playersWrap.appendChild(el);
  }
}


    async function viewPlayer(uid){
  detailWrap.innerHTML = '<div class="subtitle">Chargement…</div>';
  try{
    const snap = await getDoc(doc(db,'players',uid));
    if(!snap.exists()){ detailWrap.innerHTML = '<div class="subtitle">Profil introuvable.</div>'; return; }
    const p = snap.data();
    const uniques = Object.keys(p.collection||{});
    const inbox = Array.isArray(p.rewardsInbox)? p.rewardsInbox.slice() : [];
    const rewards = inbox.filter(r=>!(r?.type==='pack_standard' || r?.type==='pack_premium' || r?.type==='standard' || r?.type==='premium'));
    const packsInInbox = inbox.filter(r=> (r?.type==='pack_standard' || r?.type==='pack_premium'));
    const std = (p.packBalances?.standard)||0;
    const prem = (p.packBalances?.premium)||0;
    detailWrap.innerHTML = `
      <div class="row space">
        <div>
          <div class="section-title">${escapeHtml(p.displayName||'(sans pseudo)')}</div>
          <div class="k">UID: <span class="v" id="detail-uid">${uid}</span></div>
        </div>
        <div class="btn-group">
          <button class="btn warn pill" id="btn-std">+1 Standard</button>
          <input class="input qty" id="qty-std" type="number" min="1" placeholder="Qté">
          <button class="btn warn pill" id="btn-std-custom">Ajouter</button>

          <button class="btn success pill" id="btn-prem">+1 Premium</button>
          <input class="input qty" id="qty-prem" type="number" min="1" placeholder="Qté">
          <button class="btn success pill" id="btn-prem-custom">Ajouter</button>

          <button class="btn danger pill" id="btn-reset">Réinitialiser</button>
        </div>
      </div>
      <div style="margin-top:10px" class="k">Niveau <span class="v">${p.level||1}</span> — XP <span class="v">${p.xp||0}</span> — Packs ouverts <span class="v">${p.stats?.packsOpened||0}</span></div>
      <div style="margin-top:10px" class="k">Solde packs: <span class="v">Standard ×${std} · Premium ×${prem}</span></div>
      <div style="margin-top:10px" class="k">Cartes uniques: <span class="v">${uniques.length}</span></div>
      ${packsInInbox.length ? `<div style="margin-top:14px" class="row"><button class="btn pill" id="btn-migrate">Convertir les packs du coffre → solde</button><span class="k">(${packsInInbox.length} à convertir)</span></div>` : ''}
      <div style="margin-top:14px" class="section-title">Récompenses en attente</div>
      <div>${rewards.length? rewards.map(r=>`• ${escapeHtml(r.label||r.type)} — <span class="k">${new Date(r.t||Date.now()).toLocaleString()}</span>`).join('<br/>') : '<span class="k">Aucune</span>'}</div>
      <div style="margin-top:14px" class="section-title">Collection (id → quantité)</div>
      <pre class="diag">${uniques.slice(0,200).map(id=>`${id}: ${p.collection[id]}`).join('\n') || '(vide)'}</pre>
    `;
    const getQty = (inp)=>{ const n=parseInt(inp?.value,10); return Number.isFinite(n) && n>0 ? n : 1; };
    document.getElementById('btn-reset').addEventListener('click', ()=> resetPlayer(uid));
    document.getElementById('btn-std').addEventListener('click', ()=> grantPack(uid,'pack_standard','Pack Standard',1));
    document.getElementById('btn-std-custom').addEventListener('click', ()=> grantPack(uid,'pack_standard','Pack Standard', getQty(document.getElementById('qty-std'))));
    document.getElementById('btn-prem').addEventListener('click', ()=> grantPack(uid,'pack_premium','Pack Premium',1));
    document.getElementById('btn-prem-custom').addEventListener('click', ()=> grantPack(uid,'pack_premium','Pack Premium', getQty(document.getElementById('qty-prem'))));
    const mig = document.getElementById('btn-migrate');
    if(mig) mig.addEventListener('click', ()=> migratePacksFromInbox(uid));
  }catch(e){ detailWrap.innerHTML = '<div class="subtitle">Erreur de chargement du profil.</div>'; diag.textContent = 'viewPlayer: '+(e?.message||e); }
}


    async function resetPlayer(uid){
      if(!confirm('Réinitialiser la progression de ce joueur ?')) return;
      try{
        await updateDoc(doc(db,'players',uid),{
          stats:{packsOpened:0},
          collection:{},
          level:1,
          xp:0,
          rewardsInbox:[],
          packBalances:{ standard:0, premium:0 },
          updatedAt: serverTimestamp()
        });
        toast('Progression réinitialisée');
        viewPlayer(uid); // refresh
        loadPlayers();
      }catch(e){ toast('Erreur: '+(e?.message||e)); }
    }

    function normalizePackType(t){
      if(t==='pack_standard' || t==='standard') return 'standard';
      if(t==='pack_premium'  || t==='premium')  return 'premium';
      throw new Error('Type de pack inconnu');
    }

    // ⬇️ MAJ: supporte maintenant une quantité (qty)
    async function grantPack(uid,type,label,qty=1){
      const kind = normalizePackType(type);
      // 1) Essaye via Cloud Function sécurisée (si déployée)
      try{
        const call = httpsCallable(functions,'grantPack');
        await call({ uid, type: kind, qty, reason: 'admin-ui' });
        toast(`${label} ×${qty} ajouté${qty>1?'s':''}`);
      }catch(err){
        // 2) Fallback: incrémente directement packBalances (nécessite règles Firestore adaptées aux admins)
        try{
          await runTransaction(db, async (trx)=>{
            const ref = doc(db,'players',uid);
            const snap = await trx.get(ref);
            if(!snap.exists()) throw new Error('Profil introuvable');
            const data = snap.data()||{};
            const balances = { ...(data.packBalances||{}) };
            balances[kind] = Math.max(0,(balances[kind]||0) + Number(qty||1));
            trx.update(ref, { packBalances: balances, updatedAt: serverTimestamp() });
          });
          toast(`${label} ×${qty} ajouté (fallback)`);
        }catch(e2){ toast('Erreur: '+(e2?.message||e2)); return; }
      }
      // refresh si on regarde ce joueur
      const uidShown = (document.getElementById('detail-uid')||{}).textContent;
      if(uidShown === uid){ viewPlayer(uid); }
      loadPlayers();
    }

    async function migratePacksFromInbox(uid){
      if(!confirm('Convertir tous les packs présents dans le coffre en solde de packs ?')) return;
      try{
        await runTransaction(db, async (trx)=>{
          const ref = doc(db,'players',uid);
          const snap = await trx.get(ref);
          if(!snap.exists()) throw new Error('Profil introuvable');
          const data = snap.data()||{};
          const inbox = Array.isArray(data.rewardsInbox)? data.rewardsInbox.slice() : [];
          let addStd=0, addPrem=0; const rest=[];
          for(const it of inbox){
            if(it?.type==='pack_standard') addStd++;
            else if(it?.type==='pack_premium') addPrem++;
            else rest.push(it);
          }
          const balances = { ...(data.packBalances||{}) };
          if(addStd) balances.standard = Math.max(0,(balances.standard||0)+addStd);
          if(addPrem) balances.premium = Math.max(0,(balances.premium||0)+addPrem);
          trx.update(ref, { rewardsInbox: rest, packBalances: balances, updatedAt: serverTimestamp() });
        });
        toast('Conversion terminée');
        viewPlayer(uid); loadPlayers();
      }catch(e){ toast('Erreur: '+(e?.message||e)); }
    }

    function filterCards(){ renderPlayers(lastPlayers); }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }


    // --- Mini outils pour le panneau "Configuration & Diagnostic"
let currentUser = null; // capture l'utilisateur pour les tests

// alimente currentUser dans ton onAuthStateChanged déjà existant :
const _origAuthCb = onAuthStateChanged; // (pas réellement nécessaire si tu modifies directement le callback existant)
onAuthStateChanged(auth, async (user) => {
  currentUser = user || null;
  // le reste de ta logique d'accès admin reste inchangé
});

// helpers d'affichage
const diagLog = document.getElementById('diag-log');
function printDiag(line){ if(diagLog) diagLog.textContent += (line + '\n'); }
function clearDiag(){ if(diagLog) diagLog.textContent = ''; }

// petite version locale des raretés pour les tests de tirage
const RARITY = { COMMON:'commune', UNCOMMON:'peu commune', RARE:'rare', LEGENDARY:'légendaire', EXOTIC:'exotique' };
const RARITY_WEIGHTS = { [RARITY.COMMON]:60, [RARITY.UNCOMMON]:25, [RARITY.RARE]:10, [RARITY.LEGENDARY]:4, [RARITY.EXOTIC]:1 };
function weightedRandomRarity(){
  const total = Object.values(RARITY_WEIGHTS).reduce((a,b)=>a+b,0);
  let r = Math.random() * total;
  for(const [rar, w] of Object.entries(RARITY_WEIGHTS)){ if((r -= w) < 0) return rar; }
  return RARITY.COMMON;
}
const ensureAtLeastRare = ()=> RARITY.RARE;

// listeners
const btnCfg  = document.getElementById('btn-test-config');
const btnAuth = document.getElementById('btn-test-auth');
const btnDraw = document.getElementById('btn-test-draws');
const btnPrem = document.getElementById('btn-test-premium');
const btnFS   = document.getElementById('btn-test-firestore');
const btnCP   = document.getElementById('btn-test-cloud-priority');

btnCfg?.addEventListener('click', ()=>{
  clearDiag();
  const checks = [
    ['apiKey ok', !!firebaseConfig.apiKey],
    ['authDomain ok', !!firebaseConfig.authDomain],
    ['projectId ok', !!firebaseConfig.projectId],
    ['appId ok', !!firebaseConfig.appId],
  ];
  for(const [name, ok] of checks){ printDiag((ok?'✅':'❌')+' '+name); }
  printDiag('\nConfig OK si toutes les coches sont vertes.');
});

btnAuth?.addEventListener('click', ()=>{
  clearDiag();
  if(currentUser){
    printDiag('Connecté ✅');
    printDiag('uid: '+currentUser.uid);
    printDiag('displayName: '+(currentUser.displayName||'(—)'));
    printDiag('email: '+(currentUser.email||'(—)'));
    printDiag('providerId: '+(currentUser.providerData?.[0]?.providerId||'(—)'));
  } else {
    printDiag('Non connecté ❌');
  }
});

btnDraw?.addEventListener('click', ()=>{
  clearDiag();
  const N = 10000;
  const counts = { [RARITY.COMMON]:0, [RARITY.UNCOMMON]:0, [RARITY.RARE]:0, [RARITY.LEGENDARY]:0, [RARITY.EXOTIC]:0 };
  for(let i=0;i<N;i++){ counts[weightedRandomRarity()]++; }
  const pct=x=>(100*x/N).toFixed(2)+'%';
  printDiag(`Distribution (~60/25/10/4/1) sur ${N} tirages:`);
  for(const r of [RARITY.COMMON,RARITY.UNCOMMON,RARITY.RARE,RARITY.LEGENDARY,RARITY.EXOTIC]){
    printDiag(String(r).padEnd(12,' ')+': '+String(counts[r]).padStart(5,' ')+'  ('+pct(counts[r])+')');
  }
});

btnPrem?.addEventListener('click', ()=>{
  clearDiag();
  const P=1000; let ok=0,fail=0;
  for(let p=0;p<P;p++){
    const idx=Math.floor(Math.random()*5);
    const pulls = Array.from({length:5}, (_,i)=> i===idx ? ensureAtLeastRare() : weightedRandomRarity());
    if(pulls.some(r=> r===RARITY.RARE || r===RARITY.LEGENDARY || r===RARITY.EXOTIC)) ok++; else fail++;
  }
  printDiag(`Test Premium garanti sur ${P} packs -> OK: ${ok}  FAIL: ${fail}`);
  printDiag(fail===0 ? '✅ Tous les packs Premium contiennent ≥ 1 Rare.' : '❌ Au moins un pack Premium n’a pas respecté la garantie.');
});

btnFS?.addEventListener('click', async ()=>{
  clearDiag();
  if(!currentUser){ printDiag('⚠️ Connecte-toi avec Twitch pour tester Firestore.'); return; }
  try{
    const now=Date.now();
    await updateDoc(doc(db,'players',currentUser.uid), { _rtTest: now, updatedAt: serverTimestamp() });
    const back = await getDoc(doc(db,'players',currentUser.uid));
    printDiag('Firestore round-trip OK, _rtTest=' + back.data()._rtTest);
  }catch(e){
    printDiag('❌ Firestore round-trip échoué: '+(e?.message||e));
  }
});

btnCP?.addEventListener('click', async ()=>{
  clearDiag();
  if(!currentUser){ printDiag('⚠️ Connecte-toi avec Twitch pour tester la lecture cloud.'); return; }
  try{
    const snap = await getDoc(doc(db,'players',currentUser.uid));
    if(!snap.exists()){ printDiag('ℹ️ Aucun doc cloud.'); return; }
    printDiag('✅ Lecture cloud réussie (doc présent).');
  }catch(e){
    printDiag('❌ Erreur lecture cloud: '+(e?.message||e));
  }
});

  </script>
</body>
</html>
