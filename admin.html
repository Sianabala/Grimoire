<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grimoire ¬∑ Admin</title>
  <link rel="stylesheet" href="/rarities.css">
  <link rel="stylesheet" href="/mobile.css">
  <link rel="icon" type="image/png" href="https://i.goopics.net/07jxhq.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.goopics.net/aksxey.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://i.goopics.net/clovpw.png">
  <link rel="apple-touch-icon" href="https://i.goopics.net/cb7vh3.png">
  <style>
    :root{
      --bg:#0b0f1a; --panel:#10172a; --panel-2:#0c1222; --text:#e8ecf3; --muted:#9aa6be;
      --accent:#7c5cff; --accent-2:#b86bff; --copper:#d6a17a; --success:#34d399; --warning:#f59e0b; --danger:#ef4444;
      --ring:0 0 0 1px rgba(255,255,255,.06) inset, 0 10px 30px rgba(0,0,0,.35);
      --radius:16px; --radius-lg:24px; --shadow:0 20px 60px rgba(0,0,0,.45); --shadow-sm:0 8px 24px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box; scrollbar-width:thin; scrollbar-color: rgba(124,92,255,.45) rgba(255,255,255,.04)}
    *::-webkit-scrollbar{ height:10px; width:10px }
    *::-webkit-scrollbar-track{ background: rgba(255,255,255,.04) }
    *::-webkit-scrollbar-thumb{ background: linear-gradient(180deg, rgba(124,92,255,.7), rgba(184,107,255,.6)); border-radius:999px; border:2px solid rgba(11,15,26,.6) }
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--text);
      background: radial-gradient(1200px 600px at 10% -10%, rgba(124,92,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 110% 10%, rgba(184,107,255,.16), transparent 60%),
                  radial-gradient(1000px 800px at 50% 120%, rgba(214,161,122,.10), transparent 60%),
                  linear-gradient(180deg,#0b0f1a 0%,#0b0f1a 100%);
      min-height:100svh;
    }
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);
      background:linear-gradient(180deg,rgba(11,15,26,.85),rgba(11,15,26,.55));
      border-bottom:1px solid rgba(255,255,255,.06)
    }
    .container{max-width:1200px;margin:0 auto;padding:22px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:44px;height:44px;border-radius:14px;background:conic-gradient(from 0deg,var(--accent),var(--accent-2),var(--copper),var(--accent));box-shadow:var(--shadow-sm); position:relative}
    .logo::after{content:""; position:absolute; inset:2px; border-radius:12px; background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.2), transparent 40%) }
    .title{font-size:22px;font-weight:800;letter-spacing:.2px}
    .subtitle{font-size:12px;color:var(--muted)}
    .btn{appearance:none;border:1px solid transparent;outline:0;padding:10px 14px;border-radius:14px;font-weight:800;color:#0b0f1a;background:var(--accent);cursor:pointer;box-shadow:var(--shadow-sm);
      transition: transform .08s ease, box-shadow .15s ease, background .2s ease, border-color .2s ease, color .2s ease}
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 12px 28px rgba(124,92,255,.28)}
    .btn:active{ transform: translateY(0) }
    .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.16)}
    .btn.ghost:hover{ border-color: rgba(255,255,255,.28); background: rgba(255,255,255,.06) }
    .btn.danger{ background:var(--danger); color:white }
    .btn.warn{ background:var(--warning); color:#0b0f1a }
    .btn.success{ background:var(--success); color:#0b0f1a }
    .pill{border-radius:999px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:20px}
    @media (max-width: 960px){ .grid{ grid-template-columns: repeat(6, 1fr) } }
    @media (max-width: 640px){ .grid{ grid-template-columns: repeat(4, 1fr) } }
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius-lg);box-shadow:var(--shadow); position:relative; overflow:clip}
    .panel .hd{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid rgba(255,255,255,.06)}
    .panel .hd h3{margin:0; font-size:16px; letter-spacing:.2px}
    .panel .bd{padding:18px 20px}
    .panel::before{content:""; position:absolute; inset:0; border-radius:inherit; padding:1px; background: linear-gradient(140deg, rgba(124,92,255,.35), rgba(184,107,255,.2), rgba(214,161,122,.28)); -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite: xor; mask-composite: exclude; pointer-events:none; }
    .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .card{background:linear-gradient(180deg,#0f1324,#0a0f1e);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px; box-shadow: var(--ring)}
    .k{font-size:12px;color:var(--muted)}
    .v{font-weight:800}
    .row.space{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .section-title{font-weight:900;margin-bottom:8px}
    .input{background:#0e1423;border:1px solid rgba(255,255,255,.12);color:var(--text);border-radius:10px;padding:8px 10px;width:100%}
    .toast{ position: fixed; left: 50%; bottom: 22px; transform: translateX(-50%); background: rgba(18,24,41,.92); color: var(--text); border:1px solid rgba(255,255,255,.12); padding:10px 14px; border-radius:12px; box-shadow: var(--shadow-sm); z-index: 50; opacity:0; transition: opacity .2s ease, transform .2s ease }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px) }
    pre.diag{white-space:pre-wrap;background:#0e1423;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;max-height:260px;overflow:auto;color:#9aa6be;font-family:ui-monospace,Menlo,Consolas,monospace; box-shadow: var(--ring)}
    .btn-group{display:flex;gap:8px;flex-wrap:wrap}

    .qty{ width:90px }

    /* ======= NEW: Stats badges ======= */
    .statsbar{ gap:8px; flex-wrap:wrap }
    .stat{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, var(--panel), var(--panel-2));
      box-shadow: var(--shadow-sm);
      font-weight:700; font-size:13px;
      white-space:nowrap;
    }
    .stat b{ font-size:14px; letter-spacing:.2px }
    /* ================================= */

    /* NEW: petit badge d‚Äôinactivit√© dans la liste */
    .inactive-badge{
      display:inline-block; padding:2px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14); font-size:11px; font-weight:700;
      background:rgba(255,255,255,.04); margin-left:6px;
    }
    .inactive-7{ color:#f59e0b }
    .inactive-30{ color:#ef4444 }

    @media (max-width: 640px){
      .container{ padding:12px; }
      .row{ gap:10px; }
      .title{ font-size:18px; }

      .grid{ grid-template-columns: repeat(4, 1fr); gap:12px; }
      .panel .hd{ padding:14px; }
      .panel .bd{ padding:14px; }

      .btn{ padding:12px 16px; font-size:14px; }
      .pill{ padding:4px 10px; font-size:12px; }
      .input{ padding:10px 12px; font-size:14px; }
    }
    @media (max-width: 960px){
      .grid{ grid-template-columns: repeat(6, 1fr); }
    }

    /* Bouton flottant 'Haut de page' */
    .backtotop{
      position: fixed;
      right: clamp(12px, 3vw, 24px);
      bottom: calc(clamp(12px, 3vw, 24px) + env(safe-area-inset-bottom));
      z-index: 800;
      width: 44px; height: 44px;
      display: grid; place-items: center;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      color: var(--text);
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      opacity: 0; pointer-events: none; transform: translateY(8px);
      transition: opacity .2s ease, transform .2s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .backtotop::after{
      content: ""; position: absolute; inset: 0; border-radius: inherit; padding: 1px;
      background: linear-gradient(140deg, rgba(124,92,255,.35), rgba(184,107,255,.2), rgba(214,161,122,.25));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; pointer-events:none;
    }
    .backtotop:hover{ box-shadow: 0 8px 20px rgba(124,92,255,.25); border-color: rgba(255,255,255,.28); }
    .backtotop:active{ transform: translateY(0); }
    .backtotop:focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; }
    .backtotop.show{ opacity: 1; pointer-events: auto; transform: translateY(0); }

    @media (prefers-reduced-motion: reduce){
      .backtotop{ transition: none; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Grimoire ‚Äî Administration</div>
          <div class="subtitle">Gestion des joueurs & r√©compenses</div>
        </div>
      </div>

      <!-- NEW: Global stats shown at the very top -->
      <div id="global-stats" class="row statsbar" aria-live="polite">
        <div class="stat" title="Somme des packs ouverts par tous les joueurs">
          üì¶ Ouverts : <b id="packsOpenedCounter">0</b>
        </div>
        <div class="stat" title="Nombre total de joueurs charg√©s">
          üë• Joueurs : <b id="playersCounter">0</b>
        </div>
      </div>

      <div class="row">
        <a href="/index.html" class="btn ghost pill">‚Üê Retour</a>
        <button id="btn-logout" class="btn ghost pill" style="display:none">Se d√©connecter</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="gate" class="panel" style="margin-bottom:16px">
      <div class="hd"><h3>Contr√¥le d'acc√®s</h3></div>
      <div class="bd">
        <div id="gate-msg" class="subtitle">V√©rification des droits d'acc√®s‚Ä¶</div>
      </div>
    </div>

    <div class="grid" id="admin-ui" style="display:none">
      
      <!-- D√©tail joueur -->
      <section class="panel" style="grid-column:span 6">
        <div class="hd"><h3>D√©tails du joueur</h3></div>
        <div class="bd" id="player-detail">
          <div class="subtitle">S√©lectionne un joueur dans la liste.</div>
        </div>
      </section>

      <!-- Diagnostic -->
      <section class="panel" style="grid-column:span 12">
        <div class="hd"><h3>Diagnostic</h3></div>
        <div class="bd"><pre id="diag" class="diag"></pre></div>
      </section>

      <section class="panel" style="grid-column:span 6">
  <div class="hd">
    <h3>Joueurs</h3>
    <div class="row">
      <input id="search" class="input" placeholder="Rechercher (pseudo ou UID)‚Ä¶" style="width:260px">

      <select id="filter-inactive" class="input pill" style="width:200px">
        <option value="all">Tous</option>
        <option value="7">Inactifs &gt; 7 j</option>
        <option value="30">Inactifs &gt; 30 j</option>
      </select>
      <select id="sort" class="input pill" style="width:220px">
        <option value="activityDesc">Trier : activit√© r√©cente</option>
        <option value="inactivityAsc">Trier : plus inactifs</option>
        <option value="levelDesc">Trier : niveau</option>
        <option value="packsOpenedDesc">Trier : packs ouverts</option>
      </select>

      <button id="btn-refresh" class="btn pill">Rafra√Æchir</button>

      <!-- üî• NOUVEAU : boutons pour offrir √† TOUS les joueurs -->
      <button id="btn-give-all-standard" class="btn warn pill">
        Offrir 1 Standard √† tous
      </button>
      <button id="btn-give-all-premium" class="btn success pill">
        Offrir 1 Premium √† tous
      </button>
      <!-- /NOUVEAU -->
    </div>
  </div>
  <div class="bd">
    <div id="players" class="list"></div>
  </div>
</section>


    </div>
  </main>

  <script type="module">
    // Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, query, orderBy, limit, getDocs, doc, getDoc, updateDoc, serverTimestamp, runTransaction } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyCKZK4I3li_7wkmd_qiiM44BoqRTZoloeI',
      authDomain: 'legends-collection.firebaseapp.com',
      projectId: 'legends-collection',
      storageBucket: 'legends-collection.firebasestorage.app',
      messagingSenderId: '133783086150',
      appId: '1:133783086150:web:762f209f7f778ef83a1647'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app);
    try { await setPersistence(auth, browserLocalPersistence); } catch {}

    // Access control
    const gate = document.getElementById('gate');
    const gateMsg = document.getElementById('gate-msg');
    const adminUI = document.getElementById('admin-ui');
    const logoutBtn = document.getElementById('btn-logout');

    // NEW: Stat elements
    const elPacksOpened = document.getElementById('packsOpenedCounter');
    const elPlayersCnt  = document.getElementById('playersCounter');
    const elPacksDistrib= document.getElementById('packsDistributedCounter'); // peut √™tre null si badge comment√©

    // NEW: helpers
    const nfmt = (n)=> (Number.isFinite(n) ? n.toLocaleString('fr-FR') : '0');

    // NEW: date/time helpers (Europe/Paris + "il y a ‚Ä¶")
    const dtfmt = new Intl.DateTimeFormat('fr-FR',{ timeZone:'Europe/Paris', dateStyle:'medium', timeStyle:'short' });
    function asDate(ts){
      if(!ts) return null;
      try{
        if(typeof ts.toDate === 'function') return ts.toDate();
        if(typeof ts === 'object' && typeof ts.seconds === 'number') return new Date(ts.seconds*1000);
        if(typeof ts === 'number') return new Date(ts);
        if(typeof ts === 'string') { const d = new Date(ts); return isNaN(d)? null : d; }
      }catch{}
      return null;
    }
    function timeAgo(date){
      if(!date) return '‚Äî';
      const diff = Date.now() - date.getTime();
      const sec = Math.max(0, Math.floor(diff/1000));
      const min = Math.floor(sec/60), hr=Math.floor(min/60), day=Math.floor(hr/24);
      if(day>0) return `il y a ${day} j`;
      if(hr>0)  return `il y a ${hr} h`;
      if(min>0) return `il y a ${min} min`;
      return '√† l‚Äôinstant';
    }
    function daysSince(date){
      if(!date) return Infinity;
      const ms = Date.now() - date.getTime();
      return Math.floor(ms/(1000*60*60*24));
    }

    // ‚ö†Ô∏è Remplace par ton UID si tu veux une whitelist locale en plus du r√¥le Firestore
    const ADMIN_UIDS = ['VVsf3YTzwkh3rfGGE6N8ku1PVnI3'];

    function toast(msg,ms=1800){
      let t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t);
      requestAnimationFrame(()=> t.classList.add('show'));
      setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=> t.remove(),200); }, ms);
    }

    logoutBtn.addEventListener('click', async ()=>{ try{ await signOut(auth); }catch{} });

    onAuthStateChanged(auth, async (user)=>{
      logoutBtn.style.display = user ? '' : 'none';
      if(!user){ 
        gateMsg.innerHTML = 'Non connect√©. <a href="/index.html" class="btn pill ghost" style="margin-left:8px">Se connecter</a>'; 
        adminUI.style.display='none'; 
        // reset stats
        if(elPacksOpened) elPacksOpened.textContent='0';
        if(elPlayersCnt)  elPlayersCnt.textContent='0';
        if(elPacksDistrib) elPacksDistrib.textContent='0';
        return; 
      }

      // V√©rifie droits admin : via UID OU via champ isAdmin/role sur doc joueur
      let allowByUid = ADMIN_UIDS.includes(user.uid);
      let allowByRole = false;
      try{
        const snap = await getDoc(doc(db,'players',user.uid));
        const data = snap.exists()? snap.data() : null;
        allowByRole = !!(data && (data.isAdmin === true || data.role === 'admin'));
      }catch{}

      if(!(allowByUid || allowByRole)){
        gateMsg.innerHTML = 'Acc√®s refus√©. Ton compte ne poss√®de pas les droits Admin.';
        adminUI.style.display='none';
        return;
      }

      // Autoris√©
      gate.style.display='none';
      adminUI.style.display='grid';
      loadPlayers();
    });

    // --- UI Logic ---
    const playersWrap = document.getElementById('players');
const detailWrap  = document.getElementById('player-detail');
const diag = document.getElementById('diag');
const search = document.getElementById('search');
document.getElementById('btn-refresh').addEventListener('click', ()=> loadPlayers());

// üî• NOUVEAU : boutons "offrir √† tous"
const btnGiveAllStd  = document.getElementById('btn-give-all-standard');
const btnGiveAllPrem = document.getElementById('btn-give-all-premium');

btnGiveAllStd.addEventListener('click', () => {
  grantPackToAll('pack_standard', 'Pack Standard', 1);
});

btnGiveAllPrem.addEventListener('click', () => {
  grantPackToAll('pack_premium', 'Pack Premium', 1);
});
// /NOUVEAU


    // NEW: sort & filter elements
    const sortSel = document.getElementById('sort');
    const filterInactiveSel = document.getElementById('filter-inactive');
    sortSel.addEventListener('change', ()=> renderPlayers(lastPlayers));
    filterInactiveSel.addEventListener('change', ()=> renderPlayers(lastPlayers));
    search.addEventListener('input', ()=> renderPlayers(lastPlayers));

    let lastPlayers = [];

    async function loadPlayers(){
      playersWrap.innerHTML = '<div class="subtitle">Chargement‚Ä¶</div>';
      try{
        let qRef;
        try { qRef = query(collection(db,'players'), orderBy('updatedAt','desc'), limit(200)); }
        catch { qRef = query(collection(db,'players'), limit(200)); }
        const snap = await getDocs(qRef);
        lastPlayers = snap.docs.map(d=> ({ uid:d.id, ...d.data() }));

        // NEW: update global stats (top of page)
        updateGlobalStats(lastPlayers);

        renderPlayers(lastPlayers);
        diag.textContent = 'Joueurs charg√©s: '+lastPlayers.length;
      }catch(e){ 
        playersWrap.innerHTML='<div class="subtitle">Erreur de chargement</div>'; 
        diag.textContent = 'Erreur loadPlayers: '+(e?.message||e); 
      }
    }

    // NEW: compute & set top counters
    function updateGlobalStats(list){
      const playersCount = Array.isArray(list) ? list.length : 0;
      let totalOpened = 0;
      let totalBalance = 0;

      for (const p of (list||[])){
        totalOpened += (p?.stats?.packsOpened || 0);
        const std = (p?.packBalances?.standard || 0);
        const prem = (p?.packBalances?.premium || 0);
        totalBalance += std + prem;
      }
      const totalDistributed = totalOpened + totalBalance;

      if(elPlayersCnt)   elPlayersCnt.textContent   = nfmt(playersCount);
      if(elPacksOpened)  elPacksOpened.textContent  = nfmt(totalOpened);
      if(elPacksDistrib) elPacksDistrib.textContent = nfmt(totalDistributed);
    }

    function renderPlayers(list){
      // recherche
      const term = (search.value||'').toLowerCase();

      // filtre inactivit√©
      const inactiveMode = filterInactiveSel.value; // 'all' | '7' | '30'

      // pr√©-traitement: map avec dates & jours d'inactivit√©
      let rows = (list||[]).map(p=>{
        const last = asDate(p.lastLogin);
        return {
          ...p,
          _lastDate: last,
          _inactDays: daysSince(last),
          _packsOpened: p?.stats?.packsOpened || 0,
          _level: p?.level || 1
        };
      });

      // filtrage recherche
      rows = rows.filter(p=>{
        const dn = (p.displayName||'').toLowerCase();
        const uid = (p.uid||'').toLowerCase();
        return !term || dn.includes(term) || uid.includes(term);
      });

      // filtrage inactivit√©
      if(inactiveMode !== 'all'){
        const th = parseInt(inactiveMode,10);
        rows = rows.filter(p=> p._inactDays >= th);
      }

      // tri
      const mode = sortSel.value;
      rows.sort((a,b)=>{
        if(mode==='activityDesc'){ // plus r√©cemment connect√©s en premier
          const ta = a._lastDate ? a._lastDate.getTime() : 0;
          const tb = b._lastDate ? b._lastDate.getTime() : 0;
          return tb - ta;
        }
        if(mode==='inactivityAsc'){ // plus inactifs en premier
          return (b._inactDays || 0) - (a._inactDays || 0);
        }
        if(mode==='levelDesc'){
          return (b._level||0) - (a._level||0);
        }
        if(mode==='packsOpenedDesc'){
          return (b._packsOpened||0) - (a._packsOpened||0);
        }
        return 0;
      });

      playersWrap.innerHTML = '';
      for(const p of rows){
        const std = (p.packBalances?.standard)||0;
        const prem = (p.packBalances?.premium)||0;

        // NEW: last login text + badges
        const d = p._lastDate;
        const lastText = d ? `${dtfmt.format(d)} ¬∑ ${timeAgo(d)}` : 'jamais';
        const inact = p._inactDays;
        const badge =
          (inact>=30) ? `<span class="inactive-badge inactive-30">>30 j</span>` :
          (inact>=7)  ? `<span class="inactive-badge inactive-7">>7 j</span>` : '';

        const el = document.createElement('div'); el.className='card';
        el.innerHTML = `
          <div class="row space">
            <div>
              <div class="section-title">${escapeHtml(p.displayName||'(sans pseudo)')} ${badge}</div>
              <div class="k">UID: <span class="v">${p.uid}</span></div>
              <div class="k">Derni√®re connexion: <span class="v">${lastText}</span></div>
              <div class="k">Packs ouverts: <span class="v">${p._packsOpened}</span></div>
              <div class="k">Niveau: <span class="v">${p._level}</span> ‚Äî XP: <span class="v">${p.xp||0}</span></div>
              <div class="k">Cartes uniques: <span class="v">${Object.keys(p.collection||{}).length}</span></div>
              <div class="k">Solde packs: <span class="v">Standard √ó${std} ¬∑ Premium √ó${prem}</span></div>
            </div>
            <div class="btn-group">
              <button class="btn ghost pill" data-act="view">Voir</button>

              <button class="btn warn pill" data-act="add-std">+1 Standard</button>
              <input class="input qty" data-qty="std" type="number" min="1" placeholder="Qt√©">
              <button class="btn warn pill" data-act="add-std-custom">Ajouter</button>

              <button class="btn success pill" data-act="add-prem">+1 Premium</button>
              <input class="input qty" data-qty="prem" type="number" min="1" placeholder="Qt√©">
              <button class="btn success pill" data-act="add-prem-custom">Ajouter</button>

              <button class="btn danger pill" data-act="reset">R√©initialiser</button>
            </div>
          </div>`;

        el.querySelector('[data-act="view"]').addEventListener('click', ()=> viewPlayer(p.uid));
        el.querySelector('[data-act="reset"]').addEventListener('click', ()=> resetPlayer(p.uid));

        const getQty = (inp)=>{ const n=parseInt(inp?.value,10); return Number.isFinite(n) && n>0 ? n : 1; };
        const qtyStd = el.querySelector('[data-qty="std"]');
        const qtyPrem = el.querySelector('[data-qty="prem"]');

        el.querySelector('[data-act="add-std"]').addEventListener('click', ()=> grantPack(p.uid,'pack_standard','Pack Standard',1));
        el.querySelector('[data-act="add-std-custom"]').addEventListener('click', ()=> grantPack(p.uid,'pack_standard','Pack Standard', getQty(qtyStd)));

        el.querySelector('[data-act="add-prem"]').addEventListener('click', ()=> grantPack(p.uid,'pack_premium','Pack Premium',1));
        el.querySelector('[data-act="add-prem-custom"]').addEventListener('click', ()=> grantPack(p.uid,'pack_premium','Pack Premium', getQty(qtyPrem)));

        playersWrap.appendChild(el);
      }
    }

    async function viewPlayer(uid){
      detailWrap.innerHTML = '<div class="subtitle">Chargement‚Ä¶</div>';
      try{
        const snap = await getDoc(doc(db,'players',uid));
        if(!snap.exists()){ detailWrap.innerHTML = '<div class="subtitle">Profil introuvable.</div>'; return; }
        const p = snap.data();
        const uniques = Object.keys(p.collection||{});
        const inbox = Array.isArray(p.rewardsInbox)? p.rewardsInbox.slice() : [];
        const rewards = inbox.filter(r=>!(r?.type==='pack_standard' || r?.type==='pack_premium' || r?.type==='standard' || r?.type==='premium'));
        const packsInInbox = inbox.filter(r=> (r?.type==='pack_standard' || r?.type==='pack_premium'));
        const std = (p.packBalances?.standard)||0;
        const prem = (p.packBalances?.premium)||0;

        // NEW: last login in detail
        const last = asDate(p.lastLogin);
        const lastText = last ? `${dtfmt.format(last)} ¬∑ ${timeAgo(last)}` : 'jamais';

        detailWrap.innerHTML = `
          <div class="row space">
            <div>
              <div class="section-title">${escapeHtml(p.displayName||'(sans pseudo)')}</div>
              <div class="k">UID: <span class="v" id="detail-uid">${uid}</span></div>
              <div class="k">Derni√®re connexion: <span class="v">${lastText}</span></div>
            </div>
            <div class="btn-group">
              <button class="btn warn pill" id="btn-std">+1 Standard</button>
              <input class="input qty" id="qty-std" type="number" min="1" placeholder="Qt√©">
              <button class="btn warn pill" id="btn-std-custom">Ajouter</button>

              <button class="btn success pill" id="btn-prem">+1 Premium</button>
              <input class="input qty" id="qty-prem" type="number" min="1" placeholder="Qt√©">
              <button class="btn success pill" id="btn-prem-custom">Ajouter</button>

              <button class="btn danger pill" id="btn-reset">R√©initialiser</button>
            </div>
          </div>
          <div style="margin-top:10px" class="k">Niveau <span class="v">${p.level||1}</span> ‚Äî XP <span class="v">${p.xp||0}</span> ‚Äî Packs ouverts <span class="v">${p.stats?.packsOpened||0}</span></div>
          <div style="margin-top:10px" class="k">Solde packs: <span class="v">Standard √ó${std} ¬∑ Premium √ó${prem}</span></div>
          <div style="margin-top:10px" class="k">Cartes uniques: <span class="v">${uniques.length}</span></div>
          ${packsInInbox.length ? `<div style="margin-top:14px" class="row"><button class="btn pill" id="btn-migrate">Convertir les packs du coffre ‚Üí solde</button><span class="k">(${packsInInbox.length} √† convertir)</span></div>` : ''}
          <div style="margin-top:14px" class="section-title">R√©compenses en attente</div>
          <div>${rewards.length? rewards.map(r=>`‚Ä¢ ${escapeHtml(r.label||r.type)} ‚Äî <span class="k">${new Date(r.t||Date.now()).toLocaleString('fr-FR')}</span>`).join('<br/>') : '<span class="k">Aucune</span>'}</div>
          <div style="margin-top:14px" class="section-title">Collection (id ‚Üí quantit√©)</div>
          <pre class="diag">${uniques.slice(0,200).map(id=>`${id}: ${p.collection[id]}`).join('\n') || '(vide)'}</pre>
        `;
        const getQty = (inp)=>{ const n=parseInt(inp?.value,10); return Number.isFinite(n) && n>0 ? n : 1; };
        document.getElementById('btn-reset').addEventListener('click', ()=> resetPlayer(uid));
        document.getElementById('btn-std').addEventListener('click', ()=> grantPack(uid,'pack_standard','Pack Standard',1));
        document.getElementById('btn-std-custom').addEventListener('click', ()=> grantPack(uid,'pack_standard','Pack Standard', getQty(document.getElementById('qty-std'))));
        document.getElementById('btn-prem').addEventListener('click', ()=> grantPack(uid,'pack_premium','Pack Premium',1));
        document.getElementById('btn-prem-custom').addEventListener('click', ()=> grantPack(uid,'pack_premium','Pack Premium', getQty(document.getElementById('qty-prem'))));
        const mig = document.getElementById('btn-migrate');
        if(mig) mig.addEventListener('click', ()=> migratePacksFromInbox(uid));
      }catch(e){ detailWrap.innerHTML = '<div class="subtitle">Erreur de chargement du profil.</div>'; diag.textContent = 'viewPlayer: '+(e?.message||e); }
    }

    async function resetPlayer(uid){
      if(!confirm('R√©initialiser la progression de ce joueur ?')) return;
      try{
        await updateDoc(doc(db,'players',uid),{
          stats:{packsOpened:0},
          collection:{},
          level:1,
          xp:0,
          rewardsInbox:[],
          packBalances:{ standard:0, premium:0 },
          updatedAt: serverTimestamp()
        });
        toast('Progression r√©initialis√©e');
        viewPlayer(uid); // refresh
        loadPlayers();   // rafra√Æchit aussi les stats globales
      }catch(e){ toast('Erreur: '+(e?.message||e)); }
    }

    function normalizePackType(t){
      if(t==='pack_standard' || t==='standard') return 'standard';
      if(t==='pack_premium'  || t==='premium')  return 'premium';
      throw new Error('Type de pack inconnu');
    }

    // ‚¨áÔ∏è MAJ: supporte maintenant une quantit√© (qty)
    async function grantPack(uid,type,label,qty=1){
      const kind = normalizePackType(type);
      // 1) Essaye via Cloud Function s√©curis√©e (si d√©ploy√©e)
      try{
        const call = httpsCallable(functions,'grantPack');
        await call({ uid, type: kind, qty, reason: 'admin-ui' });
        toast(`${label} √ó${qty} ajout√©${qty>1?'s':''}`);
      }catch(err){
        // 2) Fallback: incr√©mente directement packBalances (n√©cessite r√®gles Firestore adapt√©es aux admins)
        try{
          await runTransaction(db, async (trx)=>{
            const ref = doc(db,'players',uid);
            const snap = await trx.get(ref);
            if(!snap.exists()) throw new Error('Profil introuvable');
            const data = snap.data()||{};
            const balances = { ...(data.packBalances||{}) };
            balances[kind] = Math.max(0,(balances[kind]||0) + Number(qty||1));
            trx.update(ref, { packBalances: balances, updatedAt: serverTimestamp() });
          });
          toast(`${label} √ó${qty} ajout√© (fallback)`);
        }catch(e2){ toast('Erreur: '+(e2?.message||e2)); return; }
      }
      // refresh si on regarde ce joueur
      const uidShown = (document.getElementById('detail-uid')||{}).textContent;
      if(uidShown === uid){ viewPlayer(uid); }
      loadPlayers(); // met aussi √† jour les compteurs en haut
    }

/* üî• NOUVEAU : offrir un pack √† TOUS les joueurs actuellement charg√©s */
async function grantPackToAll(type, label, qty = 1) {
  const kind = normalizePackType(type);

  if (!lastPlayers || !lastPlayers.length) {
    toast('Aucun joueur charg√©. Clique sur "Rafra√Æchir" d‚Äôabord.');
    return;
  }

  if (!confirm(`Offrir ${label} √ó${qty} √† ${lastPlayers.length} joueur(s) ?`)) {
    return;
  }

  let ok = 0, fail = 0;

  for (const p of lastPlayers) {
    try {
      // 1) Essaye via Cloud Function (si dispo)
      try {
        const call = httpsCallable(functions,'grantPack');
        await call({ uid: p.uid, type: kind, qty, reason: 'admin-bulk' });
      } catch (err) {
        // 2) Fallback transaction Firestore directe
        await runTransaction(db, async (trx)=>{
          const ref = doc(db,'players',p.uid);
          const snap = await trx.get(ref);
          if(!snap.exists()) throw new Error('Profil introuvable');
          const data = snap.data()||{};
          const balances = { ...(data.packBalances||{}) };
          balances[kind] = Math.max(0,(balances[kind]||0) + Number(qty||1));
          trx.update(ref, { packBalances: balances, updatedAt: serverTimestamp() });
        });
      }
      ok++;
    } catch(e) {
      fail++;
      // Optionnel: log dans le diag
      diag.textContent += `grantPackToAll: erreur pour ${p.uid}: ${(e?.message||e)}\n`;
    }
  }

  toast(`${label} √ó${qty} offert √† ${ok} joueur(s).${fail ? ' Erreurs: '+fail : ''}`);
  loadPlayers(); // pour rafra√Æchir les soldes et stats
}


    async function migratePacksFromInbox(uid){
      if(!confirm('Convertir tous les packs pr√©sents dans le coffre en solde de packs ?')) return;
      try{
        await runTransaction(db, async (trx)=>{
          const ref = doc(db,'players',uid);
          const snap = await trx.get(ref);
          if(!snap.exists()) throw new Error('Profil introuvable');
          const data = snap.data()||{};
          const inbox = Array.isArray(data.rewardsInbox)? data.rewardsInbox.slice() : [];
          let addStd=0, addPrem=0; const rest=[];
          for(const it of inbox){
            if(it?.type==='pack_standard') addStd++;
            else if(it?.type==='pack_premium') addPrem++;
            else rest.push(it);
          }
          const balances = { ...(data.packBalances||{}) };
          if(addStd) balances.standard = Math.max(0,(balances.standard||0)+addStd);
          if(addPrem) balances.premium = Math.max(0,(balances.premium||0)+addPrem);
          trx.update(ref, { rewardsInbox: rest, packBalances: balances, updatedAt: serverTimestamp() });
        });
        toast('Conversion termin√©e');
        viewPlayer(uid); loadPlayers();
      }catch(e){ toast('Erreur: '+(e?.message||e)); }
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    // --- Mini outils pour le panneau "Configuration & Diagnostic"
    let currentUser = null; // capture l'utilisateur pour les tests

    onAuthStateChanged(auth, async (user) => {
      currentUser = user || null;
    });

    // helpers d'affichage
    const diagLog = document.getElementById('diag-log');
    function printDiag(line){ if(diagLog) diagLog.textContent += (line + '\n'); }
    function clearDiag(){ if(diagLog) diagLog.textContent = ''; }

    // petite version locale des raret√©s pour les tests de tirage
    const RARITY = { COMMON:'commune', UNCOMMON:'peu commune', RARE:'rare', LEGENDARY:'l√©gendaire', EXOTIC:'exotique' };
    const RARITY_WEIGHTS = { [RARITY.COMMON]:60, [RARITY.UNCOMMON]:25, [RARITY.RARE]:10, [RARITY.LEGENDARY]:4, [RARITY.EXOTIC]:1 };
    function weightedRandomRarity(){
      const total = Object.values(RARITY_WEIGHTS).reduce((a,b)=>a+b,0);
      let r = Math.random() * total;
      for(const [rar, w] of Object.entries(RARITY_WEIGHTS)){ if((r -= w) < 0) return rar; }
      return RARITY.COMMON;
    }
    const ensureAtLeastRare = ()=> RARITY.RARE;

    // listeners
    const btnCfg  = document.getElementById('btn-test-config');
    const btnAuth = document.getElementById('btn-test-auth');
    const btnDraw = document.getElementById('btn-test-draws');
    const btnPrem = document.getElementById('btn-test-premium');
    const btnFS   = document.getElementById('btn-test-firestore');
    const btnCP   = document.getElementById('btn-test-cloud-priority');

    btnCfg?.addEventListener('click', ()=>{
      clearDiag();
      const checks = [
        ['apiKey ok', !!firebaseConfig.apiKey],
        ['authDomain ok', !!firebaseConfig.authDomain],
        ['projectId ok', !!firebaseConfig.projectId],
        ['appId ok', !!firebaseConfig.appId],
      ];
      for(const [name, ok] of checks){ printDiag((ok?'‚úÖ':'‚ùå')+' '+name); }
      printDiag('\nConfig OK si toutes les coches sont vertes.');
    });

    btnAuth?.addEventListener('click', ()=>{
      clearDiag();
      if(currentUser){
        printDiag('Connect√© ‚úÖ');
        printDiag('uid: '+currentUser.uid);
        printDiag('displayName: '+(currentUser.displayName||'(‚Äî)'));
        printDiag('email: '+(currentUser.email||'(‚Äî)'));
        printDiag('providerId: '+(currentUser.providerData?.[0]?.providerId||'(‚Äî)'));
      } else {
        printDiag('Non connect√© ‚ùå');
      }
    });

    btnDraw?.addEventListener('click', ()=>{
      clearDiag();
      const N = 10000;
      const counts = { [RARITY.COMMON]:0, [RARITY.UNCOMMON]:0, [RARITY.RARE]:0, [RARITY.LEGENDARY]:0, [RARITY.EXOTIC]:0 };
      for(let i=0;i<N;i++){ counts[weightedRandomRarity()]++; }
      const pct=x=>(100*x/N).toFixed(2)+'%';
      printDiag(`Distribution (~60/25/10/4/1) sur ${N} tirages:`);
      for(const r of [RARITY.COMMON,RARITY.UNCOMMON,RARITY.RARE,RARITY.LEGENDARY,RARITY.EXOTIC]){
        printDiag(String(r).padEnd(12,' ')+': '+String(counts[r]).padStart(5,' ')+'  ('+pct(counts[r])+')');
      }
    });

    btnPrem?.addEventListener('click', ()=>{
      clearDiag();
      const P=1000; let ok=0,fail=0;
      for(let p=0;p<P;p++){
        const idx=Math.floor(Math.random()*5);
        const pulls = Array.from({length:5}, (_,i)=> i===idx ? ensureAtLeastRare() : weightedRandomRarity());
        if(pulls.some(r=> r===RARITY.RARE || r===RARITY.LEGENDARY || r===RARITY.EXOTIC)) ok++; else fail++;
      }
      printDiag(`Test Premium garanti sur ${P} packs -> OK: ${ok}  FAIL: ${fail}`);
      printDiag(fail===0 ? '‚úÖ Tous les packs Premium contiennent ‚â• 1 Rare.' : '‚ùå Au moins un pack Premium n‚Äôa pas respect√© la garantie.');
    });

    btnFS?.addEventListener('click', async ()=>{
      clearDiag();
      if(!currentUser){ printDiag('‚ö†Ô∏è Connecte-toi avec Twitch pour tester Firestore.'); return; }
      try{
        const now=Date.now();
        await updateDoc(doc(db,'players',currentUser.uid), { _rtTest: now, updatedAt: serverTimestamp() });
        const back = await getDoc(doc(db,'players',currentUser.uid));
        printDiag('Firestore round-trip OK, _rtTest=' + back.data()._rtTest);
      }catch(e){
        printDiag('‚ùå Firestore round-trip √©chou√©: '+(e?.message||e));
      }
    });

    btnCP?.addEventListener('click', async ()=>{
      clearDiag();
      if(!currentUser){ printDiag('‚ö†Ô∏è Connecte-toi avec Twitch pour tester la lecture cloud.'); return; }
      try{
        const snap = await getDoc(doc(db,'players',currentUser.uid));
        if(!snap.exists()){ printDiag('‚ÑπÔ∏è Aucun doc cloud.'); return; }
        printDiag('‚úÖ Lecture cloud r√©ussie (doc pr√©sent).');
      }catch(e){
        printDiag('‚ùå Erreur lecture cloud: '+(e?.message||e));
      }
    });

        // === Bouton 'Haut de page' (admin) ===
    const btnTop = document.getElementById('btn-top');

    if (btnTop) {
      // Afficher/Masquer selon le scroll (seuil = 400px)
      let rafId = null;
      window.addEventListener('scroll', ()=>{
        if (rafId) return;
        rafId = requestAnimationFrame(()=>{
          const shouldShow = window.scrollY > 400;
          btnTop.classList.toggle('show', shouldShow);
          rafId = null;
        });
      });

      // Click = remonter en haut (respecte prefers-reduced-motion)
      btnTop.addEventListener('click', ()=>{
        const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        window.scrollTo({ top: 0, behavior: reduce ? 'auto' : 'smooth' });
      });
    }


  </script>
  <button id="btn-top" class="backtotop" type="button" aria-label="Revenir en haut" title="Haut de page">‚Üë</button>

</body>
</html>
