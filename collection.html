<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grimoire · Ma collection</title>
   <link rel="stylesheet" href="/rarities.css">
 <style>
    :root{ --bg:#0b0f1a; --panel:#121829; --panel-2:#0e1423; --text:#e8ecf3; --muted:#9aa6be; --accent:#7c5cff; --accent-2:#b86bff; --copper:#d6a17a; --success:#34d399; --warning:#f59e0b; --danger:#ef4444; --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.35); --shadow-sm:0 4px 12px rgba(0,0,0,.25); --card-w: 220px; }
    *{box-sizing:border-box; scrollbar-width: thin; scrollbar-color: rgba(124,92,255,.45) rgba(255,255,255,.04); }
    *::-webkit-scrollbar{ height:10px; width:10px; }
    *::-webkit-scrollbar-track{ background: rgba(255,255,255,.04); }
    *::-webkit-scrollbar-thumb{ background: linear-gradient(180deg, rgba(124,92,255,.7), rgba(184,107,255,.6)); border-radius:999px; border:2px solid rgba(11,15,26,.6); }

    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:radial-gradient(1200px 600px at 10% -10%, rgba(124,92,255,.2), transparent 60%),radial-gradient(900px 500px at 110% 10%, rgba(184,107,255,.18), transparent 60%),linear-gradient(180deg,#0b0f1a 0%,#0b0f1a 100%);color:var(--text)}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);background:linear-gradient(180deg,rgba(11,15,26,.9),rgba(11,15,26,.6));border-bottom:1px solid rgba(255,255,255,.06)}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .row{display:flex;gap:20px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 0deg,var(--accent),var(--accent-2),var(--copper),var(--accent));box-shadow:var(--shadow-sm)}
    .title{font-size:20px;font-weight:700}
    .subtitle{font-size:12px;color:var(--muted)}
    nav a{color:var(--text);text-decoration:none;border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:12px}
    nav a:hover{background:rgba(255,255,255,.06)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:20px}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:var(--shadow); position:relative; overflow:clip}
    .panel .hd{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.06)}
    .panel .bd{padding:18px}
    .panel::before{
      content:""; position:absolute; inset:0; border-radius:inherit; padding:1px;
      background: linear-gradient(140deg, rgba(124,92,255,.35), rgba(184,107,255,.2), rgba(214,161,122,.25));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; pointer-events:none;
    }
    .panel:hover{ box-shadow: 0 12px 30px rgba(124,92,255,.10); transform: translateY(-1px); transition: transform .2s ease, box-shadow .2s ease; }

    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px}
    .stat{background: linear-gradient(180deg,#0f172a,#0b1120); border:1px solid rgba(255,255,255,.06); border-radius:14px;padding:12px; box-shadow: inset 0 1px 0 rgba(255,255,255,.04)}
    .stat .v{font-size:24px;font-weight:800; letter-spacing:.2px }
    .stat .k{font-size:12px;color:var(--muted); opacity:.9 }

    .filters{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px}
    .input{background:#0e1423;border:1px solid rgba(255,255,255,.12);color:var(--text);padding:8px 10px;border-radius:10px}
    .select{appearance:none}
    .btn{appearance:none;border:0;outline:0;padding:10px 14px;border-radius:14px;font-weight:700;color:#0b0f1a;background:var(--accent);cursor:pointer;box-shadow:var(--shadow-sm); transition: transform .06s ease, box-shadow .15s ease, background .2s ease, border-color .2s ease, color .2s ease}
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 8px 20px rgba(124,92,255,.25);}
    .btn:active{ transform: translateY(0); box-shadow: var(--shadow-sm); }
    .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.16)}
    .btn.ghost:hover{ border-color: rgba(255,255,255,.28); background: rgba(255,255,255,.06); }

    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .mini-card{background:#0e1423;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;position:relative; transition: transform .18s ease, box-shadow .18s ease, outline-color .2s ease; outline:1px solid rgba(255,255,255,.06)}
    .mini-card:hover{ transform: translateY(-2px); }

    .qty{position:absolute;top:8px;right:8px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.18);padding:2px 8px;border-radius:999px;font-weight:700}
    .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05); position:relative}
    .tag .dot{ display:inline-block;width:8px;height:8px;border-radius:999px;background:currentColor;opacity:.9; }
    .tag.rarity-common{ color:#9aa6be; }
    .tag.rarity-uncommon{ color:#22c55e; }
    .tag.rarity-rare{ color:#3b82f6; }
    .tag.rarity-legendary{ color:#7f11e0; }
    .tag.rarity-exotic{ color:#eab308; }
    .tag:hover{ box-shadow: 0 0 0 3px rgba(124,92,255,.10) inset; }

    .muted{color:var(--muted)}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}

    .footerbar{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
    pre.diag{white-space:pre-wrap;background:#0e1423;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;max-height:240px;overflow:auto;color:#9aa6be;font-family:ui-monospace,Menlo,Consolas,monospace}

/* Vignette d'image de carte */
.thumb{
  width:100%; aspect-ratio:2/3; border-radius:12px; overflow:hidden;
  background:#0e1423; border:1px solid rgba(255,255,255,.08);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
}
.thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
.thumb.is-back img{
  filter: grayscale(.25) brightness(.9) blur(.2px);
}


   
    /* Skeletons */
    .skel{ position:relative; overflow:hidden; background:#0e1423; border-radius:12px; min-height:64px; border:1px solid rgba(255,255,255,.06); }
    .skel::after{
      content:""; position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.07), transparent);
      transform: translateX(-100%); animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer{ 100%{ transform: translateX(100%); } }

    /* Toast */
    .toast{
      position: fixed; left: 50%; bottom: 22px; transform: translateX(-50%);
      background: rgba(18,24,41,.9); color: var(--text); border:1px solid rgba(255,255,255,.12);
      padding:10px 14px; border-radius:12px; box-shadow: var(--shadow-sm); z-index: 50;
      opacity:0; transition: opacity .2s ease, transform .2s ease;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }

    /* Focus accessibilité */
    .btn:focus-visible, a:focus-visible, .input:focus-visible, select:focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; border-radius:8px; }

    /* Motion reduced */
    @media (prefers-reduced-motion: no-preference){
      .tag .dot{ animation: pulse 1.6s ease-in-out infinite; }
      @keyframes pulse{ 0%,100%{ transform:scale(1); opacity:.8 } 50%{ transform:scale(1.15); opacity:1 } }
    }
  </style>
</head>
<body>
  <header>
    <div class="container row" style="justify-content:space-between;align-items:center">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Grimoire</div>
          <div class="subtitle">Ma collection</div>
        </div>
      </div>
      <nav class="row" style="gap:10px">
        <a href="/" aria-label="Retour au jeu">← Retour au jeu</a>
        <a href="/collection.html" aria-current="page">Collection</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="panel" style="grid-column:span 12">
      <div class="hd">
        <h3>Statut & Filtres</h3>
        <span id="sync-badge" class="pill">Local</span>
      </div>
      <div class="bd">
        <div class="stats">
          <div class="stat"><div class="v" id="stat-uniques">0</div><div class="k">Cartes uniques</div></div>
          <div class="stat"><div class="v" id="stat-total">0</div><div class="k">Cartes au total</div></div>
          <div class="stat"><div class="v" id="stat-completion">0%</div><div class="k">% de complétion</div></div>
          <div class="stat"><div class="v" id="stat-by-rarity">—</div><div class="k">Par rareté</div></div>
        </div>

        <div class="filters">
          <input id="q" class="input" placeholder="Rechercher un nom ou ID…" />
          <select id="setFilter" class="input select">
            <option value="">Tous les sets</option>
          </select>
          <label class="pill"><input type="checkbox" id="r-common" checked> Commune</label>
          <label class="pill"><input type="checkbox" id="r-uncommon" checked> Peu commune</label>
          <label class="pill"><input type="checkbox" id="r-rare" checked> Rare</label>
          <label class="pill"><input type="checkbox" id="r-legendary" checked> Légendaire</label>
          <label class="pill"><input type="checkbox" id="r-exotic" checked> Exotique</label>
          <label class="pill"><input type="checkbox" id="only-owned"> Uniquement possédées</label>
          <select id="sortBy" class="input select">
            <option value="set,id">Trier par Set → ID</option>
            <option value="rarity,id">Trier par Rareté → ID</option>
            <option value="name">Trier par Nom</option>
            <option value="qty-desc">Trier par Quantité (desc)</option>
          </select>
          <button id="btn-clear" class="btn ghost">Réinitialiser filtres</button>
        </div>
      </div>
    </section>

    <section class="panel" style="grid-column:span 12">
      <div class="hd" style="align-items:center">
        <h3>Ma collection</h3>
        <small class="muted" id="count">0 éléments</small>
      </div>
      <div class="bd">
        <div id="cards" class="cards"></div>
      </div>
    </section>

    <section class="panel" style="grid-column:span 12">
      <div class="hd"><h3>Diagnostic</h3><span class="subtitle">Aide au débogage</span></div>
      <div class="bd">
        <div class="footerbar">
          <button id="btn-sync-from-cloud" class="btn">🔄 Forcer synchro Cloud → Local</button>
          <button id="btn-export-json" class="btn ghost">Exporter JSON</button>
          <button id="btn-clear-local" class="btn ghost">Effacer local</button>
        </div>
        <pre id="diag-log" class="diag"></pre>
      </div>
    </section>
  </main>

  <script type="module">
    console.log('[DEBUG][collection] script chargé');

    // Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, OAuthProvider, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyCKZK4I3li_7wkmd_qiiM44BoqRTZoloeI',
      authDomain: 'legends-collection.firebaseapp.com',
      projectId: 'legends-collection',
      storageBucket: 'legends-collection.firebasestorage.app',
      messagingSenderId: '133783086150',
      appId: '1:133783086150:web:762f209f7f778ef83a1647'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    try { await setPersistence(auth, browserLocalPersistence); } catch {}

    const twitchProvider = new OAuthProvider('oidc.twitch');
    try { twitchProvider.addScope('openid'); twitchProvider.addScope('user:read:email'); } catch {}

    // Raretés (cohérentes avec index)
    const RARITY = { COMMON:'commune', UNCOMMON:'peu commune', RARE:'rare', LEGENDARY:'légendaire', EXOTIC:'exotique' };
    const rarityOrder = [RARITY.COMMON, RARITY.UNCOMMON, RARITY.RARE, RARITY.LEGENDARY, RARITY.EXOTIC];

// Images des cartes (à adapter à ton projet)
const CARD_IMAGE_BASE = '/images/cards/front/';
const CARD_IMAGE_EXT  = 'webp';  // change en 'png' ou 'jpg' si besoin

function cardFrontUrl(c){
  if (c.image && c.image.startsWith('http')) return c.image;        // URL absolue
  if (c.image && !c.image.startsWith('http')) return c.image;       // chemin relatif fourni
  return `${CARD_IMAGE_BASE}${c.id}.${CARD_IMAGE_EXT}`;             // fallback construit
}

// Verso par défaut (URL directe d'une image)
const CARD_BACK_IMAGE = 'https://i.postimg.cc/3NdjRk2v/VERSO-BLACK.png'; // remplace si tu as ton propre fichier
  
    // Chargement dynamique du set
    let CARD_POOLS = [];
    const FALLBACK_CARDS = [
      { id:'NL-001', name:'Éclaireur des Débuts', set:'Nouvelle Lumière', rarity: RARITY.COMMON, image:'' },
      { id:'NL-002', name:'Carabine du Patrouilleur', set:'Nouvelle Lumière', rarity: RARITY.COMMON, image:'' },
      { id:'NL-010', name:'Gantelet du Prospecteur', set:'Nouvelle Lumière', rarity: RARITY.UNCOMMON, image:'' },
      { id:'NL-020', name:'Spectre de la Tour', set:'Nouvelle Lumière', rarity: RARITY.RARE, image:'' },
      { id:'NL-090', name:'Osiris — Vision du Discipliné', set:'Nouvelle Lumière', rarity: RARITY.LEGENDARY, image:'' },
      { id:'NL-100', name:'Jormungandr — Légende Perdue', set:'Nouvelle Lumière', rarity: RARITY.EXOTIC, image:'' }
    ];
    function mapRarity(r){
      const x=(r||'').toLowerCase();
      if(x==='common'||x==='commune') return RARITY.COMMON;
      if(x==='uncommon'||x==='peu commune') return RARITY.UNCOMMON;
      if(x==='rare') return RARITY.RARE;
      if(x==='legendary'||x==='legendaire'||x==='légendaire') return RARITY.LEGENDARY;
      if(x==='exotic'||x==='exotique') return RARITY.EXOTIC;
      return RARITY.COMMON;
    }
    async function loadCardSet(){
      const url='/data/sets/nouvelle-lumiere.json';
      try{
        console.log('[DEBUG][collection] fetch', url);
        const res=await fetch(url,{cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data=await res.json();
        if(!data?.cards?.length) throw new Error('Fichier JSON sans cartes');
        CARD_POOLS = data.cards.map(c=>({
  id: c.id,
  name: c.name,
  set: c.set || 'Nouvelle Lumière',
  rarity: mapRarity(c.rarity),
  image: c.image || ''            // 👈 on conserve l'URL si fournie
}));

        console.log('[DEBUG][collection] loaded', CARD_POOLS.length, 'cards');
      }catch(e){
        console.warn('[DEBUG][collection] fallback local', e);
        CARD_POOLS = FALLBACK_CARDS.slice();
      }
    }

    // Local storage (mêmes clés que l’index)
    const LS_KEY='grimoire.alpha.collection.v2_5';
    const LS_STATS='grimoire.alpha.stats.v2_5';
    const LS_PROFILE='grimoire.alpha.profile.v2_5';
    let collection = load(LS_KEY, {});
    let stats = load(LS_STATS, {packsOpened:0});
    let profile = load(LS_PROFILE, {level:1,xp:0});
    function load(k,def){ try{ return JSON.parse(localStorage.getItem(k))||def; }catch{ return def; } }
    function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

    // UI refs
    const elCards=document.getElementById('cards');
    const elCount=document.getElementById('count');
    const elUniques=document.getElementById('stat-uniques');
    const elTotal=document.getElementById('stat-total');
    const elCompletion=document.getElementById('stat-completion');
    const elByRarity=document.getElementById('stat-by-rarity');
    const elSync=document.getElementById('sync-badge');

    const q=document.getElementById('q');
    const setFilter=document.getElementById('setFilter');
    const cbCommon=document.getElementById('r-common');
    const cbUncommon=document.getElementById('r-uncommon');
    const cbRare=document.getElementById('r-rare');
    const cbLegendary=document.getElementById('r-legendary');
    const cbExotic=document.getElementById('r-exotic');
    const sortBy=document.getElementById('sortBy');

    const diag=document.getElementById('diag-log');
    function log(line){ diag.textContent += (line + '\n'); }
    function clearLog(){ diag.textContent=''; }

    // Helper toast
    function toast(msg,ms=1800){
      let t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t);
      requestAnimationFrame(()=> t.classList.add('show'));
      setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=> t.remove(),200); }, ms);
    }

    // Skeletons init (remplacés après render)
    elCards.innerHTML = '<div class="skel"></div><div class="skel"></div><div class="skel"></div><div class="skel"></div><div class="skel"></div><div class="skel"></div>';

    // Fill sets from CARD_POOLS (après chargement)
    function fillSets(){
      setFilter.innerHTML='<option value="">Tous les sets</option>';
      const sets=[...new Set(CARD_POOLS.map(c=>c.set))].sort();
      for(const s of sets){ const opt=document.createElement('option'); opt.value=s; opt.textContent=s; setFilter.appendChild(opt); }
    }

    // Auth + synchro Cloud → Local
    onAuthStateChanged(auth, async (user)=>{
      elSync.textContent = user? 'Cloud ✓' : 'Local';
      elSync.style.background = user? 'rgba(52,211,153,.18)' : '';
      if(user){
        try {
          const snap=await getDoc(doc(db,'players',user.uid));
          if(snap.exists()){
            const data=snap.data();
            collection={...(data.collection||{})};
            stats.packsOpened=data.stats?.packsOpened||stats.packsOpened||0;
            profile.level=data.level||profile.level||1;
            profile.xp=data.xp||profile.xp||0;
            save(LS_KEY,collection); save(LS_STATS,stats); save(LS_PROFILE,profile);
            log('[DEBUG] Cloud → local appliqué');
            toast('✅ Synchro Cloud appliquée');
          } else {
            log('[DEBUG] Aucun doc cloud — affichage local');
          }
          render();
        } catch(e){ console.error(e); }
      } else {
        log('[DEBUG] Non connecté — affichage local');
        render();
      }
    });

    // Mapping classes de rareté
    function rarityClass(r){
      switch(r){
        case RARITY.UNCOMMON: return 'rarity-uncommon';
        case RARITY.RARE: return 'rarity-rare';
        case RARITY.LEGENDARY: return 'rarity-legendary';
        case RARITY.EXOTIC: return 'rarity-exotic';
        default: return 'rarity-common';
      }
    }

    // Rendu
    function render(){
      const all = CARD_POOLS.map(c=>({...c, qty:(collection[c.id]||0)}));
      const enabled=new Set([
        cbCommon.checked? RARITY.COMMON:null,
        cbUncommon.checked? RARITY.UNCOMMON:null,
        cbRare.checked? RARITY.RARE:null,
        cbLegendary.checked? RARITY.LEGENDARY:null,
        cbExotic.checked? RARITY.EXOTIC:null
      ].filter(Boolean));
      let list = all.filter(c=> enabled.has(c.rarity));
      if(setFilter.value) list = list.filter(c=> c.set===setFilter.value);
      if(q.value?.trim()){
        const s=q.value.trim().toLowerCase();
        list = list.filter(c=> c.name.toLowerCase().includes(s) || c.id.toLowerCase().includes(s));
      }
      const cbOnlyOwned = document.getElementById('only-owned');
if (cbOnlyOwned?.checked) {
    list = list.filter(c => (collection[c.id]||0) > 0);
}

      switch(sortBy.value){
        case 'rarity,id': list.sort((a,b)=> rarityOrder.indexOf(a.rarity)-rarityOrder.indexOf(b.rarity) || a.id.localeCompare(b.id)); break;
        case 'name': list.sort((a,b)=> a.name.localeCompare(b.name)); break;
        case 'qty-desc': list.sort((a,b)=> (b.qty||0)-(a.qty||0) || a.id.localeCompare(b.id)); break;
        default: list.sort((a,b)=> a.set.localeCompare(b.set) || a.id.localeCompare(b.id));
      }

      // Stats
      const uniques = Object.keys(collection).length;
      const totalUnique = new Set(CARD_POOLS.map(c=>c.id)).size;
      const completion = totalUnique? Math.round(100*uniques/totalUnique):0;
      const totalCards = Object.values(collection).reduce((s,n)=>s+(n||0),0);
      const byR = { [RARITY.COMMON]:0, [RARITY.UNCOMMON]:0, [RARITY.RARE]:0, [RARITY.LEGENDARY]:0, [RARITY.EXOTIC]:0 };
      for(const id in collection){ const card = CARD_POOLS.find(c=>c.id===id); if(card) byR[card.rarity]+=collection[id]; }

      elUniques.textContent = uniques;
      elTotal.textContent = totalCards;
      elCompletion.textContent = completion + '%';
      elByRarity.textContent = `C:${byR[RARITY.COMMON]} · U:${byR[RARITY.UNCOMMON]} · R:${byR[RARITY.RARE]} · L:${byR[RARITY.LEGENDARY]} · E:${byR[RARITY.EXOTIC]}`;

      // Cards
    elCards.innerHTML = ''; 
   for (const c of list) {
  const has = (c.qty || 0) > 0;
  const imgSrc = has ? cardFrontUrl(c) : CARD_BACK_IMAGE;

  const div = document.createElement('div');
  div.className = 'mini-card';
  div.innerHTML = `
    <span class="qty">x${c.qty || 0}</span>

    <div class="thumb ${has ? '' : 'is-back'}" title="${has ? c.name : 'Carte non obtenue'}">
      <img src="${imgSrc}"
           alt="${has ? `Illustration de ${c.name}` : 'Verso — carte non obtenue'}"
           loading="lazy"
           onerror="this.onerror=null; this.src='${CARD_BACK_IMAGE}'">
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin:8px 0 6px">
      <strong>${c.name}</strong>
      <span class="tag ${rarityClass(c.rarity)}"><span class="dot"></span>${c.rarity}</span>
    </div>
    <div class="muted">${c.set} — ${c.id}</div>
  `;
  elCards.appendChild(div);
}

      elCount.textContent = `${list.length} éléments`;
    }

    // Events
   for(const el of [q,setFilter,cbCommon,cbUncommon,cbRare,cbLegendary,cbExotic,sortBy,document.getElementById('only-owned')]){
    el.addEventListener('input', render);
    el.addEventListener('change', render);
}

    document.getElementById('btn-clear').addEventListener('click', ()=>{
      q.value=''; setFilter.value='';
      cbCommon.checked=cbUncommon.checked=cbRare.checked=cbLegendary.checked=cbExotic.checked=true;
      sortBy.value='set,id';
      render();
      toast('Filtres réinitialisés');
    });

    document.getElementById('btn-sync-from-cloud').addEventListener('click', async ()=>{
      if(!auth.currentUser){ alert('Connecte-toi avec Twitch pour synchroniser.'); return; }
      try{
        const snap=await getDoc(doc(db,'players', auth.currentUser.uid));
        if(!snap.exists()) { alert('Aucune collection cloud.'); return; }
        const data=snap.data();
        collection = { ...(data.collection||{}) };
        stats.packsOpened = data.stats?.packsOpened||0; profile.level=data.level||1; profile.xp=data.xp||0;
        save(LS_KEY,collection); save(LS_STATS,stats); save(LS_PROFILE,profile);
        log('[DEBUG] Synchro forcée Cloud → Local : OK');
        render();
        toast('✅ Synchro Cloud → Local réussie');
      }catch(e){ console.error(e); alert('Erreur de synchro: '+(e?.message||e)); }
    });

    document.getElementById('btn-export-json').addEventListener('click', ()=>{
      const payload={ collection, stats, profile, exportedAt:new Date().toISOString() };
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='grimoire-collection.json'; a.click(); URL.revokeObjectURL(url);
      toast('📦 Export JSON prêt');
    });

    document.getElementById('btn-clear-local').addEventListener('click', ()=>{
      if(confirm('Effacer la collection locale ? (Cloud inchangé)')){
        collection={}; save(LS_KEY,collection); render();
        toast('🧹 Local effacé');
      }
    });

    // Init
    await loadCardSet();
    fillSets();
    render();
  </script>
</body>
</html>
