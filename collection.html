<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grimoire · Ma collection</title>
  <link rel="stylesheet" href="/rarities.css">
  <link rel="stylesheet" href="/mobile.css">
   <link rel="icon" type="image/png" href="https://i.goopics.net/07jxhq.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.goopics.net/aksxey.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://i.goopics.net/clovpw.png">
<link rel="apple-touch-icon" href="https://i.goopics.net/cb7vh3.png">
  <style>
    :root{ --bg:#0b0f1a; --panel:#121829; --panel-2:#0e1423; --text:#e8ecf3; --muted:#9aa6be; --accent:#7c5cff; --accent-2:#b86bff; --copper:#d6a17a; --success:#34d399; --warning:#f59e0b; --danger:#ef4444; --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.35); --shadow-sm:0 4px 12px rgba(0,0,0,.25); --card-w: 220px; }
    *{box-sizing:border-box; scrollbar-width: thin; scrollbar-color: rgba(124,92,255,.45) rgba(255,255,255,.04); }
    *::-webkit-scrollbar{ height:10px; width:10px; }
    *::-webkit-scrollbar-track{ background: rgba(255,255,255,.04); }
    *::-webkit-scrollbar-thumb{ background: linear-gradient(180deg, rgba(124,92,255,.7), rgba(184,107,255,.6)); border-radius:999px; border:2px solid rgba(11,15,26,.6); }

    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:radial-gradient(1200px 600px at 10% -10%, rgba(124,92,255,.2), transparent 60%),radial-gradient(900px 500px at 110% 10%, rgba(184,107,255,.18), transparent 60%),linear-gradient(180deg,#0b0f1a 0%,#0b0f1a 100%);color:var(--text)}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);background:linear-gradient(180deg,rgba(11,15,26,.9),rgba(11,15,26,.6));border-bottom:1px solid rgba(255,255,255,.06)}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .row{display:flex;gap:20px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 0deg,var(--accent),var(--accent-2),var(--copper),var(--accent));box-shadow:var(--shadow-sm)}
    .title{font-size:20px;font-weight:700}
    .subtitle{font-size:12px;color:var(--muted)}
    nav a{color:var(--text);text-decoration:none;border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:12px}
    nav a:hover{background:rgba(255,255,255,.06)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:20px}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:var(--shadow); position:relative; overflow:clip}
    .panel .hd{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.06)}
    .panel .bd{padding:18px}
    .panel::before{
      content:""; position:absolute; inset:0; border-radius:inherit; padding:1px;
      background: linear-gradient(140deg, rgba(124,92,255,.35), rgba(184,107,255,.2), rgba(214,161,122,.25));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; pointer-events:none;
    }
    .panel:hover{ box-shadow: 0 12px 30px rgba(124,92,255,.10); transform: translateY(-1px); transition: transform .2s ease, box-shadow .2s ease; }

    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
    .stat{background: linear-gradient(180deg,#0f172a,#0b1120); border:1px solid rgba(255,255,255,.06); border-radius:14px;padding:12px; box-shadow: inset 0 1px 0 rgba(255,255,255,.04)}
    .stat .v{font-size:24px;font-weight:800; letter-spacing:.2px }
    .stat .k{font-size:12px;color:var(--muted); opacity:.9 }

    .filters{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px}
    .input{background:#0e1423;border:1px solid rgba(255,255,255,.12);color:var(--text);padding:8px 10px;border-radius:10px}
    .select{appearance:none}
    .btn{appearance:none;border:0;outline:0;padding:10px 14px;border-radius:14px;font-weight:700;color:#0b0f1a;background:var(--accent);cursor:pointer;box-shadow:var(--shadow-sm); transition: transform .06s ease, box-shadow .15s ease, background .2s ease, border-color .2s ease, color .2s ease}
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 8px 20px rgba(124,92,255,.25);}
    .btn:active{ transform: translateY(0); box-shadow: var(--shadow-sm); }
    .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.16)}
    .btn.ghost:hover{ border-color: rgba(255,255,255,.28); background: rgba(255,255,255,.06); }

.cards{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
  gap:10px;
}
    .mini-card{background:#0e1423;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;position:relative; transition: transform .18s ease, box-shadow .18s ease, outline-color .2s ease; outline:1px solid rgba(255,255,255,.06)}
    .mini-card:hover{ transform: translateY(-2px); }

    .qty{position:absolute;top:8px;right:8px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.18);padding:2px 8px;border-radius:999px;font-weight:700}
    .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05); position:relative}
    .tag .dot{ display:inline-block;width:8px;height:8px;border-radius:999px;background:currentColor;opacity:.9; }
    .tag.rarity-common{ color:#9aa6be; }
    .tag.rarity-uncommon{ color:#22c55e; }
    .tag.rarity-rare{ color:#3b82f6; }
    .tag.rarity-legendary{ color:#7f11e0; }
    .tag.rarity-exotic{ color:#eab308; }
    .tag:hover{ box-shadow: 0 0 0 3px rgba(124,92,255,.10) inset; }

    .muted{color:var(--muted)}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}

       /* Vignette d'image de carte */
    .thumb{
      width:100%; aspect-ratio:2/3; border-radius:12px; overflow:hidden;
      background:#0e1423; border:1px solid rgba(255,255,255,.08);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .thumb.is-back img{
      filter: grayscale(.25) brightness(.9) blur(.2px);
    }

    /* Skeletons */
    .skel{ position:relative; overflow:hidden; background:#0e1423; border-radius:12px; min-height:64px; border:1px solid rgba(255,255,255,.06); }
    .skel::after{
      content:""; position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.07), transparent);
      transform: translateX(-100%); animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer{ 100%{ transform: translateX(100%); } }

    /* Toast */
    .toast{
      position: fixed; left: 50%; bottom: 22px; transform: translateX(-50%);
      background: rgba(18,24,41,.9); color: var(--text); border:1px solid rgba(255,255,255,.12);
      padding:10px 14px; border-radius:12px; box-shadow: var(--shadow-sm); z-index: 50;
      opacity:0; transition: opacity .2s ease, transform .2s ease;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }

    /* Focus accessibilité */
    .btn:focus-visible, a:focus-visible, .input:focus-visible, select:focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; border-radius:8px; }

    /* Motion reduced */
    @media (prefers-reduced-motion: no-preference){
      .tag .dot{ animation: pulse 1.6s ease-in-out infinite; }
      @keyframes pulse{ 0%,100%{ transform:scale(1); opacity:.8 } 50%{ transform:scale(1.15); opacity:1 } }
    }
    .thumb.is-locked {
      position: relative;
    }
    .thumb.is-locked img {
      opacity: 0.35; /* verso plus transparent */
    }
    .thumb.is-locked::after {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.4); /* voile sombre */
      border-radius: inherit;
    }

    /* === Viewer plein écran (zoom carte) === */
    .viewer{
      position: fixed; inset: 0; z-index: 1000;
      display: none; align-items: center; justify-content: center;
      padding: 24px; background: rgba(5,7,12,.66); backdrop-filter: blur(6px);
    }
    .viewer.open{ display: flex; }

    .viewer__panel{
      width: min(90vw, 760px);
      max-height: 90vh;
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      box-shadow: var(--shadow);
      display: grid; grid-template-rows: auto 1fr auto;
      overflow: hidden; position: relative;
    }
    .viewer__hd{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 14px; border-bottom:1px solid rgba(255,255,255,.06);
    }
    .viewer__title{ font-weight: 700; }
    .viewer__meta{ font-size: 12px; color: var(--muted); }

    .viewer__bd{
      position: relative; overflow: hidden;
      display: grid; place-items: center;
      padding: 12px;
    }
    .viewer__img{
      max-width: 100%; max-height: 78vh; height: auto; display: block;
      user-select: none; -webkit-user-drag: none;
      transition: transform .15s ease;
      cursor: zoom-in;
    }
    .viewer__img.zoomed{
      cursor: zoom-out;
      transform: scale(var(--z, 1.8));
      transform-origin: var(--ox, 50%) var(--oy, 50%);
    }

    .viewer__ft{
      display:flex; gap:8px; justify-content:flex-end; align-items:center;
      padding: 10px 12px; border-top:1px solid rgba(255,255,255,.06);
    }

    .viewer__close{
      appearance:none; border:0; cursor:pointer;
      background: transparent; color: var(--text);
      border:1px solid rgba(255,255,255,.16);
      padding:8px 10px; border-radius: 10px;
    }
    .viewer__close:hover{ background: rgba(255,255,255,.06); }

    /* Désactive le scroll en arrière-plan quand viewer ouvert */
    body.noscroll{ overflow: hidden; }


    @media (max-width: 640px){
  .container{ padding:12px; }
  .row{ gap:10px; }
  .title{ font-size:18px; }
  .stat .v{ font-size:20px; }
  nav a{ padding:6px 8px; font-size:14px; }

  .cards{ grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:10px; }
  .mini-card{ padding:8px; }
  .mini-card strong{ font-size:14px; }
  .thumb{ max-width:150px; margin:0 auto; }

  .btn{ padding:12px 16px; font-size:14px; }
  .pill{ padding:4px 10px; font-size:12px; }
  .input{ padding:10px 12px; font-size:14px; }

  /* Ajustement viewer */
  .viewer__panel{ width: min(96vw, 560px); }
}

/* Segmented control pour raretés */
.seg{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.segbtn,.segctl{
  appearance:none; border:1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.05); color: var(--text);
  padding:8px 12px; border-radius:999px; cursor:pointer;
  font-weight:600; transition:.15s ease;
}
.segbtn .dot{display:inline-block;width:8px;height:8px;border-radius:999px;margin-right:8px;opacity:.9}
.segbtn[data-r="commune"] .dot{ background:#9aa6be; }
.segbtn[data-r="peu commune"] .dot{ background:#22c55e; }
.segbtn[data-r="rare"] .dot{ background:#3b82f6; }
.segbtn[data-r="légendaire"] .dot{ background:#7f11e0; }
.segbtn[data-r="exotique"] .dot{ background:#eab308; }

.segbtn.active{
  background: linear-gradient(180deg, rgba(124,92,255,.18), rgba(184,107,255,.14));
  border-color: rgba(124,92,255,.55);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
}
.segbtn:not(.active):hover, .segctl:hover{
  background: rgba(255,255,255,.08);
  border-color: rgba(255,255,255,.26);
}
.segsep{width:1px;height:22px;background:rgba(255,255,255,.12);margin:0 4px;border-radius:1px}

    /* Bouton flottant 'Haut de page' */
.backtotop{
  position: fixed;
  right: clamp(12px, 3vw, 24px);
  bottom: calc(clamp(12px, 3vw, 24px) + env(safe-area-inset-bottom));
  z-index: 800; /* sous le viewer (1000), au-dessus du reste */
  width: 44px; height: 44px;
  display: grid; place-items: center;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.16);
  background: linear-gradient(180deg, var(--panel), var(--panel-2));
  color: var(--text);
  box-shadow: var(--shadow-sm);
  cursor: pointer;
  opacity: 0; pointer-events: none; transform: translateY(8px);
  transition: opacity .2s ease, transform .2s ease, box-shadow .15s ease, border-color .15s ease;
}
.backtotop::after{
  content: ""; position: absolute; inset: 0; border-radius: inherit; padding: 1px;
  background: linear-gradient(140deg, rgba(124,92,255,.35), rgba(184,107,255,.2), rgba(214,161,122,.25));
  -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite: xor; mask-composite: exclude; pointer-events:none;
}
.backtotop:hover{ box-shadow: 0 8px 20px rgba(124,92,255,.25); border-color: rgba(255,255,255,.28); }
.backtotop:active{ transform: translateY(0); }
.backtotop:focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; }
.backtotop.show{ opacity: 1; pointer-events: auto; transform: translateY(0); }

/* Motion réduite : pas de smooth scroll ni d’animation */
@media (prefers-reduced-motion: reduce){
  .backtotop{ transition: none; }
}

    
  </style>
</head>
<body>
  <header>
    <div class="container row" style="justify-content:space-between;align-items:center">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Grimoire</div>
          <div class="subtitle">Ma collection</div>
        </div>
      </div>
      <nav class="row" style="gap:10px">
        <a href="/" aria-label="Retour au jeu">← Retour au jeu</a>
        <a href="/collection.html" aria-current="page">Collection</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="panel" style="grid-column:span 12">
      <div class="hd">
        <h3>Statut & Filtres</h3>
        <span id="sync-badge" class="pill">Local</span>
      </div>
      <div class="bd">
        <div class="stats">
          <div class="stat"><div class="v" id="stat-uniques">0</div><div class="k">Cartes uniques</div></div>
          <div class="stat"><div class="v" id="stat-total">0</div><div class="k">Cartes au total</div></div>
          <div class="stat"><div class="v" id="stat-completion">0%</div><div class="k">% de complétion</div></div>
          <div class="stat"><div class="v" id="stat-by-rarity">—</div><div class="k">Par rareté</div></div>
        </div>

        <div class="filters">
          <input id="q" class="input" placeholder="Rechercher un nom ou ID…" />
          <select id="setFilter" class="input select">
            <option value="">Tous les sets</option>
          </select>
          <div id="rarityFilter" class="seg">
  <button type="button" class="segbtn active" data-r="commune" aria-pressed="true">
    <span class="dot"></span> Commune
  </button>
  <button type="button" class="segbtn active" data-r="peu commune" aria-pressed="true">
    <span class="dot"></span> Peu commune
  </button>
  <button type="button" class="segbtn active" data-r="rare" aria-pressed="true">
    <span class="dot"></span> Rare
  </button>
  <button type="button" class="segbtn active" data-r="légendaire" aria-pressed="true">
    <span class="dot"></span> Légendaire
  </button>
  <button type="button" class="segbtn active" data-r="exotique" aria-pressed="true">
    <span class="dot"></span> Exotique
  </button>

  <span class="segsep" aria-hidden="true"></span>

  <button type="button" id="rarity-all" class="segctl">Tout</button>
  <button type="button" id="rarity-none" class="segctl">Aucun</button>
</div>

          
          <select id="ownedFilter" class="input select" aria-label="Filtrer par possession">
            <option value="">Possées ou non possédées</option>
            <option value="owned">Uniquement possédées</option>
            <option value="missing">Uniquement non possédées</option>
          </select>
          
          <select id="sortBy" class="input select">
            <option value="set,id">Trier par Set → ID</option>
            <option value="rarity,id">Trier par Rareté → ID</option>
            <option value="name">Trier par Nom</option>
            <option value="qty-desc">Trier par Quantité (desc)</option>
          </select>
          <button id="btn-clear" class="btn ghost">Réinitialiser filtres</button>
        </div>
      </div>
    </section>

    <section class="panel" style="grid-column:span 12">
      <div class="hd" style="align-items:center">
        <h3>Ma collection</h3>
        <small class="muted" id="count">0 éléments</small>
      </div>
      <div class="bd">
        <div id="cards" class="cards"></div>
      </div>
    </section>

    </main>

  <!-- Viewer Zoom Carte -->
  <div id="viewer" class="viewer" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="viewer__panel" role="document">
      <div class="viewer__hd">
        <div>
          <div id="viewer-title" class="viewer__title">Titre de la carte</div>
          <div id="viewer-meta" class="viewer__meta">Set — ID — Rareté</div>
        </div>
        <button id="viewer-close" class="viewer__close" aria-label="Fermer">✕</button>
      </div>
      <div class="viewer__bd">
        <img id="viewer-img" class="viewer__img" src="" alt="Carte en grand">
      </div>
      <div class="viewer__ft">
        <button id="viewer-zoom-out" class="btn ghost" type="button">−</button>
        <button id="viewer-zoom-reset" class="btn ghost" type="button">Reset</button>
        <button id="viewer-zoom-in" class="btn ghost" type="button">+</button>
        <button id="viewer-close-2" class="btn" type="button">Fermer</button>
      </div>
    </div>
  </div>

<button id="btn-top" class="backtotop" type="button" aria-label="Revenir en haut" title="Haut de page">↑</button>

  
  <script type="module">
    console.log('[DEBUG][collection] script chargé');

    // Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, OAuthProvider, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyCKZK4I3li_7wkmd_qiiM44BoqRTZoloeI',
      authDomain: 'legends-collection.firebaseapp.com',
      projectId: 'legends-collection',
      storageBucket: 'legends-collection.firebasestorage.app',
      messagingSenderId: '133783086150',
      appId: '1:133783086150:web:762f209f7f778ef83a1647'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    try { await setPersistence(auth, browserLocalPersistence); } catch {}

    const twitchProvider = new OAuthProvider('oidc.twitch');
    try { twitchProvider.addScope('openid'); twitchProvider.addScope('user:read:email'); } catch {}

    // Raretés (cohérentes avec index)
    const RARITY = { COMMON:'commune', UNCOMMON:'peu commune', RARE:'rare', LEGENDARY:'légendaire', EXOTIC:'exotique' };
    const rarityOrder = [RARITY.COMMON, RARITY.UNCOMMON, RARITY.RARE, RARITY.LEGENDARY, RARITY.EXOTIC];

    // Images des cartes
    const CARD_IMAGE_BASE = '/images/cards/front/';
    const CARD_IMAGE_EXT  = 'webp';  // change en 'png' ou 'jpg' si besoin
    function cardFrontUrl(c){
      if (c.image && c.image.startsWith('http')) return c.image;
      if (c.image && !c.image.startsWith('http')) return c.image;
      return `${CARD_IMAGE_BASE}${c.id}.${CARD_IMAGE_EXT}`;
    }
    const CARD_BACK_IMAGE = 'https://i.goopics.net/5vn5ys.png';

    // Chargement dynamique de plusieurs sets
    let CARD_POOLS = [];
    const SET_FILES = [
      '/data/sets/nouvelle-lumiere.json',
      '/data/sets/twitch.json'
    ];

    const FALLBACK_CARDS = [
      { id:'NL-001', name:'Éclaireur des Débuts', set:'Nouvelle Lumière', rarity: RARITY.COMMON, image:'' },
      { id:'NL-002', name:'Carabine du Patrouilleur', set:'Nouvelle Lumière', rarity: RARITY.COMMON, image:'' },
      { id:'NL-010', name:'Gantelet du Prospecteur', set:'Nouvelle Lumière', rarity: RARITY.UNCOMMON, image:'' },
      { id:'NL-020', name:'Spectre de la Tour', set:'Nouvelle Lumière', rarity: RARITY.RARE, image:'' },
      { id:'NL-090', name:'Osiris — Vision du Discipliné', set:'Nouvelle Lumière', rarity: RARITY.LEGENDARY, image:'' },
      { id:'NL-100', name:'Jormungandr — Légende Perdue', set:'Nouvelle Lumière', rarity: RARITY.EXOTIC, image:'' }
    ];
    function mapRarity(r){
      const x=(r||'').toLowerCase();
      if(x==='common'||x==='commune') return RARITY.COMMON;
      if(x==='uncommon'||x==='peu commune') return RARITY.UNCOMMON;
      if(x==='rare') return RARITY.RARE;
      if(x==='legendary'||x==='legendaire'||x==='légendaire') return RARITY.LEGENDARY;
      if(x==='exotic'||x==='exotique') return RARITY.EXOTIC;
      return RARITY.COMMON;
    }
    async function loadCardSets(){
      CARD_POOLS = [];
      const loadedSets = new Set();
      for (const url of SET_FILES) {
        try {
          console.log('[DEBUG][collection] fetch', url);
          const res = await fetch(url, { cache:'no-store' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();

          const setName =
            data?.set
              || data?.name
              || (url.includes('nouvelle-lumiere') ? 'Nouvelle Lumière'
                  : url.includes('twitch') ? 'Twitch'
                  : 'Set inconnu');

          if (!Array.isArray(data?.cards) || !data.cards.length) {
            console.warn('[DEBUG][collection] Fichier sans cartes:', url);
            continue;
          }

          const mapped = data.cards.map(c => ({
            id: c.id,
            name: c.name,
            set: c.set || setName,
            rarity: mapRarity(c.rarity),
            image: c.image || ''
          }));

          CARD_POOLS.push(...mapped);
          loadedSets.add(setName);
          console.log('[DEBUG][collection] loaded', mapped.length, 'cards from', setName);
        } catch(e) {
          console.warn('[DEBUG][collection] erreur chargement', url, e);
          if (url.includes('nouvelle-lumiere') && CARD_POOLS.length === 0) {
            CARD_POOLS.push(...FALLBACK_CARDS);
            loadedSets.add('Nouvelle Lumière');
            console.log('[DEBUG][collection] fallback utilisé pour Nouvelle Lumière');
          }
        }
      }
      if (CARD_POOLS.length === 0) {
        CARD_POOLS = FALLBACK_CARDS.slice();
      }
console.log(`[DEBUG] Sets chargés: ${[...loadedSets].join(', ')} · ${CARD_POOLS.length} cartes`);
    }

    // Local storage
    const LS_KEY='grimoire.alpha.collection.v2_5';
    const LS_STATS='grimoire.alpha.stats.v2_5';
    const LS_PROFILE='grimoire.alpha.profile.v2_5';
    let collection = load(LS_KEY, {});
    let stats = load(LS_STATS, {packsOpened:0});
    let profile = load(LS_PROFILE, {level:1,xp:0});
    function load(k,def){ try{ return JSON.parse(localStorage.getItem(k))||def; }catch{ return def; } }
    function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

    // UI refs
    const elCards=document.getElementById('cards');
    const elCount=document.getElementById('count');
    const elUniques=document.getElementById('stat-uniques');
    const elTotal=document.getElementById('stat-total');
    const elCompletion=document.getElementById('stat-completion');
    const elByRarity=document.getElementById('stat-by-rarity');
    const elSync=document.getElementById('sync-badge');

    const q=document.getElementById('q');
    const setFilter=document.getElementById('setFilter');
  const rarityFilter = document.getElementById('rarityFilter');        // <-- AJOUT
const rarityBtns = [...rarityFilter.querySelectorAll('.segbtn')];    // <-- AJOUT

    const sortBy=document.getElementById('sortBy');
    const ownedFilter=document.getElementById('ownedFilter');

   // Helper toast
    function toast(msg,ms=1800){
      let t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t);
      requestAnimationFrame(()=> t.classList.add('show'));
      setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=> t.remove(),200); }, ms);
    }

    // Skeletons init
    elCards.innerHTML = '<div class="skel"></div><div class="skel"></div><div class="skel"></div><div class="skel"></div><div class="skel"></div><div class="skel"></div>';

    // Fill sets after load
    function fillSets(){
      setFilter.innerHTML='<option value="">Tous les sets</option>';
      const sets=[...new Set(CARD_POOLS.map(c=>c.set))].sort();
      for(const s of sets){ const opt=document.createElement('option'); opt.value=s; opt.textContent=s; setFilter.appendChild(opt); }
    }

    // Auth + synchro Cloud → Local
    onAuthStateChanged(auth, async (user)=>{
      elSync.textContent = user? 'Cloud ✓' : 'Local';
      elSync.style.background = user? 'rgba(52,211,153,.18)' : '';
      if(user){
        try {
          const snap=await getDoc(doc(db,'players',user.uid));
          if(snap.exists()){
            const data=snap.data();
            collection={...(data.collection||{})};
            stats.packsOpened=data.stats?.packsOpened||stats.packsOpened||0;
            profile.level=data.level||profile.level||1;
            profile.xp=data.xp||profile.xp||0;
            save(LS_KEY,collection); save(LS_STATS,stats); save(LS_PROFILE,profile);
            console.log('[DEBUG] Aucun doc cloud — affichage local');
            toast('✅ Synchro Cloud appliquée');
          } else {
            log('[DEBUG] Aucun doc cloud — affichage local');
          }
          render();
        } catch(e){ console.error(e); }
      } else {
        console.log('[DEBUG] Non connecté — affichage local');
        render();
      }
    });

    // Mapping classes de rareté
    function rarityClass(r){
      switch(r){
        case RARITY.UNCOMMON: return 'rarity-uncommon';
        case RARITY.RARE: return 'rarity-rare';
        case RARITY.LEGENDARY: return 'rarity-legendary';
        case RARITY.EXOTIC: return 'rarity-exotic';
        default: return 'rarity-common';
      }
    }

    // Rendu
    function render(){
      const all = CARD_POOLS.map(c=>({...c, qty:(collection[c.id]||0)}));
    // construit l’ensemble des raretés activées depuis les boutons actifs
const enabled = new Set(
  rarityBtns
    .filter(b => b.classList.contains('active'))
    .map(b => b.getAttribute('data-r'))
);

      let list = all.filter(c=> enabled.has(c.rarity));
      if(setFilter.value) list = list.filter(c=> c.set===setFilter.value);
      if(q.value?.trim()){
        const s=q.value.trim().toLowerCase();
        list = list.filter(c=> c.name.toLowerCase().includes(s) || c.id.toLowerCase().includes(s));
      }
      switch (ownedFilter.value) {
  case 'owned':
    list = list.filter(c => (collection[c.id] || 0) > 0);
    break;
  case 'missing':
    list = list.filter(c => (collection[c.id] || 0) === 0);
    break;
  default:
    // Possédées + Non possédées (ne rien faire)
    break;
}


      switch(sortBy.value){
        case 'rarity,id': list.sort((a,b)=> rarityOrder.indexOf(a.rarity)-rarityOrder.indexOf(b.rarity) || a.id.localeCompare(b.id)); break;
        case 'name': list.sort((a,b)=> a.name.localeCompare(b.name)); break;
        case 'qty-desc': list.sort((a,b)=> (b.qty||0)-(a.qty||0) || a.id.localeCompare(b.id)); break;
        default: list.sort((a,b)=> a.set.localeCompare(b.set) || a.id.localeCompare(b.id));
      }

      // Stats
      const uniques = Object.keys(collection).length;
      const totalUnique = new Set(CARD_POOLS.map(c=>c.id)).size;
      const completion = totalUnique? Math.round(100*uniques/totalUnique):0;
      const totalCards = Object.values(collection).reduce((s,n)=>s+(n||0),0);
      const byR = { [RARITY.COMMON]:0, [RARITY.UNCOMMON]:0, [RARITY.RARE]:0, [RARITY.LEGENDARY]:0, [RARITY.EXOTIC]:0 };
      for(const id in collection){ const card = CARD_POOLS.find(c=>c.id===id); if(card) byR[card.rarity]+=collection[id]; }

      elUniques.textContent = uniques;
      elTotal.textContent = totalCards;
      elCompletion.textContent = completion + '%';
      elByRarity.textContent = `C:${byR[RARITY.COMMON]} · U:${byR[RARITY.UNCOMMON]} · R:${byR[RARITY.RARE]} · L:${byR[RARITY.LEGENDARY]} · E:${byR[RARITY.EXOTIC]}`;

      // Cards
      elCards.innerHTML = '';
      for (const c of list) {
        const has = (c.qty || 0) > 0;
        const imgSrc = has ? cardFrontUrl(c) : CARD_BACK_IMAGE;

        const div = document.createElement('div');
        div.className = 'mini-card';
        div.dataset.id = c.id;            // AJOUT
        div.dataset.has = has ? '1' : '0';// AJOUT

        div.innerHTML = `
          <span class="qty">x${c.qty || 0}</span>
          <div class="thumb ${has ? '' : 'is-locked'}" title="${has ? c.name : 'Carte non obtenue'}" data-id="${c.id}">
            <img src="${imgSrc}"
                 alt="${has ? `Illustration de ${c.name}` : 'Verso — carte non obtenue'}"
                 loading="lazy"
                 onerror="this.onerror=null; this.src='${CARD_BACK_IMAGE}'">
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin:8px 0 6px">
            <strong>${c.name}</strong>
            <span class="tag ${rarityClass(c.rarity)}"><span class="dot"></span>${c.rarity}</span>
          </div>
          <div class="muted">${c.set} — ${c.id}</div>
        `;
        elCards.appendChild(div);
      }

      elCount.textContent = `${list.length} éléments`;
    }

    // Events
// === RARETÉS : segmented control ===
// État initial : tout actif (déjà dans l’HTML via .active)
// Toggle d’un bouton de rareté
rarityBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const isActive = btn.classList.toggle('active');
    btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    render();
  });
});

// Boutons Tout / Aucun
document.getElementById('rarity-all').addEventListener('click', ()=>{
  rarityBtns.forEach(b=>{ b.classList.add('active'); b.setAttribute('aria-pressed','true'); });
  render();
});
document.getElementById('rarity-none').addEventListener('click', ()=>{
  rarityBtns.forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
  render();
});

    // === Bouton 'Haut de page' ===
const btnTop = document.getElementById('btn-top');

// Afficher/Masquer selon le scroll (seuil = 400px)
let rafId = null;
window.addEventListener('scroll', ()=>{
  if (rafId) return;
  rafId = requestAnimationFrame(()=>{
    const shouldShow = window.scrollY > 400;
    btnTop.classList.toggle('show', shouldShow);
    rafId = null;
  });
});

// Click = remonter en haut (respecte prefers-reduced-motion)
btnTop.addEventListener('click', ()=>{
  const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  window.scrollTo({ top: 0, behavior: reduce ? 'auto' : 'smooth' });
});

    
 for(const el of [q, setFilter, sortBy, ownedFilter]){
  el.addEventListener('input', render);
  el.addEventListener('change', render);
}



    document.getElementById('btn-clear').addEventListener('click', ()=>{
  q.value='';
  setFilter.value='';
rarityBtns.forEach(b=>{ b.classList.add('active'); b.setAttribute('aria-pressed','true'); });
  sortBy.value='set,id';
  ownedFilter.value=''; // <-- AJOUT
  render();
  toast('Filtres réinitialisés');
});


       // Init
    await loadCardSets();
    fillSets();
    render();

    // === Viewer (zoom carte) ===
    const viewer      = document.getElementById('viewer');
    const viewerImg   = document.getElementById('viewer-img');
    const viewerTitle = document.getElementById('viewer-title');
    const viewerMeta  = document.getElementById('viewer-meta');
    const btnClose    = document.getElementById('viewer-close');
    const btnClose2   = document.getElementById('viewer-close-2');
    const btnZoomIn   = document.getElementById('viewer-zoom-in');
    const btnZoomOut  = document.getElementById('viewer-zoom-out');
    const btnZoomReset= document.getElementById('viewer-zoom-reset');

    let currentZoom = 1; // 1 = fit, >1 = zoom
    const Z_MIN = 1, Z_MAX = 3, Z_STEP = 0.25;

    function openViewer(card){
      viewerTitle.textContent = card.name;
      viewerMeta.textContent  = `${card.set} — ${card.id} — ${card.rarity}`;
      viewerImg.src = cardFrontUrl(card);
      viewerImg.alt = `Carte ${card.name} en grand`;
      currentZoom = 1;
      viewerImg.classList.remove('zoomed');
      viewerImg.style.setProperty('--z', currentZoom);
      viewerImg.style.setProperty('--ox', '50%');
      viewerImg.style.setProperty('--oy', '50%');

      viewer.classList.add('open');
      document.body.classList.add('noscroll');
      viewer.setAttribute('aria-hidden', 'false');
    }

    function closeViewer(){
      viewer.classList.remove('open');
      document.body.classList.remove('noscroll');
      viewer.setAttribute('aria-hidden', 'true');
    }

    function setZoom(z){
      currentZoom = Math.min(Z_MAX, Math.max(Z_MIN, z));
      if (currentZoom === 1){
        viewerImg.classList.remove('zoomed');
      } else {
        viewerImg.classList.add('zoomed');
      }
      viewerImg.style.setProperty('--z', currentZoom);
    }

    // Délégation : clic sur une carte
    elCards.addEventListener('click', (e)=>{
      const thumb = e.target.closest('.thumb');
      if(!thumb) return;
      const id = thumb.getAttribute('data-id');
      const card = CARD_POOLS.find(c => c.id === id);
      const has = (collection[id] || 0) > 0;

      if(!card) return;
      if(!has){
        toast('🔒 Carte non obtenue');
        return;
      }
      openViewer(card);
    });

    // Clic sur fond pour fermer
    viewer.addEventListener('click', (e)=>{
      if(e.target === viewer) closeViewer();
    });

    btnClose.addEventListener('click', closeViewer);
    btnClose2.addEventListener('click', closeViewer);

    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && viewer.classList.contains('open')) closeViewer();
    });

    // Zoom boutons
    btnZoomIn.addEventListener('click', ()=> setZoom(currentZoom + Z_STEP));
    btnZoomOut.addEventListener('click', ()=> setZoom(currentZoom - Z_STEP));
    btnZoomReset.addEventListener('click', ()=> setZoom(1));

    // Zoom à la molette
    viewerImg.addEventListener('wheel', (e)=>{
      e.preventDefault();
      const dir = Math.sign(e.deltaY);
      setZoom(currentZoom + (dir > 0 ? -Z_STEP : Z_STEP));
    }, { passive:false });

    // Zoom au clic + focus au point cliqué
    viewerImg.addEventListener('click', (e)=>{
      const rect = viewerImg.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 100;
      const y = ((e.clientY - rect.top)  / rect.height) * 100;

      if(currentZoom === 1){
        setZoom(1.8);
        viewerImg.style.setProperty('--ox', `${x}%`);
        viewerImg.style.setProperty('--oy', `${y}%`);
      } else {
        setZoom(1);
        viewerImg.style.setProperty('--ox', '50%');
        viewerImg.style.setProperty('--oy', '50%');
      }
    });
  </script>
</body>
</html>
