// ========== SECTION LEADERBOARD CORRIG√âE ==========
// Remplacez tout le code apr√®s "import { collection as fsCollection..." 
// jusqu'√† "attachPrimary();" par ce code :

import { collection as fsCollection, query, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const lbList   = document.getElementById('lb-list');
const lbCount  = document.getElementById('lb-count');
const lbSearch = document.getElementById('lb-search');

let LB_ALL = [];
let unsubLB = null;

function medal(i){ 
  if(i===1) return 'ü•á'; 
  if(i===2) return 'ü•à'; 
  if(i===3) return 'ü•â'; 
  return '#'+i; 
}

function rankClass(i){ 
  return i===1 ? '' : (i===2 ? 'r2' : (i===3 ? 'r3' : '')); 
}

function renderLB(rows){
  if (!lbList) return;
  
  lbList.innerHTML = '';
  if (lbCount) lbCount.textContent = String(rows.length);
  
  for (let i = 0; i < rows.length; i++){
    const u = rows[i];
    const li = document.createElement('li');
    li.className = 'lb-item';
    
    const pct = Math.max(0, Math.min(100, Number(u.completionPct) || 0));
    const pctLabel = (Math.round(pct * 10) / 10).toString().replace('.0', '');
    
    // Avatar par d√©faut si pas de photo
    const avatarUrl = u.photoURL || `https://api.dicebear.com/9.x/shapes/svg?seed=${encodeURIComponent(u.displayName || 'Joueur')}`;
    
    li.innerHTML = `
      <div class="lb-rank ${rankClass(i+1)}">${medal(i+1)}</div>
      <img class="lb-ava" src="${avatarUrl}" alt="${u.displayName || 'Joueur'}" onerror="this.src='https://api.dicebear.com/9.x/shapes/svg?seed=default'">
      <div style="flex:1; min-width:0">
        <div class="lb-name">${u.displayName || 'Joueur'}</div>
        <div class="lb-sub">${u.uniques || 0} / ${u.totalUnique || 0} cartes</div>
        <div class="lb-bar"><div class="lb-fill" style="width:${pct}%;"></div></div>
      </div>
      <div class="lb-pct">${pctLabel}%</div>
    `;
    lbList.appendChild(li);
  }
  
  // Message si vide
  if (rows.length === 0) {
    lbList.innerHTML = '<li style="padding:20px; text-align:center; color:var(--muted)">Aucun joueur trouv√©</li>';
  }
}

function filterLB(){
  const q = (lbSearch?.value || '').trim().toLowerCase();
  if (!q) return renderLB(LB_ALL);
  
  const filtered = LB_ALL.filter(u => {
    const name = (u.displayNameLower || u.displayName || '').toLowerCase();
    return name.includes(q);
  });
  
  renderLB(filtered);
}

// √âcoute la recherche
lbSearch?.addEventListener('input', filterLB);

// ========== STRAT√âGIE DE CHARGEMENT ==========

async function loadLeaderboard() {
  try {
    // Essaie d'abord avec l'index composite (optimal)
    await loadWithCompositeIndex();
  } catch (err) {
    console.warn('[Leaderboard] Index composite non disponible, utilisation du fallback:', err.message);
    
    // Si l'index n'existe pas, charge avec un seul orderBy et trie en m√©moire
    await loadWithFallback();
  }
}

// M√©thode 1: avec index composite (orderBy multiple)
async function loadWithCompositeIndex() {
  const q = query(
    fsCollection(db, 'leaderboard_public'),
    orderBy('completionPct', 'desc'),
    orderBy('uniques', 'desc'),
    orderBy('displayNameLower', 'asc'),
    limit(50)
  );
  
  // Utilise onSnapshot pour le temps r√©el
  if (unsubLB) unsubLB();
  
  unsubLB = onSnapshot(
    q,
    (snapshot) => {
      console.log('[Leaderboard] Donn√©es re√ßues (composite):', snapshot.size, 'joueurs');
      
      const rows = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        rows.push({
          uid: doc.id,
          displayName: data.displayName || 'Joueur',
          displayNameLower: (data.displayNameLower || data.displayName || '').toLowerCase(),
          photoURL: data.photoURL || '',
          uniques: Number(data.uniques) || 0,
          totalUnique: Number(data.totalUnique) || 0,
          completionPct: Number(data.completionPct) || 0
        });
      });
      
      LB_ALL = rows;
      filterLB();
      
      if (lbCount) lbCount.setAttribute('title', 'Classement avec index composite ‚úÖ');
    },
    (error) => {
      // Si erreur d'index manquant, bascule sur fallback
      if (error.code === 'failed-precondition') {
        console.warn('[Leaderboard] Index composite requis, bascule sur fallback');
        loadWithFallback();
      } else {
        console.error('[Leaderboard] Erreur:', error);
        throw error;
      }
    }
  );
}

// M√©thode 2: fallback sans index (un seul orderBy + tri local)
async function loadWithFallback() {
  const q = query(
    fsCollection(db, 'leaderboard_public'),
    orderBy('completionPct', 'desc'),
    limit(100) // Charge plus pour compenser le tri local
  );
  
  if (unsubLB) unsubLB();
  
  unsubLB = onSnapshot(
    q,
    (snapshot) => {
      console.log('[Leaderboard] Donn√©es re√ßues (fallback):', snapshot.size, 'joueurs');
      
      const rows = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        rows.push({
          uid: doc.id,
          displayName: data.displayName || 'Joueur',
          displayNameLower: (data.displayNameLower || data.displayName || '').toLowerCase(),
          photoURL: data.photoURL || '',
          uniques: Number(data.uniques) || 0,
          totalUnique: Number(data.totalUnique) || 0,
          completionPct: Number(data.completionPct) || 0
        });
      });
      
      // Tri manuel c√¥t√© client (pas besoin d'index)
      rows.sort((a, b) => {
        // 1. Par % de compl√©tion (d√©croissant)
        if (b.completionPct !== a.completionPct) {
          return b.completionPct - a.completionPct;
        }
        // 2. Par nombre de cartes uniques (d√©croissant)
        if (b.uniques !== a.uniques) {
          return b.uniques - a.uniques;
        }
        // 3. Par nom alphab√©tique (croissant)
        return a.displayNameLower.localeCompare(b.displayNameLower);
      });
      
      // Garde seulement le top 50
      LB_ALL = rows.slice(0, 50);
      filterLB();
      
      if (lbCount) lbCount.setAttribute('title', 'Classement avec tri local (index en construction) ‚è≥');
    },
    (error) => {
      console.error('[Leaderboard] Erreur fallback:', error);
      // Affiche un message d'erreur √† l'utilisateur
      if (lbList) {
        lbList.innerHTML = '<li style="padding:20px; text-align:center; color:var(--warning)">‚ö†Ô∏è Impossible de charger le classement</li>';
      }
    }
  );
}

// ========== INITIALISATION ==========

// Charge le leaderboard au d√©marrage
loadLeaderboard();

// Nettoie l'abonnement quand l'utilisateur quitte la page
window.addEventListener('beforeunload', () => {
  if (unsubLB) unsubLB();
});
